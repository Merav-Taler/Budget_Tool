<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>×ª×§×¦×™×‘ ××©×¤×—×ª×™ â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›× ×œ××©×¤×—×”</title>
<meta name="description" content="××¤×œ×™×§×¦×™×™×ª ×ª×§×¦×™×‘ ××©×¤×—×ª×™ ×—×™× ××™×ª ×‘×¢×‘×¨×™×ª. ××¢×§×‘ ×”×•×¦××•×ª, ×”×›× ×¡×•×ª, ×—×¡×›×•× ×•×ª, ×“×©×‘×•×¨×“ ×—×›×, ×™×™×‘×•× ×“×¤×™ ×—×©×‘×•×Ÿ ×•×¢×•×“.">
<meta property="og:title" content="×ª×§×¦×™×‘ ××©×¤×—×ª×™ â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×">
<meta property="og:description" content="× ×™×”×•×œ ×ª×§×¦×™×‘ ××©×¤×—×ª×™ ×—×›× ×•×¤×©×•×˜. ××¢×§×‘ ×”×•×¦××•×ª ×•×”×›× ×¡×•×ª, ×—×¡×›×•× ×•×ª, ×“×©×‘×•×¨×“ ×¢× ×’×¨×¤×™×, ×™×™×‘×•× ×“×¤×™ ×—×©×‘×•×Ÿ â€” ×—×™× × ×œ×—×œ×•×˜×™×Ÿ.">
<meta property="og:image" content="og-image.png">
<meta property="og:type" content="website">
<meta property="og:locale" content="he_IL">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="×ª×§×¦×™×‘ ××©×¤×—×ª×™ â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×">
<meta name="twitter:description" content="× ×™×”×•×œ ×ª×§×¦×™×‘ ××©×¤×—×ª×™ ×—×›× ×•×¤×©×•×˜. ××¢×§×‘ ×”×•×¦××•×ª ×•×”×›× ×¡×•×ª, ×—×¡×›×•× ×•×ª, ×“×©×‘×•×¨×“ ×¢× ×’×¨×¤×™× â€” ×—×™× × ×œ×—×œ×•×˜×™×Ÿ.">
<meta name="twitter:image" content="og-image.png">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' stop-color='%236366F1'/><stop offset='100%25' stop-color='%238B5CF6'/></linearGradient></defs><circle cx='50' cy='50' r='48' fill='url(%23g)'/><text x='50' y='50' text-anchor='middle' dominant-baseline='central' font-size='55' font-weight='700' fill='white' font-family='Arial'>â‚ª</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%236366F1'/><text x='50' y='50' text-anchor='middle' dominant-baseline='central' font-size='55' font-weight='700' fill='white' font-family='Arial'>â‚ª</text></svg>">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
<script defer src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js" integrity="sha384-ZaR6mWzmJtrRibZ1Vm7SoHFr8OXjyAuGAXalGDKqbxFT18oi/z+oZLIRFkpeNor1" crossorigin="anonymous"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js" integrity="sha384-I1LYojsZ5RM1cOda44Z2h42Qa6YfsQ1XkXxREnhp4ueYBR/4d1pG1K+NZM537Vsj" crossorigin="anonymous"></script>
<script defer src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js" integrity="sha384-g5H2aNdtgRBYOBLsuOAuHvUXWnw4bswmU+tYjmGc1G3JfKxl79uWwV4sQarJsLwu" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" integrity="sha384-vsrfeLOOY6KuIYKDlmVH5UiBmgIdB1oEf7p01YgWHuqmOHfZr374+odEv96n9tNC" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" integrity="sha384-vtjasyidUo0kW94K5MXDXntzOJpQgBKXmE7e2Ga4LG0skTTLeBi97eFAXsqewJjw" crossorigin="anonymous"></script>
<style>
:root{
--primary:#2563EB;--primary-light:#3B82F6;--primary-dark:#1D4ED8;--primary-bg:#EFF6FF;
--success:#16A34A;--success-light:#22C55E;--success-bg:#F0FDF4;
--danger:#DC2626;--danger-light:#EF4444;--danger-bg:#FEF2F2;
--warning:#F59E0B;--warning-bg:#FFFBEB;
--bg:#F1F5F9;--card:#FFFFFF;
--card-shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.06);
--card-shadow-hover:0 4px 12px rgba(0,0,0,.1),0 2px 4px rgba(0,0,0,.06);
--text:#1E293B;--text-secondary:#64748B;--text-light:#94A3B8;
--border:#E2E8F0;--border-light:#F1F5F9;
--radius:12px;--radius-sm:8px;--radius-xs:6px;
--font:'Heebo','Segoe UI',Arial,sans-serif;
--transition:.25s cubic-bezier(.4,0,.2,1);
--tab-height:64px;--summary-height:56px;
}
html.dark{
--bg:#0F172A;--card:#1E293B;--text:#F1F5F9;--text-secondary:#94A3B8;--text-light:#64748B;
--border:#334155;--border-light:#253049;--primary-bg:#1E3A5F;--success-bg:#14532D;
--danger-bg:#450A0A;--warning-bg:#422006;
--card-shadow:0 1px 3px rgba(0,0,0,.3);--card-shadow-hover:0 4px 12px rgba(0,0,0,.4);
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--text);direction:rtl;min-height:100vh;padding-bottom:calc(var(--tab-height) + var(--summary-height) + 16px);-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--text-light);border-radius:3px}

/* Header */
.app-header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:14px 20px;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(37,99,235,.3);display:flex;align-items:center;justify-content:space-between}
.app-header .hdr-right{display:flex;align-items:center;gap:8px}
.app-header h1{font-size:1.2rem;font-weight:700;display:flex;align-items:center;gap:8px}
.app-header .subtitle{font-size:.78rem;opacity:.85;font-weight:300;margin-top:2px}
.dark-toggle{background:none;border:1px solid rgba(255,255,255,.3);color:#fff;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.1rem;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.dark-toggle:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,.5)}
.hdr-tooltip{position:relative}
.hdr-tooltip::after{content:attr(data-tip);position:absolute;top:calc(100% + 8px);left:50%;transform:translateX(-50%);background:var(--card-bg,#333);color:var(--text-primary,#fff);font-size:.72rem;white-space:nowrap;padding:4px 10px;border-radius:6px;pointer-events:none;opacity:0;transition:opacity .2s;box-shadow:0 2px 8px rgba(0,0,0,.25);z-index:9999}
.hdr-tooltip:hover::after{opacity:1}

/* Tabs */
.tab-bar{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;z-index:200;height:var(--tab-height);box-shadow:0 -2px 10px rgba(0,0,0,.06)}
.tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;border:none;background:none;font-family:var(--font);font-size:.65rem;font-weight:500;color:var(--text-secondary);cursor:pointer;transition:var(--transition);padding:6px 2px;position:relative}
.tab-btn .tab-icon{font-size:1.2rem}
.tab-btn.active{color:var(--primary);font-weight:700}
.tab-btn.active::before{content:'';position:absolute;top:0;left:20%;right:20%;height:3px;background:var(--primary);border-radius:0 0 3px 3px}

/* Tab Content */
.tab-content{display:none;padding:16px;max-width:1200px;margin:0 auto}
.tab-content.active{display:block;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* Month Selector */
.month-selector{display:flex;align-items:center;gap:10px;background:var(--card);padding:12px 16px;border-radius:var(--radius);box-shadow:var(--card-shadow);margin-bottom:16px;flex-wrap:wrap}
.month-selector label{font-weight:500;font-size:.9rem;color:var(--text-secondary)}
.month-selector select,.month-selector input[type="number"]{font-family:var(--font);font-size:.95rem;padding:8px 12px;border:1px solid var(--border);border-radius:var(--radius-xs);background:var(--card);color:var(--text);font-weight:500;direction:rtl}
.month-selector select{min-width:120px;cursor:pointer}
.month-selector input[type="number"]{width:80px}
.month-nav-btns{display:flex;gap:4px;margin-left:auto}
.month-nav-btn{width:36px;height:36px;border:1px solid var(--border);border-radius:var(--radius-xs);background:var(--card);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;color:var(--text-secondary);transition:var(--transition)}
.month-nav-btn:hover{background:var(--primary-bg);color:var(--primary);border-color:var(--primary)}

/* Category Cards */
.category-card{background:var(--card);border-radius:var(--radius);box-shadow:var(--card-shadow);margin-bottom:12px;overflow:hidden;transition:box-shadow var(--transition)}
.category-card:hover{box-shadow:var(--card-shadow-hover)}
.category-header{display:flex;align-items:center;padding:14px 16px;cursor:pointer;user-select:none;gap:10px;transition:background var(--transition)}
.category-header:hover{background:var(--border-light)}
.category-icon{font-size:1.3rem;flex-shrink:0}
.category-title{font-weight:700;font-size:.95rem;flex:1}
.category-totals{display:flex;gap:10px;font-size:.75rem;color:var(--text-secondary);flex-shrink:0}
.category-totals span{white-space:nowrap}
.category-totals .over{color:var(--danger);font-weight:600}
.category-totals .under{color:var(--success);font-weight:600}
.chevron{transition:transform var(--transition);color:var(--text-light);font-size:.85rem;flex-shrink:0}
.category-card.expanded .chevron{transform:rotate(-90deg)}
.category-progress{height:4px;background:var(--border-light);overflow:hidden}
.category-progress-bar{height:100%;border-radius:2px;transition:width .5s ease,background .3s ease}
.category-progress-bar.ok{background:linear-gradient(90deg,var(--success),var(--success-light))}
.category-progress-bar.warn{background:linear-gradient(90deg,var(--warning),#FBBF24)}
.category-progress-bar.over{background:linear-gradient(90deg,var(--danger),var(--danger-light))}
.category-body{max-height:0;overflow:hidden;transition:max-height .4s cubic-bezier(.4,0,.2,1)}
.category-card.expanded .category-body{max-height:5000px}

/* Child sub-header inside children category */
.child-subheader{background:var(--primary-bg);padding:8px 16px;font-weight:600;font-size:.85rem;color:var(--primary);display:flex;align-items:center;gap:6px;border-top:1px solid var(--border-light);border-bottom:1px solid var(--border-light)}
.child-subtotal{background:var(--border-light);padding:6px 16px;font-weight:600;font-size:.82rem;display:flex;justify-content:space-between;color:var(--text-secondary)}

/* Tables */
.data-table{width:100%;border-collapse:collapse;font-size:.85rem}
.data-table th{background:var(--bg);padding:7px 12px;text-align:right;font-weight:600;font-size:.75rem;color:var(--text-secondary);letter-spacing:.02em;border-bottom:1px solid var(--border)}
.data-table td{padding:5px 12px;border-bottom:1px solid var(--border-light);vertical-align:middle}
.data-table tr:last-child td{border-bottom:none}
.data-table .item-name{font-weight:500;min-width:90px}
.data-table .number-cell{text-align:center;min-width:85px}
.data-table .diff-positive{color:var(--success);font-weight:600}
.data-table .diff-negative{color:var(--danger);font-weight:600}
.data-table .subtotal-row{background:var(--bg);font-weight:700}
.data-table .subtotal-row td{border-top:2px solid var(--border);padding:9px 12px}
.num-input{width:100%;max-width:105px;padding:5px 7px;border:1px solid transparent;border-radius:var(--radius-xs);font-family:var(--font);font-size:.85rem;text-align:center;background:transparent;color:var(--text);transition:var(--transition);min-height:38px;direction:ltr}
.num-input:hover{border-color:var(--border);background:var(--border-light)}
.num-input:focus{outline:none;border-color:var(--primary);background:var(--primary-bg);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.add-row-btn{width:26px;height:26px;border:1px solid transparent;background:none;color:var(--text-light);cursor:pointer;border-radius:var(--radius-xs);display:flex;align-items:center;justify-content:center;font-size:.65rem;transition:var(--transition);opacity:.4;padding:0}
.add-row-btn:hover{background:var(--success-bg,rgba(22,163,74,.1));color:var(--success);border-color:var(--success);opacity:1}
.move-btn{width:30px;height:30px;border:1px solid transparent;background:none;color:var(--text-light);cursor:pointer;border-radius:var(--radius-xs);display:flex;align-items:center;justify-content:center;font-size:.7rem;transition:var(--transition);opacity:.6}
.move-btn:hover{background:var(--primary-bg);color:var(--primary);border-color:var(--primary);opacity:1}
.delete-btn{width:34px;height:34px;border:none;background:none;color:var(--text-light);cursor:pointer;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.85rem;transition:var(--transition)}
.delete-btn:hover{background:var(--danger-bg);color:var(--danger)}
.lock-btn{width:32px;height:32px;border:none;border-radius:50%;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;transition:var(--transition);flex-shrink:0;background:transparent;color:var(--text-light);line-height:1}
.lock-btn:hover{background:var(--border-light)}
.lock-btn.locked{background:var(--primary-bg);color:var(--primary)}
.add-item-btn{display:flex;align-items:center;justify-content:center;gap:6px;padding:9px 14px;margin:8px 12px 12px;border:1px dashed var(--border);border-radius:var(--radius-xs);background:none;font-family:var(--font);font-size:.82rem;color:var(--primary);cursor:pointer;transition:var(--transition);font-weight:500;width:calc(100% - 24px);min-height:40px}
.add-item-btn:hover{background:var(--primary-bg);border-color:var(--primary)}
.section-title{font-size:1.05rem;font-weight:700;margin:20px 0 10px;display:flex;align-items:center;gap:8px;color:var(--text)}
.section-add-btn{width:26px;height:26px;border-radius:50%;border:1.5px solid var(--border);background:var(--card);color:var(--primary);font-size:1.1rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-right:auto;transition:var(--transition);line-height:1}
.section-add-btn:hover{background:var(--primary-bg);border-color:var(--primary)}
.month-notes{width:100%;box-sizing:border-box;min-height:64px;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg);font-family:var(--font);font-size:.85rem;color:var(--text);resize:vertical;direction:rtl;line-height:1.5}
.month-notes:focus{outline:none;border-color:var(--primary);background:var(--card)}
.budget-field{display:inline-flex;align-items:center;gap:4px;cursor:pointer;padding:3px 10px;border-radius:var(--radius-xs);transition:var(--transition);border:1.5px dashed var(--primary);background:var(--primary-bg);font-weight:600;color:var(--primary);font-size:.78rem}
.budget-field:hover{background:var(--primary);color:#fff;border-style:solid}
.budget-field::after{content:'âœï¸';font-size:.65rem;margin-right:2px}

/* Summary Bar */
.summary-bar{position:fixed;bottom:var(--tab-height);left:0;right:0;background:var(--card);border-top:1px solid var(--border);display:flex;justify-content:center;gap:4px;padding:8px 10px;z-index:150;box-shadow:0 -1px 6px rgba(0,0,0,.04);flex-wrap:wrap}
.summary-item{display:flex;flex-direction:column;align-items:center;padding:2px 10px;min-width:80px}
.summary-item .label{font-size:.6rem;color:var(--text-secondary);font-weight:500}
.summary-item .value{font-size:.88rem;font-weight:700}
.summary-item .value.income-val{color:var(--primary)}
.summary-item .value.expense-val{color:var(--danger)}
.summary-item .value.savings-positive{color:var(--success)}
.summary-item .value.savings-negative{color:var(--danger)}

/* KPI / Dashboard */
.dash-view-btn{padding:6px 16px;border:none;background:var(--bg);color:var(--text-secondary);cursor:pointer;font-size:.82rem;font-weight:600;transition:var(--transition)}
.dash-view-btn.active{background:var(--primary);color:#fff}
.yearly-table{width:100%;border-collapse:collapse;font-size:.82rem;margin-top:8px}
.yearly-table th,.yearly-table td{padding:8px 10px;text-align:center;border-bottom:1px solid var(--border)}
.yearly-table th{font-weight:600;background:var(--bg);position:sticky;top:0}
.yearly-table td.positive{color:var(--success)}.yearly-table td.negative{color:var(--danger)}
.yearly-table tr:last-child{font-weight:700;background:var(--primary-bg)}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-bottom:18px}
.kpi-card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--card-shadow);text-align:center;position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px}
.kpi-card.blue::before{background:var(--primary)}.kpi-card.red::before{background:var(--danger)}
.kpi-card.green::before{background:var(--success)}.kpi-card.amber::before{background:var(--warning)}
.kpi-label{font-size:.72rem;color:var(--text-secondary);margin-bottom:4px;font-weight:500}
.kpi-value{font-size:1.3rem;font-weight:700}
.kpi-card.blue .kpi-value{color:var(--primary)}.kpi-card.red .kpi-value{color:var(--danger)}
.kpi-card.green .kpi-value{color:var(--success)}.kpi-card.amber .kpi-value{color:var(--warning)}
.kpi-mom{font-size:.7rem;margin-top:2px}
.kpi-mom.up{color:var(--success)}.kpi-mom.down{color:var(--danger)}
.savings-ring{width:60px;height:60px;margin:0 auto 4px;position:relative}
.savings-ring svg{transform:rotate(-90deg)}
.savings-ring .ring-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.8rem;font-weight:700}
.chart-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px}
.chart-card{background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--card-shadow)}
.chart-card h3{font-size:.9rem;font-weight:600;margin-bottom:10px;color:var(--text)}
.chart-wrapper{position:relative;width:100%;max-height:300px}

/* Health Score Gauge */
.health-gauge{width:100px;height:100px;margin:0 auto 8px;position:relative}
.health-gauge .gauge-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center}
.health-gauge .gauge-score{font-size:1.5rem;font-weight:700;line-height:1}
.health-gauge .gauge-label{font-size:.6rem;color:var(--text-secondary)}

/* Alerts */
.alerts-area{margin-bottom:12px}
.alert-banner{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--radius-sm);margin-bottom:6px;font-size:.82rem;font-weight:500;animation:fadeIn .3s ease}
.alert-banner .alert-close{margin-right:auto;background:none;border:none;cursor:pointer;font-size:.9rem;opacity:.5;color:inherit}
.alert-banner .alert-close:hover{opacity:1}
.alert-banner.red{background:var(--danger-bg);color:var(--danger)}
.alert-banner.green{background:var(--success-bg);color:var(--success)}
.alert-banner.amber{background:var(--warning-bg);color:#92400E}
.alert-banner.blue{background:var(--primary-bg);color:var(--primary)}

/* Data Management / Admin */
.dm-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px;margin-bottom:20px}
.dm-btn{display:flex;flex-direction:column;align-items:center;gap:6px;padding:16px 12px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;font-family:var(--font);font-size:.8rem;font-weight:500;color:var(--text);transition:var(--transition);box-shadow:var(--card-shadow)}
.dm-btn:hover{border-color:var(--primary);background:var(--primary-bg);color:var(--primary);box-shadow:var(--card-shadow-hover)}
.dm-btn .dm-icon{font-size:1.6rem}.dm-btn .dm-label{text-align:center}

/* Admin sections */
.admin-section{background:var(--card);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:16px;margin-bottom:14px}
.admin-section h3{font-size:.95rem;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:6px}
.admin-list{list-style:none}
.admin-list li{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border-light);font-size:.88rem}
.admin-list li:last-child{border-bottom:none}
.admin-list .item-text{flex:1}
.admin-input{padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-family:var(--font);font-size:.88rem;background:var(--card);color:var(--text);min-height:38px}
.admin-input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.btn-sm{padding:5px 12px;border-radius:var(--radius-xs);border:1px solid var(--border);font-family:var(--font);font-size:.78rem;cursor:pointer;font-weight:500;transition:var(--transition);background:var(--card);color:var(--text)}
.btn-sm:hover{border-color:var(--primary);color:var(--primary)}
.btn-sm.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.btn-sm.primary:hover{background:var(--primary-dark)}
.btn-sm.danger{color:var(--danger);border-color:var(--danger)}
.btn-sm.danger:hover{background:var(--danger-bg)}

/* Savings Tab */
.savings-zone{background:var(--card);border-radius:var(--radius);box-shadow:var(--card-shadow);padding:16px;margin-bottom:16px}
.savings-zone h3{font-size:1rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.savings-zone .zone-badge{font-size:.65rem;padding:2px 8px;border-radius:10px;font-weight:500}
.fund-card{border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px;transition:var(--transition)}
.fund-card:hover{border-color:var(--primary-light);box-shadow:var(--card-shadow)}
.fund-header{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.fund-name{font-weight:600;font-size:.92rem;flex:1}
.fund-amount{font-size:1.2rem;font-weight:700;color:var(--primary);margin-bottom:4px}
.fund-meta{font-size:.75rem;color:var(--text-secondary);display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px}
.fund-progress{height:8px;background:var(--border-light);border-radius:4px;overflow:hidden;margin-bottom:6px}
.fund-progress-bar{height:100%;border-radius:4px;transition:width .6s ease}
.fund-status{font-size:.75rem;font-weight:500;display:flex;align-items:center;gap:4px}
.fund-actions{display:flex;gap:6px;margin-top:8px}
.savings-calc{background:var(--bg);border-radius:var(--radius-sm);padding:14px;margin-top:12px}
.savings-calc h4{font-size:.88rem;font-weight:600;margin-bottom:10px}
.calc-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap}
.calc-row label{font-size:.82rem;min-width:120px;color:var(--text-secondary)}
.calc-row input{flex:1;min-width:100px;max-width:160px}
.calc-result{background:var(--card);border-radius:var(--radius-xs);padding:10px 14px;margin-top:8px;font-weight:600;text-align:center;font-size:.95rem}

/* Wizard */
.wizard-overlay{position:fixed;inset:0;background:var(--bg);z-index:1000;display:flex;flex-direction:column;overflow-y:auto}
.wizard-overlay.hidden{display:none}
.wizard-progress{height:4px;background:var(--border);position:sticky;top:0;z-index:10}
.wizard-progress-bar{height:100%;background:var(--primary);transition:width .4s ease;border-radius:0 0 2px 2px}
.wizard-content{flex:1;max-width:640px;margin:0 auto;padding:24px 20px 100px;width:100%}
.wizard-step{animation:fadeIn .4s ease}
.wizard-title{font-size:1.4rem;font-weight:700;margin-bottom:6px;text-align:center}
.wizard-subtitle{font-size:.9rem;color:var(--text-secondary);text-align:center;margin-bottom:24px}
.wizard-card{background:var(--card);border:2px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:10px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:12px}
.wizard-card:hover,.wizard-card.selected{border-color:var(--primary);background:var(--primary-bg)}
.wizard-card .wc-icon{font-size:1.6rem;flex-shrink:0}
.wizard-card .wc-title{font-weight:600;font-size:.95rem}
.wizard-card .wc-desc{font-size:.8rem;color:var(--text-secondary)}
.wizard-check{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;cursor:pointer;transition:var(--transition)}
.wizard-check:hover{border-color:var(--primary-light)}
.wizard-check.checked{border-color:var(--primary);background:var(--primary-bg)}
.wizard-check input[type="checkbox"]{width:18px;height:18px;accent-color:var(--primary)}
.wizard-check .wch-icon{font-size:1.2rem}
.wizard-check .wch-text{font-weight:500;font-size:.9rem;flex:1}
.wizard-items-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:10px;overflow:hidden}
.wizard-items-header{padding:10px 14px;background:var(--bg);font-weight:600;font-size:.9rem;display:flex;align-items:center;gap:8px;cursor:pointer}
.wizard-items-body{padding:10px 14px}
.wizard-items-body .item-tag{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border:1px solid var(--border);border-radius:20px;font-size:.78rem;margin:3px;background:var(--card)}
.wizard-items-body .item-tag.active{border-color:var(--primary);background:var(--primary-bg);color:var(--primary)}
.wizard-items-body .item-tag .tag-x{cursor:pointer;opacity:.5;font-size:.7rem}
.wizard-items-body .item-tag .tag-x:hover{opacity:1;color:var(--danger)}
.wizard-nav{position:fixed;bottom:0;left:0;right:0;background:var(--card);border-top:1px solid var(--border);padding:12px 20px;display:flex;justify-content:space-between;align-items:center;z-index:1001}
.wizard-nav .wn-btn{padding:10px 28px;border-radius:var(--radius-sm);font-family:var(--font);font-size:.92rem;font-weight:600;cursor:pointer;transition:var(--transition);border:1px solid var(--border)}
.wizard-nav .wn-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.wizard-nav .wn-btn.primary:hover{background:var(--primary-dark)}
.wizard-nav .wn-btn.secondary{background:var(--card);color:var(--text)}
.wizard-nav .wn-btn.secondary:hover{background:var(--bg)}
.wizard-nav .wn-btn.skip{background:none;border:none;color:var(--text-light);font-size:.82rem}
.wizard-field{margin-bottom:14px}
.wizard-field label{display:block;font-size:.82rem;font-weight:600;color:var(--text-secondary);margin-bottom:5px}
.wizard-field input,.wizard-field select{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius-xs);font-family:var(--font);font-size:.92rem;background:var(--card);color:var(--text);min-height:44px}
.wizard-field input:focus,.wizard-field select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.wizard-child-card{background:var(--bg);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px;border:1px solid var(--border)}
.wizard-child-card .child-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.wizard-child-card .child-row input{flex:1;min-width:100px}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:5000;display:flex;align-items:center;justify-content:center;padding:20px;opacity:0;pointer-events:none;transition:opacity .2s ease}
.modal-overlay.active{opacity:1;pointer-events:all}
.modal{background:var(--card);border-radius:var(--radius);padding:24px;max-width:480px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.2);transform:scale(.95);transition:transform .2s ease;max-height:85vh;overflow-y:auto}
.modal-overlay.active .modal{transform:scale(1)}
.modal h3{margin-bottom:10px;font-size:1.02rem}
.modal p{color:var(--text-secondary);font-size:.88rem;margin-bottom:16px;line-height:1.5}
.modal-actions{display:flex;gap:8px;justify-content:flex-start}
.modal-btn{padding:8px 20px;border-radius:var(--radius-xs);border:1px solid var(--border);font-family:var(--font);font-size:.85rem;cursor:pointer;font-weight:500;transition:var(--transition)}
.modal-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.modal-btn.primary:hover{background:var(--primary-dark)}
.modal-btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.modal-btn.cancel{background:var(--card)}
.modal-btn.cancel:hover{background:var(--bg)}
.modal select{width:100%;padding:10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-family:var(--font);font-size:.88rem;margin-bottom:14px;direction:rtl;background:var(--card);color:var(--text)}
.modal-field{margin-bottom:14px}
.modal-field label{display:block;font-size:.8rem;font-weight:600;color:var(--text-secondary);margin-bottom:5px}
.modal-input{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:var(--radius-xs);font-family:var(--font);font-size:.92rem;color:var(--text);background:var(--bg);transition:var(--transition);direction:rtl;min-height:44px}
.modal-input:focus{outline:none;border-color:var(--primary);background:var(--primary-bg);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.modal-input.ltr{direction:ltr;text-align:right}
.modal-currency-wrap{position:relative}
.modal-currency-wrap .modal-input{padding-left:32px}
.modal-currency-wrap::after{content:'â‚ª';position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--text-light);font-weight:600;font-size:.88rem;pointer-events:none}

/* Summary Table */
.summary-table{width:100%;border-collapse:collapse;background:var(--card);border-radius:var(--radius);overflow:hidden;box-shadow:var(--card-shadow);font-size:.82rem}
.summary-table th{background:var(--primary);color:#fff;padding:9px 12px;text-align:right;font-weight:600}
.summary-table td{padding:9px 12px;border-bottom:1px solid var(--border-light)}
.summary-table tr:nth-child(even){background:var(--bg)}

/* Toast */
.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-20px);background:var(--text);color:var(--bg);padding:10px 24px;border-radius:30px;font-size:.82rem;font-weight:500;z-index:999;opacity:0;transition:opacity .3s,transform .3s;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* Income inputs */
.income-source-input{width:100%;max-width:160px;padding:5px 8px;border:1px solid transparent;border-radius:var(--radius-xs);font-family:var(--font);font-size:.85rem;background:transparent;color:var(--text);transition:var(--transition);min-height:38px;direction:rtl}
.income-source-input:hover{border-color:var(--border);background:var(--border-light)}
.income-source-input:focus{outline:none;border-color:var(--primary);background:var(--primary-bg);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.misc-label{font-weight:500;padding-right:4px}
.trend-btn{font-size:.65rem;cursor:pointer;opacity:0;margin-right:4px;transition:opacity .2s;vertical-align:middle}
.item-name:hover .trend-btn{opacity:.6}
.trend-btn:hover{opacity:1!important}
.provider-text{font-size:.7rem;color:var(--text-secondary);cursor:pointer;display:none;line-height:1.2;margin-top:1px}
.provider-text.has-provider{display:block}
.item-name:hover .provider-text{display:block}
.provider-text:hover{color:var(--primary);text-decoration:underline}
.provider-inline-input{width:100%;max-width:180px;padding:4px 8px;border:1px solid var(--border);border-radius:var(--radius-xs);font-family:var(--font);font-size:.82rem;background:transparent;color:var(--text);transition:var(--transition);direction:rtl}
.provider-inline-input:focus{outline:none;border-color:var(--primary);background:var(--primary-bg);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.provider-inline-input::placeholder{color:var(--text-light);font-size:.78rem}
.quick-add-panel{background:var(--card-bg);border:1px solid var(--primary);border-radius:10px;padding:12px 14px;margin:6px 0;box-shadow:0 4px 16px rgba(0,0,0,.12);display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
.quick-add-panel input{flex:1;min-width:100px;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-family:var(--font);font-size:.85rem;background:var(--bg);color:var(--text);direction:rtl}
.quick-add-panel input[type="number"]{max-width:110px;direction:ltr;text-align:right}
.quick-add-panel input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.quick-add-panel .qap-btns{display:flex;gap:6px;flex-shrink:0}
.quick-add-panel .qap-btn{padding:7px 16px;border:none;border-radius:var(--radius-xs);font-family:var(--font);font-size:.82rem;cursor:pointer;font-weight:600}
.quick-add-panel .qap-btn.ok{background:var(--primary);color:#fff}
.quick-add-panel .qap-btn.ok:hover{opacity:.9}
.quick-add-panel .qap-btn.cancel{background:var(--border-light);color:var(--text-secondary)}
.quick-add-panel .qap-btn.cancel:hover{background:var(--border)}
.institution-text{font-size:.75rem;color:var(--text-secondary);margin-top:2px}

/* Login Overlay */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:1000;display:flex;align-items:center;justify-content:center;flex-direction:column}
.login-overlay.hidden{display:none}
.login-content{max-width:420px;width:100%;padding:24px;text-align:center}
.login-title{font-size:1.8rem;font-weight:700;margin-bottom:6px}
.login-subtitle{font-size:.92rem;color:var(--text-secondary);margin-bottom:28px;line-height:1.5}
.google-btn{display:inline-flex;align-items:center;gap:10px;padding:12px 28px;background:#fff;border:1px solid var(--border);border-radius:var(--radius);font-family:var(--font);font-size:1rem;font-weight:500;cursor:pointer;transition:var(--transition);box-shadow:var(--card-shadow);color:var(--text)}
.google-btn:hover{box-shadow:var(--card-shadow-hover);border-color:var(--primary)}
.offline-link{display:block;margin-top:16px;font-size:.82rem;color:var(--text-light);cursor:pointer;text-decoration:underline}
.offline-link:hover{color:var(--primary)}
.invite-code-display{font-size:2rem;font-weight:700;letter-spacing:6px;direction:ltr;text-align:center;padding:16px;background:var(--primary-bg);border-radius:var(--radius);color:var(--primary);margin:12px 0;user-select:all}
.fb-setup-step{display:flex;gap:12px;margin-bottom:12px;align-items:flex-start;text-align:right}
.fb-setup-step .step-num{background:var(--primary);color:#fff;width:26px;height:26px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:.8rem;flex-shrink:0}
.fb-setup-step .step-text{font-size:.85rem;line-height:1.5;flex:1}
.partner-status{font-size:.72rem;color:rgba(255,255,255,.8)}
.connection-indicator{font-size:.7rem;cursor:help}

/* Owner Badges */
.owner-badge{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;font-size:.65rem;font-weight:700;cursor:pointer;transition:var(--transition);border:2px solid transparent;user-select:none;flex-shrink:0}
.owner-badge:hover{opacity:.85;transform:scale(1.1)}
.owner-badge.p1{background:#DBEAFE;color:#1D4ED8;border-color:#93C5FD}
.owner-badge.p2{background:#FCE7F3;color:#BE185D;border-color:#F9A8D4}
.owner-badge.shared{background:#D1FAE5;color:#059669;border-color:#6EE7B7}
.owner-cell{width:36px;text-align:center}
.owner-legend{display:flex;gap:8px;align-items:center;font-size:.72rem;color:var(--text-secondary);margin-bottom:10px;flex-wrap:wrap;justify-content:center;padding:4px 12px}
.owner-legend .owner-badge{width:20px;height:20px;font-size:.55rem;cursor:default}
.edit-meta{font-size:.6rem;color:var(--text-light);font-style:italic;display:block;margin-top:1px}

/* Utilities */
.hidden{display:none!important}
.text-center{text-align:center}
.actions-cell{width:auto;white-space:nowrap;text-align:center}
.actions-cell-inner{display:inline-flex;align-items:center;gap:2px}
.confetti{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999}

/* Responsive */
@media(max-width:768px){
.app-header{padding:10px 14px}.app-header h1{font-size:1rem}
.app-header .subtitle{font-size:.7rem}
.tab-content{padding:10px}.month-selector{padding:8px 10px;gap:6px}
.month-selector label{font-size:.82rem}
.month-selector select,.month-selector input[type="number"]{font-size:.88rem;padding:6px 8px}
.category-header{padding:10px 12px;gap:8px}
.category-icon{font-size:1.1rem}
.category-title{font-size:.88rem}
.category-totals{font-size:.68rem;gap:6px}
.data-table{font-size:.78rem}.data-table th,.data-table td{padding:5px 7px}
.num-input{max-width:85px;font-size:.85rem;min-height:44px;padding:8px 6px}
.kpi-grid{grid-template-columns:repeat(2,1fr)}
.kpi-card{padding:12px 10px}
.chart-grid{grid-template-columns:1fr}
.summary-bar{gap:1px;padding:6px 4px}
.summary-item{padding:2px 5px;min-width:68px}
.summary-item .label{font-size:.55rem}
.summary-item .value{font-size:.78rem}
.dm-grid{grid-template-columns:repeat(2,1fr)}
.wizard-content{padding:16px 14px 100px}
.wizard-title{font-size:1.15rem}
.modal{padding:18px;max-height:90vh;border-radius:var(--radius-sm);margin:0 8px}
.modal-overlay{padding:10px}
.modal-actions{flex-wrap:wrap}
.modal-btn{padding:10px 16px;min-height:44px;font-size:.88rem}
.login-content{padding:16px}
.owner-badge{min-width:30px;min-height:30px;font-size:.7rem}
.delete-btn{width:40px;height:40px;font-size:.95rem}
.lock-btn{width:38px;height:38px;font-size:1rem}
.add-item-btn{padding:10px 14px;font-size:.85rem;min-height:44px}
}
@media(max-width:420px){
.app-header h1{font-size:.9rem}
.app-header .subtitle{font-size:.65rem}
.tab-btn{font-size:.6rem;padding:4px 1px}
.tab-btn .tab-icon{font-size:1rem}
.month-selector{flex-direction:column;align-items:stretch}
.month-nav-btns{margin-right:0;justify-content:center}
.category-totals{flex-direction:column;gap:2px;align-items:flex-end}
.data-table{font-size:.72rem}
.data-table th,.data-table td{padding:4px 5px}
.num-input{max-width:72px;font-size:.82rem;min-height:44px;padding:8px 4px}
.kpi-grid{grid-template-columns:1fr 1fr;gap:6px}
.summary-bar{flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch}
.dm-grid{grid-template-columns:1fr}
.dm-btn{padding:12px}
}

@media(min-width:1025px){
.tab-bar{position:relative;bottom:auto;border-top:none;border-bottom:1px solid var(--border);height:auto;padding:0;box-shadow:0 2px 4px rgba(0,0,0,.04);z-index:90}
.tab-btn{flex-direction:row;gap:5px;padding:11px 16px;font-size:.82rem}
.tab-btn .tab-icon{font-size:1rem}
.tab-btn.active::before{top:auto;bottom:0;left:10%;right:10%;border-radius:3px 3px 0 0}
body{padding-bottom:0}
.summary-bar{position:sticky;bottom:0;gap:14px}
.tab-content{padding:24px}
.kpi-grid{grid-template-columns:repeat(4,1fr)}
}

@media print{
.tab-bar,.summary-bar,.month-nav-btns,.add-item-btn,.delete-btn,.wizard-overlay,.alerts-area{display:none!important}
body{padding-bottom:0;background:#fff}
.tab-content{display:block!important;padding:0}
.category-card{break-inside:avoid;box-shadow:none;border:1px solid #ddd}
.category-body{max-height:none!important}
.app-header{position:static;box-shadow:none;print-color-adjust:exact;-webkit-print-color-adjust:exact}
}
</style>
</head>
<body>
<!-- Loading Screen -->
<div id="loadingScreen" style="position:fixed;inset:0;background:linear-gradient(135deg,#2563EB,#1D4ED8);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;font-family:'Heebo',sans-serif;direction:rtl">
<div style="font-size:3rem;margin-bottom:16px;animation:pulse 1.5s ease infinite">ğŸ’°</div>
<div style="font-size:1.4rem;font-weight:700;margin-bottom:8px">×ª×§×¦×™×‘ ××©×¤×—×ª×™</div>
<div style="font-size:.85rem;opacity:.8;margin-bottom:24px">× ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×</div>
<div style="width:40px;height:40px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .8s linear infinite"></div>
</div>
<style>
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
</style>
<!-- Login Overlay -->
<div class="login-overlay hidden" id="loginOverlay">
<div class="login-content">
<div style="font-size:3.5rem;margin-bottom:12px">ğŸ’°</div>
<div class="login-title">×ª×§×¦×™×‘ ××©×¤×—×ª×™</div>
<div class="login-subtitle">×”×ª×—×‘×¨×• ×›×“×™ ×œ×¡× ×›×¨×Ÿ ×•×œ×©×ª×£ ××ª ×”×ª×§×¦×™×‘</div>
<button class="google-btn" onclick="signInWithGoogle()">
<svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
<span>×”×ª×—×‘×¨×•×ª ×¢× Google</span>
</button>
<div class="offline-link" onclick="skipLogin()">×”××©×š ×œ×œ× ×”×ª×—×‘×¨×•×ª (××¦×‘ ××§×•××™)</div>
<div id="loginStatus" style="margin-top:16px;font-size:.82rem;color:var(--text-secondary)"></div>
</div>
</div>

<!-- Family Setup Overlay -->
<div class="login-overlay hidden" id="familyOverlay">
<div class="login-content" id="familyContent"></div>
</div>

<!-- Firebase Config Overlay -->
<div class="login-overlay hidden" id="fbConfigOverlay">
<div class="login-content" style="max-width:680px;text-align:right;overflow-y:auto;max-height:90vh" id="fbConfigContent"></div>
</div>

<!-- Wizard Overlay -->
<div class="wizard-overlay hidden" id="wizardOverlay">
<button onclick="cancelWizard()" style="position:absolute;top:12px;right:12px;background:var(--card);border:1px solid var(--border);border-radius:50%;width:32px;height:32px;font-size:1.2rem;cursor:pointer;z-index:1002;color:var(--text)">âœ•</button>
<div class="wizard-progress"><div class="wizard-progress-bar" id="wizardProgressBar"></div></div>
<div class="wizard-content" id="wizardContent"></div>
<div class="wizard-nav" id="wizardNav"></div>
</div>

<!-- Header -->
<header class="app-header">
<div>
<h1 id="appTitle">ğŸ’° ×ª×§×¦×™×‘ ××©×¤×—×ª×™</h1>
<div class="subtitle" id="appSubtitle">× ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×</div>
</div>
<div class="hdr-right">
<span id="connectionStatus" class="connection-indicator" style="display:none"></span>
<span id="partnerStatus" class="partner-status"></span>
<button class="dark-toggle hdr-tooltip" id="undoBtn" onclick="undo()" data-tip="×‘×™×˜×•×œ ×¤×¢×•×œ×”" style="display:none">â†©ï¸</button>
<button class="dark-toggle hdr-tooltip" id="shareBtn" onclick="showShareModal()" data-tip="×©×™×ª×•×£ ×ª×§×¦×™×‘" style="display:none">ğŸ”—</button>
<button class="dark-toggle hdr-tooltip" id="darkToggle" onclick="toggleDarkMode()" data-tip="××¦×‘ ×›×”×”/×‘×”×™×¨">ğŸŒ™</button>
<button class="dark-toggle hdr-tooltip" id="userBtn" onclick="showUserMenu()" data-tip="×—×©×‘×•×Ÿ"><span id="userInitial">ğŸ‘¤</span></button>
</div>
</header>

<!-- Tab Bar -->
<nav class="tab-bar" id="tabBar">
<button class="tab-btn active" data-tab="budget" onclick="switchTab('budget')" style="position:relative"><span class="tab-icon">ğŸ“‹</span><span>×ª×§×¦×™×‘</span><span id="alertBadge" style="display:none;position:absolute;top:4px;right:50%;transform:translateX(14px);background:var(--danger);color:#fff;font-size:.6rem;font-weight:700;min-width:16px;height:16px;border-radius:8px;align-items:center;justify-content:center;padding:0 4px"></span></button>
<button class="tab-btn" data-tab="dashboard" onclick="switchTab('dashboard')"><span class="tab-icon">ğŸ“Š</span><span>×“×©×‘×•×¨×“</span></button>
<button class="tab-btn" data-tab="savings" onclick="switchTab('savings')"><span class="tab-icon">ğŸ’°</span><span>×—×¡×›×•× ×•×ª</span></button>
<button class="tab-btn" data-tab="manage" onclick="switchTab('manage')"><span class="tab-icon">âš™ï¸</span><span>× ×™×”×•×œ</span></button>
</nav>

<!-- Toast -->
<div id="toast" class="toast"></div>
<!-- Modal -->
<div class="modal-overlay" id="modalOverlay"><div class="modal" id="modalContent"></div></div>

<!-- Summary Bar -->
<div class="summary-bar" id="summaryBar">
<div class="summary-item"><span class="label">×”×›× ×¡×•×ª</span><span class="value income-val" id="summaryIncome">â‚ª 0</span></div>
<div class="summary-item"><span class="label">×”×•×¦××•×ª</span><span class="value expense-val" id="summaryExpenses">â‚ª 0</span></div>
<div class="summary-item"><span class="label">×—×™×¡×›×•×Ÿ</span><span class="value" id="summarySavings">â‚ª 0</span></div>
<div class="summary-item"><span class="label">ğŸ¦ ×”×¤×§×“×•×ª</span><span class="value income-val" id="summaryDeposits">â‚ª 0</span></div>
<div class="summary-item"><span class="label">ğŸ¯ ×—×•×¤×©×™</span><span class="value" id="summaryFree">â‚ª 0</span></div>
</div>

<!-- Tab 1: Budget -->
<div class="tab-content active" id="tab-budget">
<div class="alerts-area" id="alertsArea"></div>
<div class="month-selector">
<label>ğŸ“…</label>
<select id="monthSelect" onchange="changeMonth()"></select>
<input type="number" id="yearInput" min="2020" max="2040" onchange="changeMonth()">
<div class="month-nav-btns">
<button class="month-nav-btn hdr-tooltip" onclick="navMonth(1)" data-tip="×—×•×“×© ×”×‘×">â—€</button>
<button class="month-nav-btn hdr-tooltip" onclick="navMonth(-1)" data-tip="×—×•×“×© ×§×•×“×">â–¶</button>
<button class="month-nav-btn hdr-tooltip" onclick="showCopyStructure()" data-tip="×”×¢×ª×§ ××‘× ×” ××—×•×“×©" style="font-size:.8rem">ğŸ“‹</button>
<button class="month-nav-btn hdr-tooltip" onclick="showRecommendedBudget()" data-tip="×ª×§×¦×™×‘ ××•××œ×¥" style="font-size:.8rem">ğŸ¯</button>
<button class="month-nav-btn hdr-tooltip" onclick="showCrossSearch()" data-tip="×—×™×¤×•×© ×—×•×¦×” ×—×•×“×©×™×" style="font-size:.8rem">ğŸ”</button>
</div>
</div>
<div class="section-title">ğŸ’³ ×”×•×¦××•×ª <button class="section-add-btn" onclick="addCategory()" title="×”×•×¡×£ ×§×˜×’×•×¨×™×”">+</button></div>
<div id="categoriesContainer"></div>
<div class="section-title" id="miscSection">ğŸ“¦ ×”×•×¦××•×ª ××—×¨×•×ª <button class="section-add-btn" onclick="addMiscItem()" title="×”×•×¡×£ ×¤×¨×™×˜">+</button></div>
<div class="category-card expanded"><div class="category-body" style="max-height:none">
<table class="data-table"><thead><tr><th>×¤×¨×™×˜</th><th class="number-cell">×¡×›×•×</th><th class="actions-cell"></th></tr></thead>
<tbody id="miscBody"></tbody>
<tfoot><tr class="subtotal-row"><td>×¡×”×´×› ×”×•×¦××•×ª ××—×¨×•×ª</td><td class="number-cell" id="miscTotalCell">â‚ª 0</td><td></td></tr></tfoot></table>
<button class="add-item-btn" onclick="addMiscItem()">+ ×”×•×¡×£ ×¤×¨×™×˜</button>
</div></div>
<div class="section-title">ğŸ’µ ×”×›× ×¡×•×ª <button class="section-add-btn" onclick="addIncomeRow()" title="×”×•×¡×£ ××§×•×¨ ×”×›× ×¡×”">+</button><button class="section-add-btn" onclick="showIncomeDefaults()" title="×”×’×“×¨×•×ª ×”×›× ×¡×•×ª ×‘×¨×™×¨×ª ××—×“×œ" style="font-size:.75rem">âš™ï¸</button></div>
<div class="category-card expanded"><div class="category-body" style="max-height:none">
<table class="data-table"><thead><tr><th class="owner-cell"></th><th>××§×•×¨</th><th class="number-cell">×¡×›×•×</th><th class="actions-cell"></th></tr></thead>
<tbody id="incomeBody"></tbody>
<tfoot><tr class="subtotal-row"><td></td><td>×¡×”×´×› ×”×›× ×¡×•×ª</td><td class="number-cell" id="incomeTotalCell">â‚ª 0</td><td></td></tr></tfoot></table>
<button class="add-item-btn" onclick="addIncomeRow()">+ ×”×•×¡×£ ××§×•×¨ ×”×›× ×¡×”</button>
</div></div>
<div class="section-title">ğŸ¯ ×××–×Ÿ ×—×•×“×©×™</div>
<div class="category-card expanded"><div class="category-body" style="max-height:none">
<div id="discretionarySection" style="padding:12px 16px">
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:8px">
<span style="font-weight:500;font-size:.9rem">×›××” × ×©××¨?</span>
<span id="discretionaryAmount" style="font-weight:700;font-size:1.1rem;color:var(--success)">â‚ª 0</span>
</div>
<div style="display:flex;gap:12px;flex-wrap:wrap;font-size:.78rem;color:var(--text-secondary);margin-bottom:8px">
<span>×”×›× ×¡×•×ª: <strong id="discIncome">â‚ª 0</strong></span>
<span>×”×•×¦××•×ª: <strong id="discExpenses">â‚ª 0</strong></span>
<span>×”×¤×§×“×•×ª ×—×™×¡×›×•×Ÿ: <strong id="discDeposits">â‚ª 0</strong></span>
</div>
<div class="category-progress" style="margin:0"><div id="discretionaryBar" class="category-progress-bar ok" style="width:0%"></div></div>
<div id="savingsBreakdown" style="margin-top:10px;font-size:.78rem;color:var(--text-secondary)"></div>
</div>
</div></div>
<div id="monthNotesSection" style="margin-top:16px;background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--card-shadow)">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
  <span style="font-size:1.1rem">ğŸ“</span>
  <span style="font-weight:700;font-size:.9rem;flex:1">×”×¢×¨×•×ª ×œ×—×•×“×©</span>
  <span id="notesLastSaved" style="font-size:.7rem;color:var(--text-light)"></span>
</div>
<textarea id="monthNotes" class="month-notes" placeholder="×›×ª×‘×• ×”×¢×¨×•×ª, ×ª×–×›×•×¨×•×ª ××• ×”×•×“×¢×•×ª...&#10;×œ×“×•×’××”: ×œ×©×œ× ××¨× ×•× ×” ×¢×“ ×”-15, ×—×ª×•× ×” ×©×œ ×“× ×” ×‘×©×™×©×™" oninput="saveMonthNotes()"></textarea>
</div>
</div>

<!-- Tab 2: Dashboard -->
<div class="tab-content" id="tab-dashboard">
<div style="display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap">
<div style="display:flex;border-radius:8px;overflow:hidden;border:1px solid var(--border)">
<button class="dash-view-btn active" id="dashViewMonth" onclick="switchDashView('month')">×—×•×“×©×™</button>
<button class="dash-view-btn" id="dashViewYear" onclick="switchDashView('year')">×©× ×ª×™</button>
</div>
<div class="month-selector" id="dashMonthlySelectors" style="margin-bottom:0;flex:1">
<label>ğŸ“…</label>
<select id="dashMonthSelect" onchange="updateDashboard()"></select>
<input type="number" id="dashYearInput" min="2020" max="2040" onchange="updateDashboard()">
</div>
<div id="dashYearlySelectors" style="display:none;gap:8px;align-items:center;flex:1">
<label>ğŸ“… ×©× ×”</label>
<input type="number" id="dashYearlyYear" min="2020" max="2040" value="2026" onchange="updateYearlyDashboard()">
<label style="margin-right:12px">×”×©×•×•××” ×œ</label>
<input type="number" id="dashYearlyCompare" min="2020" max="2040" value="2025" onchange="updateYearlyDashboard()">
</div>
</div>
<!-- Monthly dashboard -->
<div id="dashMonthlyView">
<div class="kpi-grid" id="kpiGrid"></div>
<div class="chart-grid" id="dashCharts">
<div class="chart-card"><h3>ğŸ© ×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª</h3><div class="chart-wrapper"><canvas id="chartDoughnut"></canvas></div></div>
<div class="chart-card"><h3>ğŸ“Š ×ª×§×¦×™×‘ ××•×œ ×‘×™×¦×•×¢</h3><div class="chart-wrapper"><canvas id="chartBar"></canvas></div></div>
<div class="chart-card"><h3>ğŸ“ˆ ××’××ª ×—×™×¡×›×•×Ÿ</h3><div class="chart-wrapper"><canvas id="chartLine"></canvas></div></div>
<div class="chart-card"><h3>ğŸ“‰ ×”×•×¦××•×ª ×—×•×“×©×™×•×ª</h3><div class="chart-wrapper"><canvas id="chartStacked"></canvas></div></div>
<div class="chart-card" id="childrenChartCard" style="display:none"><h3>ğŸ‘¶ ×”×•×¦××•×ª ×™×œ×“×™×</h3><div class="chart-wrapper"><canvas id="chartChildren"></canvas></div></div>
<div class="chart-card" id="petChartCard" style="display:none"><h3>ğŸ• ×”×•×¦××•×ª ×—×™×•×ª ××—××“</h3><div class="chart-wrapper"><canvas id="chartPet"></canvas></div></div>
<div class="chart-card"><h3>ğŸ“… ××’××ª ×”×›× ×¡×•×ª ×•×”×•×¦××•×ª ×©× ×ª×™×ª</h3><div class="chart-wrapper"><canvas id="chartYearly"></canvas></div></div>
<div class="chart-card" id="savingsChartCard"><h3>ğŸ’° ×”×¤×§×“×•×ª ×—×™×¡×›×•×Ÿ</h3><div class="chart-wrapper"><canvas id="chartSavings"></canvas></div></div>
<div class="chart-card"><h3>ğŸ¥ ×‘×¨×™××•×ª ×¤×™× × ×¡×™×ª</h3><div id="healthScoreContainer"></div></div>
<div class="chart-card"><h3>ğŸ‘« ×”×©×•×•××” ××™×©×™×ª</h3><div id="comparisonContainer"></div></div>
</div>
</div>
<!-- Yearly dashboard -->
<div id="dashYearlyView" style="display:none">
<div class="kpi-grid" id="yearlyKpiGrid"></div>
<div class="chart-grid" id="yearlyCharts">
<div class="chart-card"><h3>ğŸ“… ×”×›× ×¡×•×ª ×•×”×•×¦××•×ª â€” ×”×©×•×•××” ×©× ×ª×™×ª</h3><div class="chart-wrapper"><canvas id="chartYearCompare"></canvas></div></div>
<div class="chart-card"><h3>ğŸ’° ×—×™×¡×›×•×Ÿ ×—×•×“×©×™ â€” ×”×©×•×•××” ×©× ×ª×™×ª</h3><div class="chart-wrapper"><canvas id="chartYearSavings"></canvas></div></div>
<div class="chart-card"><h3>ğŸ© ×”×ª×¤×œ×’×•×ª ×”×•×¦××•×ª ×©× ×ª×™×ª</h3><div class="chart-wrapper"><canvas id="chartYearDoughnut"></canvas></div></div>
<div class="chart-card"><h3>ğŸ“Š ×”×•×¦××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×” â€” ×”×©×•×•××” ×©× ×ª×™×ª</h3><div class="chart-wrapper"><canvas id="chartYearCatCompare"></canvas></div></div>
</div>
<div class="chart-card" style="margin-top:12px"><h3>ğŸ“‹ ×¡×™×›×•× ×—×•×“×©×™</h3><div id="yearlyMonthTable"></div></div>
</div>
</div>

<!-- Tab 3: Savings -->
<div class="tab-content" id="tab-savings">
<div class="kpi-grid" id="savingsKpis"></div>
<div id="savingsContent"></div>
</div>

<!-- Tab 4: Management -->
<div class="tab-content" id="tab-manage">
<div class="section-title">ğŸ› ï¸ ×™×™×‘×•×/×™×™×¦×•×</div>
<div class="dm-grid">
<button class="dm-btn" onclick="downloadFullBackup()" style="border-color:var(--primary)"><span class="dm-icon">ğŸ’¾</span><span class="dm-label">×’×™×‘×•×™ ××œ×</span></button>
<button class="dm-btn" onclick="exportJSON()"><span class="dm-icon">ğŸ“¥</span><span class="dm-label">JSON ×—×•×“×©×™</span></button>
<button class="dm-btn" onclick="document.getElementById('importInput').click()"><span class="dm-icon">ğŸ“¤</span><span class="dm-label">×™×™×‘×•× JSON</span></button>
<button class="dm-btn" onclick="exportExcel('month')"><span class="dm-icon">ğŸ“—</span><span class="dm-label">××§×¡×œ ×—×•×“×©×™</span></button>
<button class="dm-btn" onclick="exportExcel('year')"><span class="dm-icon">ğŸ“—</span><span class="dm-label">××§×¡×œ ×©× ×ª×™</span></button>
<button class="dm-btn" onclick="document.getElementById('excelImportInput').click()"><span class="dm-icon">ğŸ“˜</span><span class="dm-label">×˜×¢×™× ×ª ××§×¡×œ</span></button>
<button class="dm-btn" onclick="downloadImportTemplate()"><span class="dm-icon">ğŸ“„</span><span class="dm-label">×ª×‘× ×™×ª ×œ×™×™×‘×•×</span></button>
<button class="dm-btn" onclick="exportCSV()"><span class="dm-icon">ğŸ“‘</span><span class="dm-label">CSV</span></button>
<button class="dm-btn" onclick="showResetModal()"><span class="dm-icon">ğŸ—‘ï¸</span><span class="dm-label">××™×¤×•×¡ ×—×•×“×©</span></button>
<button class="dm-btn" onclick="showCopyModal()"><span class="dm-icon">ğŸ“‹</span><span class="dm-label">×”×¢×ª×§×ª ×ª×§×¦×™×‘</span></button>
<button class="dm-btn" onclick="exportTemplate()"><span class="dm-icon">ğŸ”—</span><span class="dm-label">×©×ª×£ ×ª×‘× ×™×ª</span></button>
<button class="dm-btn" onclick="document.getElementById('bankFileInput').click()"><span class="dm-icon">ğŸ¦</span><span class="dm-label">×˜×¢×™× ×ª ×“×£ ×—×©×‘×•×Ÿ</span></button>
<button class="dm-btn" onclick="exportPDF('month')"><span class="dm-icon">ğŸ“„</span><span class="dm-label">PDF ×—×•×“×©×™</span></button>
<button class="dm-btn" onclick="exportPDF('year')"><span class="dm-icon">ğŸ“„</span><span class="dm-label">PDF ×©× ×ª×™</span></button>
</div>
<input type="file" id="importInput" accept=".json" style="display:none" onchange="importJSON(event)">
<input type="file" id="excelImportInput" accept=".xlsx,.xls" style="display:none" onchange="importExcel(event)">
<input type="file" id="bankFileInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="importBankStatement(event)">

<div id="adminPanel"></div>

<div class="section-title">ğŸ“Š ×¡×™×›×•× ×—×•×“×©×™×</div>
<div style="overflow-x:auto">
<table class="summary-table" id="allMonthsTable">
<thead><tr><th>×—×•×“×©</th><th>×”×›× ×¡×•×ª</th><th>×”×•×¦××•×ª</th><th>×—×™×¡×›×•×Ÿ</th><th>×”×¤×§×“×•×ª</th></tr></thead>
<tbody id="allMonthsBody"></tbody>
</table>
</div>
</div>

<script>
// ===== CONSTANTS =====
const HM = ['×™× ×•××¨','×¤×‘×¨×•××¨','××¨×¥','××¤×¨×™×œ','×××™','×™×•× ×™','×™×•×œ×™','××•×’×•×¡×˜','×¡×¤×˜××‘×¨','××•×§×˜×•×‘×¨','× ×•×‘××‘×¨','×“×¦××‘×¨'];
const SK = 'familyBudget_v2';
const CC = ['#2563EB','#7C3AED','#DB2777','#EA580C','#16A34A','#0891B2','#6D28D9','#BE185D','#059669','#D97706'];

const DEF_CATS = [
  {id:'housing',name:'×“×™×•×¨',icon:'ğŸ ',items:['×©×›×¨ ×“×™×¨×”','××¨× ×•× ×”','××™×','×—×©××œ','×•×¢×“ ×‘×™×ª','×’×–','××™× ×˜×¨× ×˜','××©×›× ×ª×']},
  {id:'transport',name:'×¨×›×‘ ×•×ª×—×‘×•×¨×”',icon:'ğŸš—',items:['×“×œ×§','×‘×™×˜×•×— ×¨×›×‘','×ª×—×‘"×¦','×˜×¡×˜','××•×¡×š ×•×˜×™×¤×•×œ×™×','×—× ×™×”']},
  {id:'food',name:'××–×•×Ÿ ×•×¤××¨××”',icon:'ğŸ›’',items:['×¡×•×¤×¨','×¤××¨×']},
  {id:'grooming',name:'×˜×™×¤×•×— ×•×›×•×©×¨',icon:'ğŸ’‡',items:['×ª×¡×¤×•×¨×ª','×‘×™×’×•×“','×›×•×©×¨']},
  {id:'entertainment',name:'×‘×™×œ×•×™×™×',icon:'ğŸ‰',items:['×‘×™×œ×•×™×™× ××©×•×ª×¤×™×']},
  {id:'insurance',name:'×‘×™×˜×•×—×™×',icon:'ğŸ›¡ï¸',items:['×‘×™×˜×•×— ×‘×¨×™××•×ª','×‘×™×˜×•×— ×—×™×™×','×‘×™×˜×•×— ×“×™×¨×”','×‘×™×˜×•×— ×¨×›×‘','×‘×™×˜×•×— ×¡×™×¢×•×“×™','×‘×™×˜×•×— × ×¡×™×¢×•×ª']},
  {id:'savings',name:'×—×¡×›×•× ×•×ª',icon:'ğŸ¦',items:['×§×¨×Ÿ ×¤× ×¡×™×”','×§×¨×Ÿ ×”×©×ª×œ××•×ª','×§×•×¤×ª ×’××œ','×‘×™×˜×•×— ×× ×”×œ×™×','×—×™×¡×›×•×Ÿ ×—×•×“×©×™','×§×¨×Ÿ ×œ×™××•×“×™× ×œ×™×œ×“×™×']},
  {id:'subscriptions',name:'××™× ×•×™×™×',icon:'ğŸ“±',items:['× ×˜×¤×œ×™×§×¡','ChatGPT','Google One','YouTube Premium','×¡×¤×•×˜×™×¤×™×™']},
  {id:'pet',name:'×—×™×•×ª ××—××“',icon:'ğŸ•',items:['×‘×™×˜×•×—','××•×›×œ','×•×˜×¨×™× ×¨ ×•×ª×¨×•×¤×•×ª']},
  {id:'children',name:'×™×œ×“×™×',icon:'ğŸ‘¶',items:[],isChildrenCategory:true},
  {id:'events',name:'××™×¨×•×¢×™×',icon:'ğŸ“…',items:[]},
  {id:'unexpected',name:'×—×¨×™×’×•×ª',icon:'âš¡',items:[]}
];

const CHILD_ITEMS_BY_AGE = {
  baby: ['××¢×•×Ÿ/××©×¤×—×ª×•×Ÿ','×—×™×ª×•×œ×™×','×‘×™×’×•×“','×¨×¤×•××”','×¦×¢×¦×•×¢×™×'],
  preschool: ['×’×Ÿ/×¦×”×¨×•×Ÿ','×—×•×’×™×','×‘×™×’×•×“','×¨×¤×•××”','×¦×¢×¦×•×¢×™×'],
  school: ['×‘×™"×¡/×¦×”×¨×•×Ÿ','×—×•×’×™×','×©×™×¢×•×¨×™× ×¤×¨×˜×™×™×','×‘×™×’×•×“','×¨×¤×•××”','×›×¡×£ ×›×™×¡'],
  teen: ['×‘×™"×¡','×—×•×’×™×/×¡×¤×•×¨×˜','×©×™×¢×•×¨×™× ×¤×¨×˜×™×™×','×‘×™×’×•×“','×¨×¤×•××”','×˜×œ×¤×•×Ÿ','×›×¡×£ ×›×™×¡','×ª×—×‘×•×¨×”']
};
const SHARED_CHILD_ITEMS = ['××•×›×œ ×™×œ×“×™×','×”×¡×¢×•×ª','××—×¨'];

function getChildAgeGroup(age) {
  if (age <= 3) return 'baby';
  if (age <= 6) return 'preschool';
  if (age <= 12) return 'school';
  return 'teen';
}

function getChildDefaultItems(age) {
  return CHILD_ITEMS_BY_AGE[getChildAgeGroup(age)] || CHILD_ITEMS_BY_AGE.school;
}

// ===== STATE =====
let D = null; // main app data
let curMonth = new Date().getMonth();
let curYear = 2026;
let saveTimer = null;
let charts = {};
let wizStep = 0;
let wizData = {};
const undoStack = [];
const UNDO_MAX = 20;

// ===== UTILITY =====
function mk(m,y){return `${y}-${String(m+1).padStart(2,'0')}`}
function fc(n){if(!n&&n!==0)return 'â‚ª 0';return 'â‚ª '+Math.round(n).toLocaleString('he-IL')}
function toast(m){const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500)}
function showModal(h){document.getElementById('modalContent').innerHTML=h;document.getElementById('modalOverlay').classList.add('active')}
function closeModal(){document.getElementById('modalOverlay').classList.remove('active')}
document.getElementById('modalOverlay').addEventListener('click',function(e){if(e.target===this)closeModal()});
// Enter key submits modal primary button, Escape closes modal
document.addEventListener('keydown',function(e){
  if(!document.getElementById('modalOverlay').classList.contains('active'))return;
  if(e.key==='Enter'&&document.activeElement.tagName!=='TEXTAREA'){
    const primary=document.querySelector('#modalContent .modal-btn.primary');
    if(primary&&!e.shiftKey){e.preventDefault();primary.click()}
  }
  if(e.key==='Escape'){closeModal()}
});
// Ctrl+Z undo
document.addEventListener('keydown',function(e){
  if((e.ctrlKey||e.metaKey)&&e.key==='z'&&!e.shiftKey){
    const tag=document.activeElement.tagName;
    if(tag==='INPUT'||tag==='TEXTAREA'||tag==='SELECT')return;
    e.preventDefault();undo();
  }
});

function uid(){return 'id_'+Math.random().toString(36).substr(2,9)}
function esc(s){return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}

// ===== OWNER HELPERS =====
function ownerBadge(owner, catName, idx, type){
  if(D.config.soloMode)return '';
  const p1i=(D.config.partner1||'?')[0];
  const p2i=(D.config.partner2||'?')[0];
  const cls=owner==='partner1'?'p1':owner==='partner2'?'p2':'shared';
  const label=owner==='partner1'?p1i:owner==='partner2'?p2i:'ğŸ¤';
  const onclick=type==='expense'
    ?`cycleOwner(this.closest('[data-cat]').dataset.cat,${idx})`
    :type==='income'
    ?`cycleIncOwner(${idx})`
    :'';
  return `<span class="owner-badge ${cls}" onclick="${onclick}" title="${esc(ownerName(owner))}">${label}</span>`;
}
function ownerName(o){return o==='partner1'?(D.config.partner1||'×©×•×ª×£ 1'):o==='partner2'?(D.config.partner2||'×©×•×ª×£ 2'):'××©×•×ª×£'}
function nextOwner(o){
  if(D.config.soloMode)return o==='shared'?'partner1':'shared';
  return o==='shared'?'partner1':o==='partner1'?'partner2':'shared';
}
function ownerSelectOpts(selected,p1,p2){
  let h=`<option value="shared"${selected==='shared'?' selected':''}>ğŸ¤ ××©×•×ª×£</option><option value="partner1"${selected==='partner1'?' selected':''}>${esc(p1)}</option>`;
  if(!D.config.soloMode)h+=`<option value="partner2"${selected==='partner2'?' selected':''}>${esc(p2)}</option>`;
  return h;
}
function cycleOwner(catName,idx){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[catName].items[idx];
  item.owner=nextOwner(item.owner||'shared');
  saveData();renderBudgetKeepOpen();
}
function cycleIncOwner(idx){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  data.income[idx].owner=nextOwner(data.income[idx].owner||'shared');
  saveData();renderBudgetKeepOpen();
}
function ownerLegend(){
  if(D.config.soloMode)return '';
  const p1i=(D.config.partner1||'?')[0],p2i=(D.config.partner2||'?')[0];
  return `<div class="owner-legend">
    <span class="owner-badge p1">${p1i}</span>${D.config.partner1||'×©×•×ª×£ 1'}
    <span class="owner-badge p2">${p2i}</span>${D.config.partner2||'×©×•×ª×£ 2'}
    <span class="owner-badge shared">ğŸ¤</span>××©×•×ª×£
    <span style="margin-right:8px;opacity:.6">(×œ×—×¦×• ×œ×©× ×•×ª)</span>
  </div>`;
}

// ===== DATA MODEL =====
function freshData(){
  return {
    config:{
      partner1:'',partner2:'',soloMode:false,
      children:[],
      pet:{name:'',enabled:false},
      categories:DEF_CATS.map((c,i)=>({...c,order:i,items:c.items.map(n=>({name:n,isDefault:true}))})),
      incomeSources:[],
      events:[]
    },
    months:{},
    savings:{
      emergency:{target:0,current:0,monthlyContribution:0},
      goals:[],
      childrenSavings:[],
      fixedSavings:[],
      completedGoals:[]
    },
    settings:{darkMode:false,setupComplete:false,currency:'â‚ª',dismissedAlerts:[],subtitle:''}
  };
}

// ===== PERSISTENCE & MIGRATION =====
function loadData(){
  // This function is now a wrapper - use loadDataLocal() for localStorage
  loadDataLocal();
}

function migrateV1(old){
  const nd=freshData();
  nd.months=old.months||{};
  nd.settings.setupComplete=true;
  // Try to detect partner names from income
  const anyMonth=Object.values(nd.months)[0];
  if(anyMonth&&anyMonth.income){
    anyMonth.income.forEach(inc=>{
      if(inc.source&&inc.source.includes('×©×—×¨'))nd.config.partner1='×©×—×¨';
      if(inc.source&&inc.source.includes('×¨×•×ª×'))nd.config.partner2='×¨×•×ª×';
    });
  }
  if(!nd.config.partner1)nd.config.partner1='×©×—×¨';
  if(!nd.config.partner2)nd.config.partner2='×¨×•×ª×';
  // Detect pet
  Object.values(nd.months).forEach(m=>{
    if(m.expenses&&m.expenses['××•×œ×™×‘×¨']){
      nd.config.pet={name:'××•×œ×™×‘×¨',enabled:true};
      // rename to pet category
      Object.values(nd.months).forEach(mo=>{
        if(mo.expenses&&mo.expenses['××•×œ×™×‘×¨']){
          mo.expenses['×—×™×•×ª ××—××“']=mo.expenses['××•×œ×™×‘×¨'];
          delete mo.expenses['××•×œ×™×‘×¨'];
        }
      });
    }
  });
  // Copy categories structure from first month if available
  if(anyMonth&&anyMonth.expenses){
    Object.keys(anyMonth.expenses).forEach(catName=>{
      const existing=nd.config.categories.find(c=>c.name===catName);
      if(!existing&&catName!=='××•×œ×™×‘×¨'){
        nd.config.categories.push({id:uid(),name:catName,icon:'ğŸ“',order:nd.config.categories.length,items:
          (anyMonth.expenses[catName].items||[]).map(i=>({name:i.name,isDefault:i.isDefault!==false}))
        });
      }
    });
  }
  Object.assign(D,nd);
}

function pushUndo(){
  try{
    undoStack.push(JSON.stringify(D));
    if(undoStack.length>UNDO_MAX)undoStack.shift();
    const btn=document.getElementById('undoBtn');
    if(btn)btn.style.display='flex';
  }catch(e){}
}
function undo(){
  if(undoStack.length===0){toast('××™×Ÿ ×¤×¢×•×œ×•×ª ×œ×‘×™×˜×•×œ');return}
  // Save current UI state
  const expanded=new Set();
  document.querySelectorAll('.category-card.expanded').forEach(c=>{
    const cat=c.getAttribute('data-cat');if(cat)expanded.add(cat);
  });
  const activeTab=document.querySelector('.tab-btn.active')?.getAttribute('data-tab')||'budget';
  const prev=undoStack.pop();
  try{
    D=JSON.parse(prev);
    clearTimeout(saveTimer);
    try{localStorage.setItem(SK,JSON.stringify(D))}catch(e){}
    if(fbRef&&fbUser){fbRef.set(D).catch(()=>{})}
    initApp();
    // Restore tab
    if(activeTab)switchTab(activeTab);
    // Restore expanded categories
    if(expanded.size>0){
      document.querySelectorAll('.category-card').forEach(c=>{
        const cat=c.getAttribute('data-cat');
        if(cat&&expanded.has(cat))c.classList.add('expanded');
      });
    }
    toast('â†©ï¸ ×”×¤×¢×•×œ×” ×”××—×¨×•× ×” ×‘×•×˜×œ×”');
  }catch(e){toast('×©×’×™××” ×‘×‘×™×˜×•×œ')}
  if(undoStack.length===0){
    const btn=document.getElementById('undoBtn');
    if(btn)btn.style.display='none';
  }
}
function saveData(){
  clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{
    try{localStorage.setItem(SK,JSON.stringify(D))}catch(e){console.error('Save error:',e)}
    if(fbRef&&fbUser){
      skipFirebaseSync=true;
      fbRef.set(D).then(()=>{
        fbDb.ref('families/'+fbFamilyId+'/meta').update({
          lastEditedBy:fbUser.uid,
          lastEditedByName:fbUser.displayName||'',
          lastEditedAt:firebase.database.ServerValue.TIMESTAMP
        });
        setTimeout(()=>{skipFirebaseSync=false},500);
      }).catch(e=>{console.warn('Firebase save failed:',e);skipFirebaseSync=false});
    }
  },500);
}

// ===== MONTH DATA =====
function generateChildrenItems(){
  const items=[];
  if(!D.config.children||D.config.children.length===0)return items;
  D.config.children.forEach(child=>{
    const defs=getChildDefaultItems(child.age||5);
    defs.forEach(base=>{
      items.push({name:`${base} ${child.name}`,amount:0,isDefault:true,childId:child.id});
    });
  });
  SHARED_CHILD_ITEMS.forEach(name=>{
    items.push({name,amount:0,isDefault:true,childId:'shared'});
  });
  return items;
}

function findPreviousMonth(key){
  const[y,m]=key.split('-').map(Number);
  // Search up to 12 months back to find nearest existing month
  for(let i=1;i<=12;i++){
    let pm=m-i,py=y;
    while(pm<1){pm+=12;py--}
    const pk=`${py}-${String(pm).padStart(2,'0')}`;
    if(D.months[pk])return pk;
  }
  return null;
}
function getMonth(key){
  if(!D.months[key]){
    D.months[key]={expenses:{},income:[],misc:{'×©×•×‘×¨×™×':0,'×§×•×¤×” ×§×˜× ×”':0},savingsContributions:{}};
    // Find previous month to carry over fixed items
    const prevKey=findPreviousMonth(key);
    const prevMonth=prevKey?D.months[prevKey]:null;
    const cats=D.config.categories||[];
    cats.forEach(cat=>{
      if(cat.isChildrenCategory){
        D.months[key].expenses[cat.name]={budget:0,items:generateChildrenItems()};
      }else{
        const defaultItems=(cat.items||[]).map(it=>{const o={name:it.name,amount:0,isDefault:it.isDefault!==false};if(it.provider)o.provider=it.provider;return o});
        // Carry over fixed items from previous month
        let categoryBudget=0;
        if(prevMonth&&prevMonth.expenses&&prevMonth.expenses[cat.name]){
          categoryBudget=prevMonth.expenses[cat.name].budget||0;
          const prevItems=prevMonth.expenses[cat.name].items||[];
          prevItems.forEach(pi=>{
            if(pi.fixed){
              const existing=defaultItems.find(di=>di.name===pi.name);
              if(existing){
                existing.amount=pi.amount||0;
                existing.fixed=true;
                existing.owner=pi.owner;
              }else{
                defaultItems.push({name:pi.name,amount:pi.amount||0,isDefault:false,fixed:true,owner:pi.owner});
              }
            }
          });
        }
        D.months[key].expenses[cat.name]={budget:categoryBudget,items:defaultItems};
      }
    });
    // Add default income sources
    if(D.config.incomeSources&&D.config.incomeSources.length>0){
      D.months[key].income=D.config.incomeSources.map(s=>({source:s.name,amount:s.defaultAmount||0}));
    }
    // Carry over fixed income from previous month
    if(prevMonth&&prevMonth.income){
      prevMonth.income.forEach(pi=>{
        if(pi.fixed){
          const existing=D.months[key].income.find(i=>i.source===pi.source);
          if(existing){existing.amount=pi.amount||0;existing.fixed=true;existing.owner=pi.owner}
          else{D.months[key].income.push({source:pi.source,amount:pi.amount||0,owner:pi.owner,fixed:true})}
        }
      });
    }
    saveData();
  }
  // Ensure all current categories exist in month
  const md=D.months[key];
  (D.config.categories||[]).forEach(cat=>{
    if(!md.expenses[cat.name]){
      if(cat.isChildrenCategory){
        md.expenses[cat.name]={budget:0,items:generateChildrenItems()};
      }else{
        md.expenses[cat.name]={budget:0,items:(cat.items||[]).map(it=>({name:it.name,amount:0,isDefault:it.isDefault!==false}))};
      }
    }
  });
  if(!md.savingsContributions)md.savingsContributions={};
  if(!md.misc||typeof md.misc!=='object')md.misc={};
  // Inject event items for this month
  const [,evMStr]=key.split('-');
  const evMNum=parseInt(evMStr);
  (D.config.events||[]).forEach(evt=>{
    if(!evt.enabled||evt.month!==evMNum)return;
    const evCat=md.expenses['××™×¨×•×¢×™×'];
    if(!evCat)return;
    if(evCat.items.some(i=>i.eventId===evt.id))return;
    evCat.items.push({name:(evt.emoji||'ğŸ“…')+' '+evt.name,amount:evt.estimatedBudget||0,isDefault:false,isEvent:true,eventId:evt.id,owner:evt.owner||'shared'});
  });
  return md;
}

function calcTotals(key){
  const d=D.months[key];
  if(!d)return{income:0,expenses:0,savings:0,deposits:0,budget:0};
  let inc=0,exp=0,dep=0,bud=0;
  (d.income||[]).forEach(i=>inc+=(i.amount||0));
  Object.values(d.expenses||{}).forEach(c=>{
    bud+=(c.budget||0);
    (c.items||[]).forEach(i=>exp+=(i.amount||0));
  });
  Object.values(d.savingsContributions||{}).forEach(v=>dep+=v);
  return{income:inc,expenses:exp,savings:inc-exp,deposits:dep,budget:bud};
}

// ===== SETUP WIZARD =====
const WIZ_STEPS=['welcome','categories','items','personal','events','income','savings','planned','done'];

function showWizard(){
  wizStep=0;
  const isRerun=D&&D.settings&&D.settings.setupComplete;
  if(isRerun){
    // Re-running: merge existing categories with defaults
    const existingCats=D.config.categories||[];
    const existingIds=new Set(existingCats.map(c=>c.id));
    const mergedCats=existingCats.map(c=>({...c,enabled:true,items:(c.items||[]).map(i=>typeof i==='string'?i:i.name)}));
    // Add new default categories not yet in config
    DEF_CATS.forEach(dc=>{
      if(!existingIds.has(dc.id)){
        mergedCats.push({...dc,enabled:dc.id!=='children',items:[...dc.items]});
      }
    });
    wizData={
      startMode:'new',
      categories:mergedCats,
      partner1:D.config.partner1||'',
      partner2:D.config.partner2||'',
      hasChildren:(D.config.children||[]).length>0,
      children:[...(D.config.children||[])],
      hasPet:D.config.pet&&D.config.pet.enabled,
      petName:(D.config.pet&&D.config.pet.name)||'',
      incomeSources:[...(D.config.incomeSources||[])],
      savingsGoals:[...(D.savings.goals||[])],
      hasEmergency:!!(D.savings.emergency&&D.savings.emergency.target>0),
      emergencyTarget:(D.savings.emergency&&D.savings.emergency.target)||0,
      events:[...(D.config.events||[])],
      soloMode:!D.config.partner2
    };
  }else{
    wizData={
      startMode:'new',
      categories:DEF_CATS.map(c=>({...c,enabled:c.id!=='children',items:[...c.items]})),
      partner1:'',partner2:'',
      hasChildren:false,children:[],
      hasPet:false,petName:'',
      incomeSources:[],
      savingsGoals:[],
      hasEmergency:true,emergencyTarget:0,
      events:[],
      soloMode:false
    };
  }
  document.getElementById('wizardOverlay').classList.remove('hidden');
  document.getElementById('tabBar').style.display='none';
  document.getElementById('summaryBar').style.display='none';
  hideLoadingScreen();
  renderWizardStep();
}

function hideWizard(){
  document.getElementById('wizardOverlay').classList.add('hidden');
  document.getElementById('tabBar').style.display='';
  document.getElementById('summaryBar').style.display='';
}
function cancelWizard(){
  if(D&&D.settings&&D.settings.setupComplete){hideWizard();toast('×”××©×£ ×‘×•×˜×œ')}
  else{showModal(`<h3>âš ï¸ ×‘×™×˜×•×œ ×”××©×£</h3><p>×”×× ×œ×‘×˜×œ ××ª ×”×’×“×¨×ª ×”×ª×§×¦×™×‘?</p>
    <div class="modal-actions"><button class="modal-btn danger" onclick="D.settings.setupComplete=true;saveData();hideWizard();closeModal();initApp()">×‘×˜×œ ×•×¦×</button><button class="modal-btn cancel" onclick="closeModal()">×”××©×š ×‘×”×’×“×¨×”</button></div>`)}
}

function showWizardJoinCode(){
  const c=document.getElementById('wizardContent');
  c.innerHTML=`<div class="wizard-step">
    <div style="text-align:center;font-size:3rem;margin:20px 0">ğŸ”—</div>
    <div class="wizard-title">×”×¦×˜×¨×¤×•×ª ×œ×ª×§×¦×™×‘ ×§×™×™×</div>
    <div class="wizard-subtitle">×”×›× ×™×¡×• ××ª ×§×•×“ ×”×”×–×× ×” ×©×§×™×‘×œ×ª×</div>
    ${fbUser?'':`<div style="background:var(--warning-bg);padding:12px;border-radius:var(--radius-sm);margin-bottom:12px;font-size:.85rem;color:#92400E">âš ï¸ ×™×© ×œ×”×ª×—×‘×¨ ×¢× Google ×ª×—×™×œ×” ×›×“×™ ×œ×”×¦×˜×¨×£ ×œ×ª×§×¦×™×‘ ××©×•×ª×£.
      <button class="btn-sm primary" style="margin-top:8px;display:block" onclick="hideWizard();showLoginScreen()">ğŸ”‘ ×”×ª×—×‘×¨×•×ª ×¢× Google</button></div>`}
    <div class="modal-field"><input class="modal-input ltr" id="wizJoinCode" placeholder="XXXXXXXX" maxlength="8" style="text-align:center;font-size:1.8rem;letter-spacing:6px;font-weight:700;text-transform:uppercase;padding:14px" ${fbUser?'':'disabled'}></div>
    <div id="wizJoinStatus" style="margin-top:8px;font-size:.85rem;color:var(--danger);text-align:center"></div>
    <button class="modal-btn primary" style="margin-top:16px;width:100%" onclick="wizardJoinWithCode()" ${fbUser?'':'disabled'}>×”×¦×˜×¨×£ ×œ×ª×§×¦×™×‘ â†’</button>
    <button class="modal-btn cancel" style="margin-top:8px;width:100%" onclick="renderWizardStep()">â† ×—×–×¨×”</button>
  </div>`;
  setTimeout(()=>{const i=document.getElementById('wizJoinCode');if(i)i.focus()},250);
}
async function wizardJoinWithCode(){
  const code=(document.getElementById('wizJoinCode').value||'').trim().toUpperCase();
  const status=document.getElementById('wizJoinStatus');
  if(code.length<6||code.length>8){status.textContent='×”×§×•×“ ×—×™×™×‘ ×œ×”×™×•×ª 6-8 ×ª×•×•×™×';return}
  if(!fbUser||!fbDb){status.textContent='×™×© ×œ×”×ª×—×‘×¨ ×¢× Google ×ª×—×™×œ×”';return}
  status.style.color='var(--primary)';status.textContent='××—×¤×©...';
  try{
    const snap=await fbDb.ref('invites/'+code).once('value');
    if(!snap.exists()){status.style.color='var(--danger)';status.textContent='×§×•×“ ×œ× × ××¦×. ×‘×“×§×• ×©×”×•×¢×ª×§ × ×›×•×Ÿ';return}
    const inv=resolveInvite(snap.val());
    if(inv.expired){await fbDb.ref('invites/'+code).remove();status.style.color='var(--danger)';status.textContent='×§×•×“ ×”×”×–×× ×” ×¤×’ ×ª×•×§×£ (72 ×©×¢×•×ª). ×‘×§×©×• ×§×•×“ ×—×“×©';return}
    fbFamilyId=inv.familyId;
    let familyName='×ª×§×¦×™×‘';
    try{const ms=await fbDb.ref('families/'+fbFamilyId+'/meta/name').once('value');if(ms.exists())familyName=ms.val();}catch(e){}
    await fbDb.ref('families/'+fbFamilyId+'/members/'+fbUser.uid).set({
      email:fbUser.email,displayName:fbUser.displayName||'',photoURL:fbUser.photoURL||'',
      partnerSlot:2,online:true,lastSeen:firebase.database.ServerValue.TIMESTAMP
    });
    await fbDb.ref('userFamilies/'+fbUser.uid+'/families/'+fbFamilyId).set({name:familyName,role:'member',joinedAt:Date.now()});
    await fbDb.ref('userFamilies/'+fbUser.uid+'/activeFamily').set(fbFamilyId);
    await fbDb.ref('invites/'+code).remove();
    userFamilies.push({familyId:fbFamilyId,name:familyName,role:'member'});
    toast('×”×¦×˜×¨×¤×ª× ×œ×ª×§×¦×™×‘!');
    hideWizard();
    await connectToFamily(fbFamilyId,fbUser);
  }catch(e){
    status.style.color='var(--danger)';
    if(e.code==='PERMISSION_DENIED'||e.message?.includes('permission')||e.message?.includes('Permission')){
      status.innerHTML='ğŸ”’ ××™×Ÿ ×”×¨×©××•×ª. ×‘×§×©×• ××× ×”×œ ×”××©×¤×—×” ×œ×‘×“×•×§ ××ª ×—×•×§×™ ×”××‘×˜×—×” ×‘-Firebase.<br><span style="font-size:.78rem">Firebase Console â†’ Realtime Database â†’ Rules<br>×™×© ×œ×•×•×“× ×©-<code>members/$uid</code> ×××¤×©×¨ ×›×ª×™×‘×” ×¢×¦××™×ª ×•-<code>meta/name</code> ×××¤×©×¨ ×§×¨×™××”.</span>';
    }else{
      status.textContent='×©×’×™××”: '+e.message;
    }
  }
}

function renderWizardStep(){
  const bar=document.getElementById('wizardProgressBar');
  bar.style.width=((wizStep+1)/WIZ_STEPS.length*100)+'%';
  const c=document.getElementById('wizardContent');
  const n=document.getElementById('wizardNav');
  const step=WIZ_STEPS[wizStep];

  // Nav buttons
  let navHtml='';
  if(wizStep>0) navHtml+=`<button class="wn-btn secondary" onclick="wizPrev()">â†’ ×—×–×¨×”</button>`;
  else navHtml+='<span></span>';
  if(wizStep<WIZ_STEPS.length-1){
    if(step==='events'||step==='savings'||step==='planned') navHtml+=`<button class="wn-btn skip" onclick="wizNext()">×“×œ×’</button>`;
    navHtml+=`<button class="wn-btn primary" onclick="wizNext()">×”×‘× â†</button>`;
  }
  n.innerHTML=navHtml;

  switch(step){
    case 'welcome': c.innerHTML=renderWizWelcome(); break;
    case 'categories': c.innerHTML=renderWizCategories(); break;
    case 'items': c.innerHTML=renderWizItems(); break;
    case 'personal': c.innerHTML=renderWizPersonal(); break;
    case 'events': c.innerHTML=renderWizEvents(); break;
    case 'income': c.innerHTML=renderWizIncome(); break;
    case 'savings': c.innerHTML=renderWizSavings(); break;
    case 'planned': c.innerHTML=renderWizPlanned(); break;
    case 'done': c.innerHTML=renderWizDone(); n.innerHTML=`<span></span><button class="wn-btn primary" onclick="finishWizard()">×”×ª×—×œ ×œ× ×”×œ ××ª ×”×ª×§×¦×™×‘ â†’</button>`; break;
  }
}

function wizNext(){
  saveWizardStep();
  if(wizStep<WIZ_STEPS.length-1){wizStep++;renderWizardStep()}
}
function wizPrev(){if(wizStep>0){wizStep--;renderWizardStep()}}

function saveWizardStep(){
  const step=WIZ_STEPS[wizStep];
  switch(step){
    case 'categories':
      document.querySelectorAll('.wiz-cat-check').forEach((el,i)=>{
        wizData.categories[i].enabled=el.checked;
      });
      break;
    case 'personal':
      wizData.partner1=(document.getElementById('wizP1')||{}).value||'';
      wizData.partner2=(document.getElementById('wizP2')||{}).value||'';
      wizData.soloMode=!(document.getElementById('wizHasPartner')||{}).checked;
      wizData.hasPet=!!(document.getElementById('wizHasPet')||{}).checked;
      wizData.petName=(document.getElementById('wizPetName')||{}).value||'';
      wizData.hasChildren=!!(document.getElementById('wizHasChildren')||{}).checked;
      // Collect children
      wizData.children=[];
      document.querySelectorAll('.wiz-child-entry').forEach(el=>{
        const name=el.querySelector('.wiz-child-name').value;
        const age=parseInt(el.querySelector('.wiz-child-age').value)||5;
        if(name.trim()) wizData.children.push({id:uid(),name:name.trim(),age,emoji:age<=3?'ğŸ‘¶':age<=10?'ğŸ‘§':'ğŸ‘¦'});
      });
      // Enable children category if has children
      const childCat=wizData.categories.find(c=>c.id==='children');
      if(childCat) childCat.enabled=wizData.hasChildren&&wizData.children.length>0;
      break;
    case 'events':
      wizData.events=[];
      document.querySelectorAll('.wiz-event-row').forEach(el=>{
        const name=(el.querySelector('.wiz-evt-name')?.value||'').trim();
        if(!name)return;
        wizData.events.push({
          id:uid(),name,
          emoji:(el.querySelector('.wiz-evt-emoji')?.value||'').trim()||'ğŸ“…',
          month:parseInt(el.querySelector('.wiz-evt-month')?.value)||1,
          day:0,
          estimatedBudget:Math.max(0,parseInt(el.querySelector('.wiz-evt-budget')?.value)||0),
          owner:'shared',enabled:true
        });
      });
      break;
    case 'income':
      wizData.incomeSources=[];
      document.querySelectorAll('.wiz-income-row').forEach(el=>{
        const name=el.querySelector('.wiz-inc-name').value;
        const amt=parseInt(el.querySelector('.wiz-inc-amt').value)||0;
        if(name.trim()) wizData.incomeSources.push({name:name.trim(),defaultAmount:amt});
      });
      break;
    case 'savings':
      wizData.hasEmergency=!!(document.getElementById('wizEmergency')||{}).checked;
      wizData.emergencyTarget=parseInt((document.getElementById('wizEmergencyAmt')||{}).value)||0;
      wizData.savingsGoals=[];
      document.querySelectorAll('.wiz-goal-row').forEach(el=>{
        const name=el.querySelector('.wiz-goal-name').value;
        const amt=parseInt(el.querySelector('.wiz-goal-amt').value)||0;
        if(name.trim()) wizData.savingsGoals.push({id:uid(),name:name.trim(),emoji:'ğŸ¯',target:amt,current:0,targetDate:'',monthlyContribution:0,priority:'medium'});
      });
      break;
  }
}

function renderWizWelcome(){
  return `<div class="wizard-step">
    <div style="text-align:center;font-size:3rem;margin:20px 0">ğŸ’°</div>
    <div class="wizard-title">×‘×¨×•×›×™× ×”×‘××™× ×œ×›×œ×™ ×”×ª×§×¦×™×‘ ×”××©×¤×—×ª×™</div>
    <div class="wizard-subtitle">×‘×•××• × ×’×“×™×¨ ××ª ×”×ª×§×¦×™×‘ ×©×œ×›× ×‘×›××” ×¦×¢×“×™× ×¤×©×•×˜×™×</div>
    <div class="wizard-card" onclick="wizData.startMode='new';wizNext()">
      <div class="wc-icon">ğŸ†•</div>
      <div><div class="wc-title">×”×ª×—×œ×” ×××¤×¡</div><div class="wc-desc">×”×’×“×™×¨×• ×§×˜×’×•×¨×™×•×ª, ×¤×¨×™×˜×™× ×•×”×›× ×¡×•×ª</div></div>
    </div>
    <div class="wizard-card" onclick="document.getElementById('excelImportInput').click()">
      <div class="wc-icon">ğŸ“—</div>
      <div><div class="wc-title">×˜×¢×™× ×” ×××§×¡×œ</div><div class="wc-desc">×™×™×‘×•× ××§×•×‘×¥ Excel ×§×™×™×</div></div>
    </div>
    <div class="wizard-card" onclick="document.getElementById('importInput').click()">
      <div class="wc-icon">ğŸ“¥</div>
      <div><div class="wc-title">×™×™×‘×•× ×-JSON</div><div class="wc-desc">×˜×¢×™× ×ª ×’×™×‘×•×™ ××• ×ª×‘× ×™×ª</div></div>
    </div>
    <div class="wizard-card" onclick="showWizardJoinCode()">
      <div class="wc-icon">ğŸ”—</div>
      <div><div class="wc-title">×”×¦×˜×¨×¤×•×ª ×¢× ×§×•×“</div><div class="wc-desc">×§×™×‘×œ×ª× ×§×•×“ ×”×–×× ×”? ×”×›× ×™×¡×• ××•×ª×• ×›××Ÿ</div></div>
    </div>
  </div>`;
}

function renderWizCategories(){
  return `<div class="wizard-step">
    <div class="wizard-title">×”×’×“×¨×ª ×§×˜×’×•×¨×™×•×ª ğŸ“‚</div>
    <div class="wizard-subtitle">×‘×—×¨×• ××™×œ×• ×§×˜×’×•×¨×™×•×ª ×”×•×¦××•×ª ×¨×œ×•×•× ×˜×™×•×ª ×¢×‘×•×¨×›×</div>
    ${wizData.categories.map((c,i)=>`
      <label class="wizard-check ${c.enabled?'checked':''}" onclick="this.classList.toggle('checked')">
        <input type="checkbox" class="wiz-cat-check" ${c.enabled?'checked':''} onchange="this.parentElement.classList.toggle('checked',this.checked)">
        <span class="wch-icon">${c.icon}</span>
        <span class="wch-text">${c.name}</span>
      </label>
    `).join('')}
    <button class="add-item-btn" onclick="addWizCategory()">+ ×”×•×¡×£ ×§×˜×’×•×¨×™×”</button>
  </div>`;
}

function addWizCategory(){
  const name=prompt('×©× ×”×§×˜×’×•×¨×™×”:');
  if(!name||!name.trim())return;
  const emoji=prompt('××™××•×’\'×™ (××•×¤×¦×™×•× ×œ×™):','ğŸ“')||'ğŸ“';
  wizData.categories.push({id:uid(),name:name.trim(),icon:emoji,enabled:true,items:[]});
  renderWizardStep();
}

function renderWizItems(){
  return `<div class="wizard-step">
    <div class="wizard-title">×”×’×“×¨×ª ×¤×¨×™×˜×™× ğŸ“</div>
    <div class="wizard-subtitle">×›×œ ×§×˜×’×•×¨×™×” ××›×™×œ×” ×¤×¨×™×˜×™ ×”×•×¦××”. ××¤×©×¨ ×œ×¢×¨×•×š ×‘×›×œ ×–××Ÿ</div>
    ${wizData.categories.filter(c=>c.enabled&&!c.isChildrenCategory).map((cat,ci)=>`
      <div class="wizard-items-card">
        <div class="wizard-items-header" onclick="this.nextElementSibling.style.display=this.nextElementSibling.style.display==='none'?'block':'none'">
          ${cat.icon} ${cat.name} (${cat.items.length} ×¤×¨×™×˜×™×)
        </div>
        <div class="wizard-items-body">
          ${cat.items.map((item,ii)=>`
            <span class="item-tag active">${typeof item==='string'?item:item.name} <span class="tag-x" onclick="wizData.categories[${wizData.categories.indexOf(cat)}].items.splice(${ii},1);renderWizardStep()">âœ•</span></span>
          `).join('')}
          <span class="item-tag" style="cursor:pointer;border-style:dashed;color:var(--primary)" onclick="addWizItem(${wizData.categories.indexOf(cat)})">+ ×”×•×¡×£</span>
        </div>
      </div>
    `).join('')}
  </div>`;
}

function addWizItem(catIdx){
  const name=prompt('×©× ×”×¤×¨×™×˜:');
  if(!name||!name.trim())return;
  const items=wizData.categories[catIdx].items;
  if(typeof items[0]==='string') items.push(name.trim());
  else items.push({name:name.trim(),isDefault:false});
  renderWizardStep();
}

function renderWizPersonal(){
  const isSolo=wizData.soloMode||false;
  return `<div class="wizard-step">
    <div class="wizard-title">×¤×¨×˜×™× ××™×©×™×™× ğŸ‘¤</div>
    <div class="wizard-subtitle">×”×©××•×ª ×™×©××©×• ×œ×¤×¨×™×˜×™× ××™×©×™×™× ×›××• ×ª×¡×¤×•×¨×ª, ×›×•×©×¨ ×•×‘×™×œ×•×™×™×</div>
    <div class="wizard-field" style="margin-bottom:14px">
      <label class="wizard-check ${isSolo?'':'checked'}" onclick="this.classList.toggle('checked')">
        <input type="checkbox" id="wizHasPartner" ${isSolo?'':'checked'} onchange="this.parentElement.classList.toggle('checked',this.checked);document.getElementById('partner2Field').style.display=this.checked?'block':'none'">
        <span class="wch-icon">ğŸ‘¥</span><span class="wch-text">× ×™×”×•×œ ×ª×§×¦×™×‘ ×¢× ×©×•×ª×£/×”</span>
      </label>
    </div>
    <div class="wizard-field"><label>×”×©× ×©×œ×™</label>
      <input type="text" id="wizP1" value="${wizData.partner1}" placeholder="×œ×“×•×’××”: ×©×—×¨"></div>
    <div id="partner2Field" style="display:${isSolo?'none':'block'}">
    <div class="wizard-field"><label>×©× ×”×©×•×ª×£/×”</label>
      <input type="text" id="wizP2" value="${wizData.partner2}" placeholder="×œ×“×•×’××”: ×¨×•×ª×"></div>
    </div>

    <div class="wizard-field" style="margin-top:20px">
      <label class="wizard-check ${wizData.hasPet?'checked':''}" onclick="this.classList.toggle('checked')">
        <input type="checkbox" id="wizHasPet" ${wizData.hasPet?'checked':''} onchange="this.parentElement.classList.toggle('checked',this.checked);document.getElementById('petNameField').style.display=this.checked?'block':'none'">
        <span class="wch-icon">ğŸ•</span><span class="wch-text">×™×© ×œ× ×• ×—×™×™×ª ××—××“</span>
      </label>
      <div id="petNameField" style="display:${wizData.hasPet?'block':'none'};margin-top:8px">
        <input type="text" id="wizPetName" value="${wizData.petName}" placeholder="×©× ×”×—×™×”" style="padding:10px;border:1px solid var(--border);border-radius:var(--radius-xs);font-family:var(--font);width:100%">
      </div>
    </div>

    <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--border)">
      <label class="wizard-check ${wizData.hasChildren?'checked':''}" onclick="this.classList.toggle('checked')">
        <input type="checkbox" id="wizHasChildren" ${wizData.hasChildren?'checked':''} onchange="this.parentElement.classList.toggle('checked',this.checked);document.getElementById('childrenSection').style.display=this.checked?'block':'none'">
        <span class="wch-icon">ğŸ‘¶</span><span class="wch-text">×™×© ×œ× ×• ×™×œ×“×™×</span>
      </label>
      <div id="childrenSection" style="display:${wizData.hasChildren?'block':'none'};margin-top:10px">
        <div id="wizChildrenList">
          ${(wizData.children.length>0?wizData.children:[{id:uid(),name:'',age:5}]).map((child,i)=>`
            <div class="wizard-child-card wiz-child-entry">
              <div style="font-weight:600;font-size:.85rem;margin-bottom:8px">×™×œ×“/×” ${i+1}</div>
              <div class="child-row">
                <input type="text" class="wiz-child-name admin-input" value="${child.name}" placeholder="×©×">
                <input type="number" class="wiz-child-age admin-input" value="${child.age}" min="0" max="18" placeholder="×’×™×œ" style="width:70px;flex:none">
                ${i>0?`<button class="btn-sm danger" onclick="this.closest('.wiz-child-entry').remove()">âœ•</button>`:''}
              </div>
            </div>
          `).join('')}
        </div>
        <button class="add-item-btn" onclick="addWizChild()">+ ×”×•×¡×£ ×™×œ×“/×”</button>
      </div>
    </div>
  </div>`;
}

function addWizChild(){
  const list=document.getElementById('wizChildrenList');
  const count=list.querySelectorAll('.wiz-child-entry').length;
  const div=document.createElement('div');
  div.className='wizard-child-card wiz-child-entry';
  div.innerHTML=`<div style="font-weight:600;font-size:.85rem;margin-bottom:8px">×™×œ×“/×” ${count+1}</div>
    <div class="child-row">
      <input type="text" class="wiz-child-name admin-input" placeholder="×©×">
      <input type="number" class="wiz-child-age admin-input" value="5" min="0" max="18" placeholder="×’×™×œ" style="width:70px;flex:none">
      <button class="btn-sm danger" onclick="this.closest('.wiz-child-entry').remove()">âœ•</button>
    </div>`;
  list.appendChild(div);
}

function renderWizEvents(){
  const p1=wizData.partner1||'×©×•×ª×£ 1',p2=wizData.partner2||'×©×•×ª×£ 2';
  const children=wizData.hasChildren?wizData.children.filter(c=>c.name):[];
  const suggestions=[
    {name:`×™×•× ×”×•×œ×“×ª ${p1}`,emoji:'ğŸ‚'},
    {name:`×™×•× ×”×•×œ×“×ª ${p2}`,emoji:'ğŸ‚'},
    ...children.map(c=>({name:`×™×•× ×”×•×œ×“×ª ${c.name}`,emoji:'ğŸˆ'})),
    {name:'×™×•× × ×™×©×•××™×Ÿ',emoji:'ğŸ’'},
    {name:'×¨××© ×”×©× ×”',emoji:'ğŸ¯',month:9},
    {name:'×¤×¡×—',emoji:'ğŸ«“',month:4},
    {name:'×—× ×•×›×”',emoji:'ğŸ•',month:12},
    {name:'×—×•×¤×©×” ×’×“×•×œ×”',emoji:'ğŸ–ï¸',month:7}
  ];
  // Filter out already added
  const existingNames=new Set((wizData.events||[]).map(e=>e.name));
  const available=suggestions.filter(s=>!existingNames.has(s.name));
  const monthOpts=HM.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
  return `<div class="wizard-step">
    <div style="text-align:center;font-size:2.5rem;margin:16px 0">ğŸ“…</div>
    <div class="wizard-title">××™×¨×•×¢×™× ×•×ª××¨×™×›×™×</div>
    <div class="wizard-subtitle">×”×’×“×™×¨×• ××™×¨×•×¢×™× ×©× ×ª×™×™× ×©×™×•×¤×™×¢×• ××•×˜×•××˜×™×ª ×‘×ª×§×¦×™×‘ ×”×—×•×“×©×™</div>
    ${available.length>0?`<div style="margin:14px 0 8px;font-weight:600;font-size:.85rem">×”×¦×¢×•×ª ××”×™×¨×•×ª:</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px">
      ${available.map((s,i)=>`<button class="btn-sm" onclick="addWizEventSugg(${i})" style="font-size:.82rem;cursor:pointer">${s.emoji} ${esc(s.name)}</button>`).join('')}
    </div>`:''}
    <div style="font-weight:600;font-size:.85rem;margin-bottom:8px">××™×¨×•×¢×™× ×©× ×‘×—×¨×•:</div>
    <div id="wizEventsList">
      ${(wizData.events||[]).map((evt,i)=>`
        <div class="wiz-event-row" style="display:flex;gap:6px;margin-bottom:8px;align-items:center;flex-wrap:wrap;background:var(--bg);padding:8px;border-radius:var(--radius-sm)">
          <input type="text" class="wiz-evt-emoji admin-input" value="${esc(evt.emoji)}" style="width:42px;text-align:center;padding:4px">
          <input type="text" class="wiz-evt-name admin-input" value="${esc(evt.name)}" placeholder="×©× ×”××™×¨×•×¢" style="flex:1;min-width:100px;padding:4px 8px">
          <select class="wiz-evt-month admin-input" style="min-width:90px;padding:4px">
            ${HM.map((m,mi)=>`<option value="${mi+1}"${evt.month===mi+1?' selected':''}>${m}</option>`).join('')}
          </select>
          <input type="number" class="wiz-evt-budget admin-input ltr" value="${evt.estimatedBudget||''}" placeholder="â‚ª ×ª×§×¦×™×‘" min="0" style="width:80px;direction:ltr;text-align:center;padding:4px">
          <button class="btn-sm danger" onclick="removeWizEvent(${i})" style="flex-shrink:0">âœ•</button>
        </div>
      `).join('')}
    </div>
    ${(wizData.events||[]).length===0?'<p style="color:var(--text-light);font-size:.82rem;padding:8px 0">×œ×—×¦×• ×¢×œ ×”×¦×¢×” ××”×™×¨×” ××• ×”×•×¡×™×¤×• ××™×¨×•×¢ ×™×“× ×™×ª</p>':''}
    <button class="add-item-btn" onclick="addWizEventBlank()" style="margin-top:8px">+ ×”×•×¡×£ ××™×¨×•×¢</button>
  </div>`;
}

function addWizEventSugg(idx){
  saveWizardStep();
  const p1=wizData.partner1||'×©×•×ª×£ 1',p2=wizData.partner2||'×©×•×ª×£ 2';
  const children=wizData.hasChildren?wizData.children.filter(c=>c.name):[];
  const suggestions=[
    {name:`×™×•× ×”×•×œ×“×ª ${p1}`,emoji:'ğŸ‚'},
    {name:`×™×•× ×”×•×œ×“×ª ${p2}`,emoji:'ğŸ‚'},
    ...children.map(c=>({name:`×™×•× ×”×•×œ×“×ª ${c.name}`,emoji:'ğŸˆ'})),
    {name:'×™×•× × ×™×©×•××™×Ÿ',emoji:'ğŸ’'},
    {name:'×¨××© ×”×©× ×”',emoji:'ğŸ¯',month:9},
    {name:'×¤×¡×—',emoji:'ğŸ«“',month:4},
    {name:'×—× ×•×›×”',emoji:'ğŸ•',month:12},
    {name:'×—×•×¤×©×” ×’×“×•×œ×”',emoji:'ğŸ–ï¸',month:7}
  ];
  const existingNames=new Set((wizData.events||[]).map(e=>e.name));
  const available=suggestions.filter(s=>!existingNames.has(s.name));
  const s=available[idx];if(!s)return;
  wizData.events.push({id:uid(),name:s.name,emoji:s.emoji,month:s.month||1,day:0,estimatedBudget:0,owner:'shared',enabled:true});
  renderWizardStep();
}

function addWizEventBlank(){
  saveWizardStep();
  wizData.events.push({id:uid(),name:'',emoji:'ğŸ“…',month:1,day:0,estimatedBudget:0,owner:'shared',enabled:true});
  renderWizardStep();
}

function removeWizEvent(idx){
  saveWizardStep();
  wizData.events.splice(idx,1);
  renderWizardStep();
}

function renderWizIncome(){
  const p1=wizData.partner1||'×©×•×ª×£ 1';
  const p2=wizData.partner2||'×©×•×ª×£ 2';
  const solo=!!wizData.soloMode;
  const sources=wizData.incomeSources.length>0?wizData.incomeSources:
    solo?[{name:`××©×›×•×¨×ª ${p1}`,defaultAmount:0}]:
    [{name:`××©×›×•×¨×ª ${p1}`,defaultAmount:0},{name:`××©×›×•×¨×ª ${p2}`,defaultAmount:0}];
  return `<div class="wizard-step">
    <div class="wizard-title">×”×›× ×¡×•×ª ğŸ’µ</div>
    <div class="wizard-subtitle">×”×’×“×™×¨×• ××§×•×¨×•×ª ×”×›× ×¡×” ×•×¡×›×•××™× ×—×•×“×©×™×™× ×˜×™×¤×•×¡×™×™×</div>
    <div id="wizIncomeList">
      ${sources.map((s,i)=>`
        <div class="wiz-income-row" style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
          <input type="text" class="wiz-inc-name admin-input" value="${s.name}" placeholder="××§×•×¨" style="flex:1">
          <input type="number" class="wiz-inc-amt admin-input ltr" value="${s.defaultAmount||''}" placeholder="×¡×›×•×" min="0" style="width:110px;direction:ltr;text-align:right">
          <button class="btn-sm danger" onclick="this.parentElement.remove()">âœ•</button>
        </div>
      `).join('')}
    </div>
    <button class="add-item-btn" onclick="addWizIncome()">+ ×”×•×¡×£ ××§×•×¨ ×”×›× ×¡×”</button>
  </div>`;
}

function addWizIncome(){
  const list=document.getElementById('wizIncomeList');
  const div=document.createElement('div');
  div.className='wiz-income-row';
  div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
  div.innerHTML=`<input type="text" class="wiz-inc-name admin-input" placeholder="××§×•×¨" style="flex:1">
    <input type="number" class="wiz-inc-amt admin-input ltr" placeholder="×¡×›×•×" min="0" style="width:110px;direction:ltr;text-align:right">
    <button class="btn-sm danger" onclick="this.parentElement.remove()">âœ•</button>`;
  list.appendChild(div);
}

function renderWizSavings(){
  return `<div class="wizard-step">
    <div class="wizard-title">×—×¡×›×•× ×•×ª ×•×™×¢×“×™× ğŸ¦</div>
    <div class="wizard-subtitle">××•×¤×¦×™×•× ×œ×™ - ××¤×©×¨ ×œ×”×’×“×™×¨ ×’× ××—×¨ ×›×š</div>
    <label class="wizard-check checked">
      <input type="checkbox" id="wizEmergency" checked>
      <span class="wch-icon">ğŸ†˜</span><span class="wch-text">×§×¨×Ÿ ×—×™×¨×•×</span>
    </label>
    <div class="wizard-field" style="margin-right:40px"><label>×¡×›×•× ×™×¢×“ ×œ×§×¨×Ÿ ×—×™×¨×•×</label>
      <input type="number" id="wizEmergencyAmt" value="${wizData.emergencyTarget||''}" min="0" placeholder="×œ×“×•×’××”: 30000" style="direction:ltr;text-align:right">
    </div>
    <div style="margin-top:16px;font-weight:600;font-size:.9rem;margin-bottom:10px">×™×¢×“×™ ×—×™×¡×›×•×Ÿ × ×•×¡×¤×™×:</div>
    <div id="wizGoalsList">
      ${(wizData.savingsGoals.length>0?wizData.savingsGoals:[{name:'×—×•×¤×©×”',amt:10000},{name:'×¨×™×”×•×˜',amt:5000}]).map((g,i)=>`
        <div class="wiz-goal-row" style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
          <input type="text" class="wiz-goal-name admin-input" value="${g.name||''}" placeholder="×©× ×”×™×¢×“" style="flex:1">
          <input type="number" class="wiz-goal-amt admin-input ltr" value="${g.target||g.amt||''}" placeholder="×¡×›×•× ×™×¢×“" min="0" style="width:110px;direction:ltr;text-align:right">
          <button class="btn-sm danger" onclick="this.parentElement.remove()">âœ•</button>
        </div>
      `).join('')}
    </div>
    <button class="add-item-btn" onclick="addWizGoal()">+ ×”×•×¡×£ ×™×¢×“</button>
  </div>`;
}

function addWizGoal(){
  const list=document.getElementById('wizGoalsList');
  const div=document.createElement('div');
  div.className='wiz-goal-row';
  div.style.cssText='display:flex;gap:8px;margin-bottom:8px;align-items:center';
  div.innerHTML=`<input type="text" class="wiz-goal-name admin-input" placeholder="×©× ×”×™×¢×“" style="flex:1">
    <input type="number" class="wiz-goal-amt admin-input ltr" placeholder="×¡×›×•× ×™×¢×“" min="0" style="width:110px;direction:ltr;text-align:right">
    <button class="btn-sm danger" onclick="this.parentElement.remove()">âœ•</button>`;
  list.appendChild(div);
}

function renderWizPlanned(){
  return `<div class="wizard-step">
    <div class="wizard-title">×ª×§×¦×™×‘ ××ª×•×›× ×Ÿ ğŸ“‹</div>
    <div class="wizard-subtitle">××•×¤×¦×™×•× ×œ×™ - ×ª×•×›×œ×• ×œ××œ× ×¡×›×•××™× ××ª×•×›× × ×™× ×œ×›×œ ×¤×¨×™×˜, ××• ×œ×“×œ×’ ×•×œ××œ× ××—×¨ ×›×š</div>
    <p style="text-align:center;color:var(--text-secondary);font-size:.88rem">× ×™×ª×Ÿ ×œ×”×’×“×™×¨ ×ª×§×¦×™×‘ ××ª×•×›× ×Ÿ ××ª×•×š ××¡×š ×”×ª×§×¦×™×‘ ×”×—×•×“×©×™ ×œ××—×¨ ×¡×™×•× ×”××©×£</p>
  </div>`;
}

function renderWizDone(){
  const catCount=wizData.categories.filter(c=>c.enabled).length;
  const p1=wizData.partner1||'-';
  const p2=wizData.partner2||'-';
  const childCount=wizData.hasChildren?wizData.children.filter(c=>c.name).length:0;
  return `<div class="wizard-step" style="text-align:center">
    <div style="font-size:3rem;margin:20px 0">ğŸ‰</div>
    <div class="wizard-title">×”×›×œ ××•×›×Ÿ!</div>
    <div class="wizard-subtitle">×¡×™×›×•× ×”×”×’×“×¨×•×ª ×©×œ×›×</div>
    <div style="background:var(--card);border-radius:var(--radius);padding:16px;text-align:right;box-shadow:var(--card-shadow)">
      <div style="margin-bottom:8px"><strong>${wizData.soloMode?'×©×:':'×©×•×ª×¤×™×:'}</strong> ${wizData.soloMode?p1:p1+' ×•-'+p2}</div>
      <div style="margin-bottom:8px"><strong>×§×˜×’×•×¨×™×•×ª:</strong> ${catCount}</div>
      ${childCount>0?`<div style="margin-bottom:8px"><strong>×™×œ×“×™×:</strong> ${wizData.children.filter(c=>c.name).map(c=>c.name).join(', ')}</div>`:''}
      ${wizData.hasPet?`<div style="margin-bottom:8px"><strong>×—×™×™×ª ××—××“:</strong> ${wizData.petName||'×œ×œ× ×©×'}</div>`:''}
      <div style="margin-bottom:8px"><strong>××§×•×¨×•×ª ×”×›× ×¡×”:</strong> ${wizData.incomeSources.length}</div>
      <div style="margin-bottom:8px"><strong>×™×¢×“×™ ×—×™×¡×›×•×Ÿ:</strong> ${wizData.savingsGoals.length}${wizData.hasEmergency?' + ×§×¨×Ÿ ×—×™×¨×•×':''}</div>
      ${(wizData.events||[]).length>0?`<div><strong>××™×¨×•×¢×™×:</strong> ${wizData.events.map(e=>e.emoji+' '+e.name).join(', ')}</div>`:''}
    </div>
  </div>`;
}

function finishWizard(){
  saveWizardStep();
  // Build config from wizard data
  const solo=!!wizData.soloMode;
  const p1=wizData.partner1||'×©×•×ª×£ 1';
  const p2=solo?'':(wizData.partner2||'×©×•×ª×£ 2');

  D.config.partner1=p1;
  D.config.partner2=p2;
  D.config.soloMode=solo;
  D.config.pet={name:wizData.petName||'',enabled:wizData.hasPet};
  D.config.children=wizData.hasChildren?wizData.children.filter(c=>c.name):[];

  // Build categories
  D.config.categories=wizData.categories.filter(c=>c.enabled).map((c,i)=>{
    const cat={id:c.id||uid(),name:c.name,icon:c.icon,order:i,isChildrenCategory:!!c.isChildrenCategory};
    if(!c.isChildrenCategory){
      let items=(c.items||[]).map(it=>typeof it==='string'?{name:it,isDefault:true}:{...it});
      // Personalize items
      if(c.id==='grooming'){
        items=items.filter(i=>i.name!=='×ª×¡×¤×•×¨×ª'&&i.name!=='×›×•×©×¨');
        if(solo){
          items.push({name:`×ª×¡×¤×•×¨×ª ${p1}`,isDefault:true});
          items.push({name:`×›×•×©×¨ ${p1}`,isDefault:true});
        }else{
          items.push({name:`×ª×¡×¤×•×¨×ª ${p1}`,isDefault:true},{name:`×ª×¡×¤×•×¨×ª ${p2}`,isDefault:true});
          items.push({name:`×›×•×©×¨ ${p1}`,isDefault:true},{name:`×›×•×©×¨ ${p2}`,isDefault:true});
        }
      }
      if(c.id==='entertainment'){
        items=items.filter(i=>!i.name.includes('×‘×™×œ×•×™×™×'));
        if(solo){
          items.push({name:'×‘×™×œ×•×™×™×',isDefault:true});
        }else{
          items.push({name:`×‘×™×œ×•×™×™× ${p1}`,isDefault:true},{name:`×‘×™×œ×•×™×™× ${p2}`,isDefault:true},{name:'×‘×™×œ×•×™×™× ××©×•×ª×¤×™×',isDefault:true});
        }
      }
      // Pet category rename
      if(c.id==='pet'&&wizData.hasPet&&wizData.petName){
        cat.name=wizData.petName;
        cat.icon='ğŸ•';
      }
      cat.items=items;
    }else{
      cat.items=[];
    }
    return cat;
  });

  // Income sources
  if(wizData.incomeSources.length>0){
    D.config.incomeSources=wizData.incomeSources;
  }else if(solo){
    D.config.incomeSources=[{name:`××©×›×•×¨×ª ${p1}`,defaultAmount:0}];
  }else{
    D.config.incomeSources=[{name:`××©×›×•×¨×ª ${p1}`,defaultAmount:0},{name:`××©×›×•×¨×ª ${p2}`,defaultAmount:0}];
  }
  // Update salary names with actual partner names
  D.config.incomeSources.forEach(s=>{
    if(s.name.includes('×‘×Ÿ/×‘×ª ×–×•×’ 1')||s.name.includes('×©×•×ª×£ 1'))s.name=s.name.replace(/×‘×Ÿ\/×‘×ª ×–×•×’ 1|×©×•×ª×£ 1/g,p1);
    if(!solo&&(s.name.includes('×‘×Ÿ/×‘×ª ×–×•×’ 2')||s.name.includes('×©×•×ª×£ 2')))s.name=s.name.replace(/×‘×Ÿ\/×‘×ª ×–×•×’ 2|×©×•×ª×£ 2/g,p2);
  });

  // Savings
  if(wizData.hasEmergency){
    D.savings.emergency={target:wizData.emergencyTarget||0,current:0,monthlyContribution:0};
  }
  D.savings.goals=wizData.savingsGoals||[];
  // Children savings
  if(D.config.children.length>0){
    D.savings.childrenSavings=D.config.children.map(c=>({
      childId:c.id,childName:c.name,purposes:['education'],target:0,current:0,targetAge:18,monthlyContribution:0
    }));
  }

  // Events
  D.config.events=wizData.events||[];
  // Ensure events category exists if events defined
  if(D.config.events.length>0&&!D.config.categories.find(c=>c.id==='events')){
    const idx=D.config.categories.findIndex(c=>c.id==='unexpected');
    const evCat={id:'events',name:'××™×¨×•×¢×™×',icon:'ğŸ“…',order:idx>=0?idx:D.config.categories.length,items:[]};
    if(idx>=0)D.config.categories.splice(idx,0,evCat);
    else D.config.categories.push(evCat);
  }

  D.settings.setupComplete=true;
  saveData();
  hideWizard();
  initApp();
  toast('×”×ª×§×¦×™×‘ ×”×•×’×“×¨ ×‘×”×¦×œ×—×”! ğŸ‰');
}

// ===== MONTH NAVIGATION =====
function populateMonthSelects(){
  ['monthSelect','dashMonthSelect'].forEach(id=>{
    const s=document.getElementById(id);if(!s)return;
    s.innerHTML='';
    HM.forEach((n,i)=>{const o=document.createElement('option');o.value=i;o.textContent=n;s.appendChild(o)});
    s.value=curMonth;
  });
  const yi=document.getElementById('yearInput');if(yi)yi.value=curYear;
  const dy=document.getElementById('dashYearInput');if(dy)dy.value=curYear;
}

function changeMonth(){
  curMonth=parseInt(document.getElementById('monthSelect').value);
  curYear=parseInt(document.getElementById('yearInput').value);
  const ds=document.getElementById('dashMonthSelect');if(ds)ds.value=curMonth;
  const dy=document.getElementById('dashYearInput');if(dy)dy.value=curYear;
  renderBudget();updateSummary();
}

function navMonth(dir){
  curMonth+=dir;
  if(curMonth>11){curMonth=0;curYear++}
  if(curMonth<0){curMonth=11;curYear--}
  document.getElementById('monthSelect').value=curMonth;
  document.getElementById('yearInput').value=curYear;
  const ds=document.getElementById('dashMonthSelect');if(ds)ds.value=curMonth;
  const dy=document.getElementById('dashYearInput');if(dy)dy.value=curYear;
  renderBudget();updateSummary();
}

// ===== RENDER BUDGET TAB =====
function renderBudget(){
  const key=mk(curMonth,curYear);
  const data=getMonth(key);
  const container=document.getElementById('categoriesContainer');
  container.innerHTML='';

  const cats=D.config.categories||[];
  cats.forEach((catDef,catIdx)=>{
    try{
    const catData=data.expenses[catDef.name];
    if(!catData)return;
    // Skip children category if no children configured
    if(catDef.isChildrenCategory&&D.config.children.length===0)return;
    // Skip pet category if pet not enabled
    if(catDef.id==='pet'&&(!D.config.pet||!D.config.pet.enabled))return;
    // Skip events category if no enabled events
    if(catDef.id==='events'&&!(D.config.events||[]).some(e=>e.enabled))return;

    const catBudget=catData.budget||0;
    let totalSpent=0;
    (catData.items||[]).forEach(it=>{totalSpent+=(it.amount||0)});
    const diff=catBudget-totalSpent;
    const pct=catBudget>0?Math.round(totalSpent/catBudget*100):0;
    let barCls=pct>100?'over':pct>85?'warn':'ok';

    const card=document.createElement('div');
    card.className='category-card';
    card.setAttribute('data-cat',catDef.name);

    // Special rendering for children category
    const isChildren=catDef.isChildrenCategory&&D.config.children.length>0;
    let bodyHtml='';

    if(isChildren){
      bodyHtml=renderChildrenCategoryBody(catDef,catData,catBudget,totalSpent,diff);
    }else{
      bodyHtml=`${ownerLegend()}<table class="data-table">
        <thead><tr><th class="owner-cell"></th><th>×¤×¨×™×˜</th><th class="number-cell">×¡×›×•×</th><th class="actions-cell"></th></tr></thead>
        <tbody>${(()=>{const items=catData.items||[];const grp=it=>it.group||it.name;return items.map((item,ii)=>{
          const isFixed=item.fixed;const isEvt=item.isEvent;
          const isSub=ii>0&&grp(items[ii-1])===grp(item)&&item.group;
          return `<tr style="${isFixed?'background:var(--border-light);':''}${isEvt?'background:var(--warning-bg);':''}${isSub?'border-top:1px dashed var(--border);':''}">
            <td class="owner-cell">${ownerBadge(item.owner||'shared',catDef.name,ii,'expense')}</td>
            <td class="item-name"><div style="display:flex;align-items:center;gap:6px">${isEvt?'<span style="font-size:.85rem;cursor:help" title="××™×¨×•×¢ ×©× ×ª×™">ğŸ“…</span>':(isSub?'<span style="width:32px;flex-shrink:0;text-align:center;color:var(--text-light);font-size:.75rem">â”—</span>':`<button class="lock-btn${isFixed?' locked':''}" onclick="toggleFixed(this.closest('[data-cat]').dataset.cat,${ii})" title="${isFixed?'× ×¢×•×œ â€” ×œ×—×¦×™ ×œ×©×—×¨×•×¨':'×œ×—×¦×™ ×œ× ×¢×•×œ ×›×”×•×¦××” ×§×‘×•×¢×”'}">${isFixed?'ğŸ”’':'ğŸ”“'}</button>`)}<div>${isSub?`<span style="font-size:.85rem">${esc(item.name)}</span>`:`${esc(item.name)}<span class="trend-btn" onclick="event.stopPropagation();showItemTrend(this.closest('[data-cat]').dataset.cat,'${esc(item.name).replace(/'/g,"\\'")}')">ğŸ“ˆ</span><span class="provider-text${item.provider?' has-provider':''}" onclick="setProvider(this.closest('[data-cat]').dataset.cat,${ii})">${item.provider?'ğŸ¢ '+esc(item.provider):'+ ×¡×¤×§'}</span>`}</div></div></td>
            <td class="number-cell"><input class="num-input" type="number" min="0" value="${item.amount||0}" oninput="updateItem(this.closest('[data-cat]').dataset.cat,${ii},this.value)" onfocus="this.select()"></td>
            <td class="actions-cell"><div class="actions-cell-inner"><button class="add-row-btn" onclick="quickAddRow(this.closest('[data-cat]').dataset.cat,${ii})" title="×©×›×¤×œ ×©×•×¨×”">â•</button><button class="move-btn" onclick="moveItem(this.closest('[data-cat]').dataset.cat,${ii})" title="×”×¢×‘×¨ ×œ×§×˜×’×•×¨×™×” ××—×¨×ª"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><path d="M12 11v6m0 0l-3-3m3 3l3-3"/></svg></button><button class="delete-btn" onclick="removeItem(this.closest('[data-cat]').dataset.cat,${ii})">âœ•</button></div></td>
          </tr>`;
        }).join('')})()}</tbody>
        <tfoot><tr class="subtotal-row"><td></td><td>×¡×”×´×› ${esc(catDef.name)}</td><td class="number-cell cat-subtotal">${fc(totalSpent)}</td><td></td></tr></tfoot>
      </table>
      <button class="add-item-btn" onclick="addItem(this.closest('[data-cat]').dataset.cat)">+ ×”×•×¡×£ ×¤×¨×™×˜</button>`;
    }

    card.innerHTML=`
      <div class="category-header" onclick="toggleCategory(this)">
        <span class="category-icon">${catDef.icon}</span>
        <span class="category-title">${esc(catDef.name)}</span>
        <div class="category-totals">
          <span class="budget-field" onclick="event.stopPropagation();editCategoryBudget(this.closest('[data-cat]').dataset.cat)">×ª×§×¦×™×‘: ${fc(catBudget)}</span>
          <span>×”×•×¦×: ${fc(totalSpent)}</span>
          <span class="${diff>=0?'under':'over'}">${diff>=0?'× ×•×ª×¨: '+fc(diff):'×—×¨×™×’×”: '+fc(Math.abs(diff))}</span>
        </div>
        <span class="chevron">â—€</span>
      </div>
      <div class="category-progress"><div class="category-progress-bar ${barCls}" style="width:${Math.min(pct,100)}%"></div></div>
      <div class="category-body">${bodyHtml}</div>`;
    container.appendChild(card);
    }catch(e){console.error('Error rendering category:',catDef.name,e)}
  });

  renderMisc(data);
  renderIncome(data);
  renderDiscretionary(data);
  // Render month notes
  const notesEl=document.getElementById('monthNotes');
  if(notesEl)notesEl.value=data.notes||'';
  updateSummary();
  renderAlerts();
  updateTabIndexes();
}

// ===== CHILDREN CATEGORY SPECIAL RENDER =====
function renderChildrenCategoryBody(catDef,catData,catBudget,totalSpent,diff){
  const children=D.config.children||[];
  let html=ownerLegend()+'<table class="data-table"><thead><tr><th class="owner-cell"></th><th>×¤×¨×™×˜</th><th class="number-cell">×¡×›×•×</th><th class="actions-cell"></th></tr></thead><tbody>';

  children.forEach(child=>{
    const childItems=catData.items.filter(i=>i.childId===child.id);
    if(childItems.length===0)return;
    let childTotal=0;
    childItems.forEach(i=>{childTotal+=(i.amount||0)});
    html+=`<tr><td colspan="4"><div class="child-subheader">${esc(child.emoji||'ğŸ‘¶')} ${esc(child.name)}</div></td></tr>`;
    childItems.forEach(item=>{
      const idx=catData.items.indexOf(item);
      html+=`<tr>
        <td class="owner-cell">${ownerBadge(item.owner||'shared',catDef.name,idx,'expense')}</td>
        <td class="item-name" style="padding-right:28px"><div>${esc(item.name)}<span class="provider-text${item.provider?' has-provider':''}" onclick="setProvider(this.closest('[data-cat]').dataset.cat,${idx})">${item.provider?'ğŸ¢ '+esc(item.provider):'+ ×¡×¤×§'}</span></div></td>
        <td class="number-cell"><input class="num-input" type="number" min="0" value="${item.amount||0}" oninput="updateItem(this.closest('[data-cat]').dataset.cat,${idx},this.value)" onfocus="this.select()"></td>
        <td class="actions-cell"><button class="move-btn" onclick="moveItem(this.closest('[data-cat]').dataset.cat,${idx})" title="×”×¢×‘×¨ ×œ×§×˜×’×•×¨×™×” ××—×¨×ª"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><path d="M12 11v6m0 0l-3-3m3 3l3-3"/></svg></button><button class="delete-btn" onclick="removeItem(this.closest('[data-cat]').dataset.cat,${idx})">âœ•</button></td>
      </tr>`;
    });
    html+=`<tr><td colspan="4"><div class="child-subtotal"><span>×¡×”×´×› ${esc(child.name)}</span><span>${fc(childTotal)}</span></div></td></tr>`;
  });

  const shared=catData.items.filter(i=>i.childId==='shared'||!i.childId);
  if(shared.length>0){
    html+=`<tr><td colspan="4"><div class="child-subheader">ğŸ‘¥ ××©×•×ª×£ ×™×œ×“×™×</div></td></tr>`;
    shared.forEach(item=>{
      const idx=catData.items.indexOf(item);
      html+=`<tr>
        <td class="owner-cell">${ownerBadge(item.owner||'shared',catDef.name,idx,'expense')}</td>
        <td class="item-name" style="padding-right:28px"><div>${esc(item.name)}<span class="provider-text${item.provider?' has-provider':''}" onclick="setProvider(this.closest('[data-cat]').dataset.cat,${idx})">${item.provider?'ğŸ¢ '+esc(item.provider):'+ ×¡×¤×§'}</span></div></td>
        <td class="number-cell"><input class="num-input" type="number" min="0" value="${item.amount||0}" oninput="updateItem(this.closest('[data-cat]').dataset.cat,${idx},this.value)" onfocus="this.select()"></td>
        <td class="actions-cell"><button class="move-btn" onclick="moveItem(this.closest('[data-cat]').dataset.cat,${idx})" title="×”×¢×‘×¨ ×œ×§×˜×’×•×¨×™×” ××—×¨×ª"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><path d="M12 11v6m0 0l-3-3m3 3l3-3"/></svg></button><button class="delete-btn" onclick="removeItem(this.closest('[data-cat]').dataset.cat,${idx})">âœ•</button></td>
      </tr>`;
    });
  }

  html+=`</tbody><tfoot><tr class="subtotal-row"><td></td><td>×¡×”×´×› ×™×œ×“×™×</td><td class="number-cell cat-subtotal">${fc(totalSpent)}</td><td></td></tr></tfoot></table>`;
  html+=`<button class="add-item-btn" onclick="addChildItem()">+ ×”×•×¡×£ ×¤×¨×™×˜ ×œ×™×œ×“×™×</button>`;
  return html;
}

function addChildItem(){
  const children=D.config.children;
  const catName=(D.config.categories.find(c=>c.isChildrenCategory)||{}).name||'×™×œ×“×™×';
  const opts=children.map(c=>`<option value="${esc(c.id)}">${esc(c.name)}</option>`).join('')+`<option value="shared">××©×•×ª×£</option>`;
  showModal(`<h3>â• ×”×•×¡×£ ×¤×¨×™×˜ ×œ×™×œ×“×™×</h3>
    <div class="modal-field"><label>×©×™×™×š ×œ:</label><select id="childItemFor">${opts}</select></div>
    <div class="modal-field"><label>×©× ×”×¤×¨×™×˜</label><input class="modal-input" id="childItemName" placeholder="×œ×“×•×’××”: ×—×•×’ ×©×—×™×™×”"></div>
    <div class="modal-field"><label>×¡×›×•×</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="childItemAmount" min="0" placeholder="0"></div></div>
    <div class="modal-actions">
      <button class="modal-btn primary" onclick="confirmAddChildItem()">×”×•×¡×£</button>
      <button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`);
}

function confirmAddChildItem(){
  const catName=(D.config.categories.find(c=>c.isChildrenCategory)||{}).name||'×™×œ×“×™×';
  const childId=document.getElementById('childItemFor').value;
  const name=document.getElementById('childItemName').value.trim();
  if(!name){document.getElementById('childItemName').style.borderColor='var(--danger)';return}
  const amount=Math.max(0,parseInt(document.getElementById('childItemAmount').value)||0);
  const key=mk(curMonth,curYear);
  const data=getMonth(key);
  data.expenses[catName].items.push({name,amount,isDefault:false,childId});
  saveData();closeModal();renderBudgetKeepOpen();toast(`"${name}" × ×•×¡×£`);
}

// ===== INCOME & MISC =====
function renderIncome(data){
  const body=document.getElementById('incomeBody');body.innerHTML='';
  let total=0;
  if(data.income.length===0){
    body.innerHTML='<tr><td colspan="4" style="text-align:center;color:var(--text-secondary);padding:16px;font-size:.85rem">××™×Ÿ ×”×›× ×¡×•×ª. ×œ×—×¦×• + ×œ×”×•×¡×¤×”</td></tr>';
  }
  data.income.forEach((inc,idx)=>{
    total+=(inc.amount||0);
    const isFixed=inc.fixed;
    const tr=document.createElement('tr');
    if(isFixed)tr.style.background='var(--border-light)';
    tr.innerHTML=`<td class="owner-cell">${ownerBadge(inc.owner||'shared','',idx,'income')}</td>
      <td><div style="display:flex;align-items:center;gap:6px"><button class="lock-btn${isFixed?' locked':''}" onclick="toggleFixedIncome(${idx})" title="${isFixed?'× ×¢×•×œ â€” ×œ×—×¦×™ ×œ×©×—×¨×•×¨':'×œ×—×¦×™ ×œ× ×¢×•×œ ×›×”×›× ×¡×” ×§×‘×•×¢×”'}">${isFixed?'ğŸ”’':'ğŸ”“'}</button><input class="income-source-input" type="text" value="${esc(inc.source)}" onchange="updateIncome(${idx},'source',this.value)" placeholder="××§×•×¨"></div></td>
      <td class="number-cell"><input class="num-input" type="number" min="0" value="${inc.amount||0}" oninput="${isFixed?`updateFixedIncome(${idx},this.value)`:`updateIncome(${idx},'amount',this.value)`}" onfocus="this.select()"></td>
      <td class="actions-cell"><button class="delete-btn" onclick="removeIncome(${idx})">âœ•</button></td>`;
    body.appendChild(tr);
  });
  document.getElementById('incomeTotalCell').textContent=fc(total);
}

function renderMisc(data){
  const body=document.getElementById('miscBody');
  if(!body)return;
  body.innerHTML='';
  let total=0;
  const misc=data.misc&&typeof data.misc==='object'?data.misc:{};
  const entries=Object.entries(misc);
  if(entries.length===0){
    body.innerHTML='<tr><td colspan="3" style="text-align:center;color:var(--text-secondary);padding:16px;font-size:.85rem">××™×Ÿ ×¤×¨×™×˜×™×. ×œ×—×¦×• + ×œ×”×•×¡×¤×”</td></tr>';
  }else{
    entries.forEach(([name,val])=>{
      total+=(Number(val)||0);
      const tr=document.createElement('tr');
      tr.setAttribute('data-misc',name);
      tr.innerHTML=`<td class="misc-label">${esc(name)}</td>
        <td class="number-cell"><input class="num-input" type="number" min="0" value="${Number(val)||0}" oninput="updateMisc(this.closest('[data-misc]').dataset.misc,this.value)" onfocus="this.select()"></td>
        <td class="actions-cell"><button class="move-btn" onclick="moveMiscItem('${esc(name)}')" title="×”×¢×‘×¨ ×œ×§×˜×’×•×¨×™×”"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/><path d="M12 11v6m0 0l-3-3m3 3l3-3"/></svg></button><button class="delete-btn" onclick="removeMiscItem(this.closest('[data-misc]').dataset.misc)">âœ•</button></td>`;
      body.appendChild(tr);
    });
  }
  const tc=document.getElementById('miscTotalCell');if(tc)tc.textContent=fc(total);
}

function renderDiscretionary(data){
  const inc=data.income||[];
  let totalIncome=0;
  inc.forEach(i=>totalIncome+=(i.amount||0));

  let totalSpent=0;
  Object.values(data.expenses||{}).forEach(c=>(c.items||[]).forEach(i=>totalSpent+=(i.amount||0)));

  let totalMisc=0;
  Object.values(data.misc||{}).forEach(v=>totalMisc+=(Number(v)||0));

  let totalDeposits=0;
  Object.values(data.savingsContributions||{}).forEach(v=>totalDeposits+=v);

  const fixedSavingsTotal=(D.savings.fixedSavings||[]).reduce((a,s)=>a+(s.amount||0),0);

  const free=totalIncome-totalSpent-totalMisc-totalDeposits-fixedSavingsTotal;
  const pct=totalIncome>0?Math.round((totalSpent+totalMisc+totalDeposits+fixedSavingsTotal)/totalIncome*100):0;

  const el=document.getElementById('discretionaryAmount');
  if(el){
    el.textContent=fc(free);
    el.style.color=free>=0?'var(--success)':'var(--danger)';
  }
  const di=document.getElementById('discIncome');if(di)di.textContent=fc(totalIncome);
  const de=document.getElementById('discExpenses');if(de)de.textContent=fc(totalSpent+totalMisc);
  const dd=document.getElementById('discDeposits');if(dd)dd.textContent=fc(totalDeposits+fixedSavingsTotal);
  const bar=document.getElementById('discretionaryBar');
  if(bar){
    bar.style.width=Math.min(pct,100)+'%';
    bar.className='category-progress-bar '+(pct>100?'over':pct>85?'warn':'ok');
  }
  // Savings breakdown
  const sb=document.getElementById('savingsBreakdown');
  if(sb){
    let html='';
    const items=[];
    // Emergency fund
    if(D.savings.emergency&&D.savings.emergency.monthlyContribution>0){
      const em=(data.savingsContributions||{}).emergency||0;
      items.push({name:'ğŸ†˜ ×§×¨×Ÿ ×—×™×¨×•×',amount:em,target:D.savings.emergency.monthlyContribution});
    }
    // Goals
    (D.savings.goals||[]).forEach(g=>{
      if(g.monthlyContribution>0){
        const dep=(data.savingsContributions||{})[g.id]||0;
        items.push({name:`${g.emoji||'ğŸ¯'} ${g.name}`,amount:dep,target:g.monthlyContribution});
      }
    });
    // Children savings
    (D.savings.childrenSavings||[]).forEach(cs=>{
      if(cs.monthlyContribution>0){
        const dep=(data.savingsContributions||{})[cs.childId]||0;
        items.push({name:`ğŸ‘¶ ×—×™×¡×›×•×Ÿ ${cs.childName}`,amount:dep,target:cs.monthlyContribution});
      }
    });
    // Fixed savings
    (D.savings.fixedSavings||[]).forEach(fs=>{
      if(fs.amount>0)items.push({name:`ğŸ”’ ${fs.name}`,amount:fs.amount,target:fs.amount});
    });
    if(items.length>0){
      html='<div style="border-top:1px solid var(--border-light);padding-top:8px;margin-top:4px"><div style="font-weight:600;margin-bottom:6px;font-size:.8rem">ğŸ’° ×¤×™×¨×•×˜ ×—×¡×›×•× ×•×ª ×—×•×“×©×™×™×:</div>';
      items.forEach(it=>{
        const statusColor=it.amount>=it.target?'var(--success)':'var(--warning)';
        html+=`<div style="display:flex;justify-content:space-between;padding:2px 0"><span>${it.name}</span><span style="font-weight:600;color:${statusColor}">${fc(it.amount)} / ${fc(it.target)}</span></div>`;
      });
      html+='</div>';
    }
    sb.innerHTML=html;
  }
}

// ===== BUDGET ACTIONS =====
function toggleCategory(h){
  const card=h.parentElement;
  card.classList.toggle('expanded');
  // Update tabindex: inputs in collapsed cards should not be focusable
  updateTabIndexes();
}
function updateTabIndexes(){
  document.querySelectorAll('.category-card').forEach(card=>{
    const isExpanded=card.classList.contains('expanded');
    card.querySelectorAll('.category-body input, .category-body select, .category-body button').forEach(el=>{
      el.tabIndex=isExpanded?0:-1;
    });
  });
}

function renderBudgetKeepOpen(){
  const expanded=new Set();
  document.querySelectorAll('.category-card.expanded').forEach(c=>{
    const cat=c.getAttribute('data-cat');
    if(cat)expanded.add(cat);
  });
  renderBudget();
  if(expanded.size>0){
    document.querySelectorAll('.category-card').forEach(c=>{
      const cat=c.getAttribute('data-cat');
      if(cat&&expanded.has(cat))c.classList.add('expanded');
    });
    updateTabIndexes();
  }
}
function propagateFixed(itemName,catName,isFixed,amount){
  const currentKey=mk(curMonth,curYear);
  Object.entries(D.months).forEach(([mk2,mdata])=>{
    if(mk2<currentKey)return;
    if(!mdata.expenses||!mdata.expenses[catName])return;
    const items=mdata.expenses[catName].items||[];
    const match=items.find(i=>i.name===itemName);
    if(match){
      match.fixed=isFixed;
      if(isFixed&&amount!=null)match.amount=amount;
    }
  });
}
function toggleFixed(catName,idx){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[catName].items[idx];
  item.fixed=!item.fixed;
  propagateFixed(item.name,catName,item.fixed,item.fixed?item.amount:null);
  saveData();renderBudgetKeepOpen();
  toast(item.fixed?`ğŸ”’ "${item.name}" â€” ×”×•×¦××” ×§×‘×•×¢×” ×‘×›×œ ×”×—×•×“×©×™×`:`ğŸ”“ "${item.name}" â€” ×”×•×¦××” ××©×ª× ×”`);
}
function updateFixedItem(catName,idx,value){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const amt=Math.max(0,parseInt(value)||0);
  data.expenses[catName].items[idx].amount=amt;
  propagateFixed(data.expenses[catName].items[idx].name,catName,true,amt);
  saveData();
  updateCategoryTotals(catName);
  updateSummary();
  renderAlerts();
}
function setProvider(catName,idx){
  window._providerCat=catName;
  window._providerIdx=idx;
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[catName].items[idx];
  showModal(`<h3>ğŸ¢ ×¡×¤×§ / ×—×‘×¨×”</h3>
    <p>×¤×¨×™×˜: <strong>${esc(item.name)}</strong></p>
    <div class="modal-field"><label>×©× ×”×¡×¤×§ / ×—×‘×¨×”</label><input class="modal-input" type="text" id="providerInput" value="${esc(item.provider||'')}" placeholder="×œ×“×•×’××”: ×‘×–×§, ×—×‘×¨×ª ×—×©××œ, ×¡×œ×§×•×"></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveProvider()">×©××•×¨</button>${item.provider?`<button class="modal-btn danger" onclick="saveProvider(true)">×”×¡×¨ ×¡×¤×§</button>`:''}<button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
  setTimeout(()=>{const i=document.getElementById('providerInput');if(i)i.focus()},250);
}

function saveProvider(remove){
  const catName=window._providerCat;
  const idx=window._providerIdx;
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[catName].items[idx];
  const val=remove?'':(document.getElementById('providerInput').value||'').trim();
  item.provider=val;
  // Also update config so new months inherit the provider
  const catCfg=D.config.categories.find(c=>c.name===catName);
  if(catCfg){
    const cfgItem=catCfg.items.find(i=>i.name===item.name);
    if(cfgItem)cfgItem.provider=val;
  }
  // Propagate to fixed items in other months
  if(item.fixed){
    Object.entries(D.months).forEach(([mk2,mdata])=>{
      if(!mdata.expenses||!mdata.expenses[catName])return;
      const match=mdata.expenses[catName].items.find(i=>i.name===item.name&&i.fixed);
      if(match)match.provider=val;
    });
  }
  saveData();closeModal();renderBudgetKeepOpen();
  toast(val?`×¡×¤×§ "${val}" × ×©××¨`:'×¡×¤×§ ×”×•×¡×¨');
}

function updateItem(catName,idx,value){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  data.expenses[catName].items[idx].amount=Math.max(0,parseInt(value)||0);
  saveData();
  updateCategoryTotals(catName);
  updateSummary();
  renderAlerts();
}
function editCategoryBudget(catName){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const cd=data.expenses[catName];if(!cd)return;
  showModal(`<h3>ğŸ’° ×ª×§×¦×™×‘ ×§×˜×’×•×¨×™×”</h3>
    <p>×§×˜×’×•×¨×™×”: <strong>${esc(catName)}</strong></p>
    <div class="modal-field"><label>×ª×§×¦×™×‘ ×—×•×“×©×™</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="catBudgetInput" min="0" value="${cd.budget||0}"></div></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveCategoryBudget('${esc(catName)}')">×©××•×¨</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
  setTimeout(()=>{const i=document.getElementById('catBudgetInput');if(i){i.focus();i.select()}},250);
}
function saveCategoryBudget(catName){
  const val=Math.max(0,parseInt(document.getElementById('catBudgetInput').value)||0);
  const key=mk(curMonth,curYear);const data=getMonth(key);
  data.expenses[catName].budget=val;
  saveData();closeModal();renderBudgetKeepOpen();
  toast(`×ª×§×¦×™×‘ ${catName}: ${fc(val)}`);
}
function updateCategoryTotals(catName){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const cd=data.expenses[catName];if(!cd)return;
  const budget=cd.budget||0;
  let spent=0;(cd.items||[]).forEach(i=>spent+=(i.amount||0));
  const diff=budget-spent;
  const cards=document.querySelectorAll('.category-card');
  cards.forEach(card=>{
    const title=card.querySelector('.category-title');
    if(!title||title.textContent!==catName)return;
    const totals=card.querySelector('.category-totals');
    if(totals){
      totals.innerHTML=`<span class="budget-field" onclick="event.stopPropagation();editCategoryBudget(this.closest('[data-cat]').dataset.cat)">×ª×§×¦×™×‘: ${fc(budget)}</span><span>×”×•×¦×: ${fc(spent)}</span><span class="${diff<0?'over':'under'}">${diff>=0?'× ×•×ª×¨: '+fc(diff):'×—×¨×™×’×”: '+fc(Math.abs(diff))}</span>`;
    }
    const pbar=card.querySelector('.category-progress-bar');
    if(pbar&&budget>0){
      const pct=Math.min(Math.round(spent/budget*100),120);
      pbar.style.width=Math.min(pct,100)+'%';
      pbar.className='category-progress-bar '+(pct>100?'over':pct>80?'warn':'ok');
    }
    const sub=card.querySelector('.cat-subtotal');
    if(sub)sub.textContent=fc(spent);
  });
}

function addItem(catName){
  window._addItemCat=catName;
  const p1=D.config.partner1||'×©×•×ª×£ 1',p2=D.config.partner2||'×©×•×ª×£ 2';
  showModal(`<h3>â• ×”×•×¡×£ ×¤×¨×™×˜ ×—×“×©</h3>
    <p>×§×˜×’×•×¨×™×”: <strong>${esc(catName)}</strong></p>
    <div class="modal-field"><label>×©× ×”×¤×¨×™×˜</label><input class="modal-input" type="text" id="newItemName" placeholder="×œ×“×•×’××”: ×‘×™×˜×•×— ×“×™×¨×”"></div>
    <div class="modal-field"><label>×¡×¤×§ / ×—×‘×¨×”</label><input class="modal-input" type="text" id="newItemProvider" placeholder="×œ×“×•×’××”: ×‘×–×§, ×—×‘×¨×ª ×—×©××œ (×œ× ×—×•×‘×”)"></div>
    ${D.config.soloMode?'':`<div class="modal-field"><label>×©×™×™×š ×œ:</label><select id="newItemOwner" class="modal-input">${ownerSelectOpts('shared',p1,p2)}</select></div>`}
    <div class="modal-field"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="newItemFixed"> ğŸ”’ ×”×•×¦××” ×§×‘×•×¢×” <span style="font-size:.75rem;color:var(--text-secondary)">(×¡×›×•× ×–×”×” ×›×œ ×—×•×“×©, ××•×¢×ª×§ ××•×˜×•××˜×™×ª)</span></label></div>
    <div class="modal-field"><label>×¡×›×•×</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="newItemAmount" min="0" placeholder="0"></div></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="confirmAddItem()">×”×•×¡×£</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
  setTimeout(()=>{const i=document.getElementById('newItemName');if(i)i.focus()},250);
}

function confirmAddItem(){
  const catName=window._addItemCat;
  const name=(document.getElementById('newItemName').value||'').trim();
  if(!name){document.getElementById('newItemName').style.borderColor='var(--danger)';return}
  const amount=Math.max(0,parseInt(document.getElementById('newItemAmount').value)||0);
  const isFixed=document.getElementById('newItemFixed')?.checked||false;
  const owner=(document.getElementById('newItemOwner')||{}).value||'shared';
  const key=mk(curMonth,curYear);
  const provider=(document.getElementById('newItemProvider').value||'').trim();
  const newItem={name,amount,isDefault:false,owner};
  if(isFixed)newItem.fixed=true;
  if(provider)newItem.provider=provider;
  getMonth(key).expenses[catName].items.push(newItem);
  saveData();closeModal();renderBudgetKeepOpen();
  const card=document.querySelector(`[data-cat="${catName}"]`);if(card&&!card.classList.contains('expanded'))card.classList.add('expanded');
  toast(`"${name}" × ×•×¡×£${isFixed?' (×§×‘×•×¢ ğŸ”’)':''}`);
}

function quickAddRow(catName,idx){
  // Remove any existing quick-add panel
  const old=document.querySelector('.quick-add-panel');if(old)old.remove();
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[catName]?.items[idx];
  if(!item)return;
  // Find the row and insert panel after it
  const card=document.querySelector(`[data-cat="${catName}"]`);
  if(!card)return;
  const rows=card.querySelectorAll('tbody tr');
  const row=rows[idx];if(!row)return;
  const panel=document.createElement('tr');
  const esc2=catName.replace(/'/g,"\\'");
  panel.innerHTML=`<td colspan="4" style="padding:0"><div class="quick-add-panel">
    <input type="text" id="qapName" placeholder="×©× ×”×”×•×¦××” / ×‘×™×ª ×¢×¡×§" value="${esc(item.name)}" onkeydown="if(event.key==='Enter'){document.getElementById('qapAmount').focus()}" onkeyup="if(event.key==='Escape')this.closest('tr').remove()">
    <input type="number" id="qapAmount" min="0" placeholder="×¡×›×•×" value="" onkeydown="if(event.key==='Enter')confirmQuickAdd('${esc2}',${idx})" onkeyup="if(event.key==='Escape')this.closest('tr').remove()">
    <div class="qap-btns">
      <button class="qap-btn ok" onclick="confirmQuickAdd('${esc2}',${idx})">×”×•×¡×£</button>
      <button class="qap-btn cancel" onclick="this.closest('tr').remove()">âœ•</button>
    </div>
  </div></td>`;
  row.after(panel);
  setTimeout(()=>{const n=document.getElementById('qapName');if(n){n.focus();n.select()}},50);
}

function confirmQuickAdd(catName,idx){
  const nameVal=(document.getElementById('qapName')?.value||'').trim();
  const amount=Math.max(0,parseInt(document.getElementById('qapAmount')?.value)||0);
  if(!nameVal){toast('× × ×œ×”×–×™×Ÿ ×©×');return}
  pushUndo();
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const srcItem=data.expenses[catName]?.items[idx];
  // Set group on parent and child to link them
  const groupId=srcItem?.group||srcItem?.name||nameVal;
  if(srcItem&&!srcItem.group)srcItem.group=groupId;
  const newItem={name:nameVal,amount,isDefault:false,owner:srcItem?.owner||'shared',group:groupId};
  data.expenses[catName].items.splice(idx+1,0,newItem);
  saveData();renderBudgetKeepOpen();
  updateCategoryTotals(catName);updateSummary();
  toast(`"${nameVal}" â€” ${fc(amount)} × ×•×¡×£`);
}

function updateProviderInline(catName,idx,value){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[catName]?.items[idx];
  if(!item)return;
  item.provider=value.trim()||undefined;
  if(!item.provider)delete item.provider;
  saveData();
}

function removeItem(catName,idx){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[catName].items[idx];
  window._deleteItemCat=catName;window._deleteItemIdx=idx;
  showModal(`<h3>âš ï¸ ××—×™×§×ª ×¤×¨×™×˜</h3><p>×œ××—×•×§ ××ª "${esc(item.name)}"${item.provider?' ('+esc(item.provider)+')':''}?</p>
    <div class="modal-actions"><button class="modal-btn danger" onclick="confirmRemoveItem()">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function confirmRemoveItem(){
  pushUndo();
  const catName=window._deleteItemCat,idx=window._deleteItemIdx;
  getMonth(mk(curMonth,curYear)).expenses[catName].items.splice(idx,1);
  saveData();closeModal();renderBudgetKeepOpen();toast('×¤×¨×™×˜ × ××—×§');
}

function moveItem(catName,idx){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[catName].items[idx];
  const allCats=(D.config.categories||[]).filter(c=>c.name!==catName);
  let options=allCats.map(c=>`<button class="modal-btn" style="margin:4px;text-align:right;min-width:120px" onclick="confirmMoveItem('${esc(catName)}',${idx},'${esc(c.name)}')">${c.icon} ${esc(c.name)}</button>`).join('');
  // Add misc option
  options+=`<button class="modal-btn" style="margin:4px;text-align:right;min-width:120px" onclick="confirmMoveToMisc('${esc(catName)}',${idx})">ğŸ“¦ ×”×•×¦××•×ª ××—×¨×•×ª</button>`;
  showModal(`<h3>ğŸ“‚ ×”×¢×‘×¨×ª "${esc(item.name)}"</h3><p>×‘×—×¨×• ×™×¢×“:</p><div style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center">${options}</div>
    <div class="modal-actions"><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function confirmMoveItem(fromCat,idx,toCat){
  pushUndo();
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[fromCat].items.splice(idx,1)[0];
  // When moving to children category, ensure childId
  const toCatDef=(D.config.categories||[]).find(c=>c.name===toCat);
  if(toCatDef&&toCatDef.isChildrenCategory&&!item.childId){item.childId='shared'}
  // When moving FROM children category, remove childId
  if(!toCatDef||!toCatDef.isChildrenCategory){delete item.childId}
  if(!data.expenses[toCat])data.expenses[toCat]={budget:0,items:[]};
  data.expenses[toCat].items.push(item);
  saveData();closeModal();renderBudgetKeepOpen();toast(`"${item.name}" ×”×•×¢×‘×¨ ×œ-${toCat}`);
}
function confirmMoveToMisc(fromCat,idx){
  pushUndo();
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const item=data.expenses[fromCat].items.splice(idx,1)[0];
  if(!data.misc)data.misc={};
  data.misc[item.name]=item.amount||0;
  saveData();closeModal();renderBudgetKeepOpen();toast(`"${item.name}" ×”×•×¢×‘×¨ ×œ×”×•×¦××•×ª ××—×¨×•×ª`);
}
function moveMiscItem(itemName){
  const allCats=(D.config.categories||[]);
  let options=allCats.map(c=>`<button class="modal-btn" style="margin:4px;text-align:right;min-width:120px" onclick="confirmMoveMiscTo('${esc(itemName)}','${esc(c.name)}')">${c.icon} ${esc(c.name)}</button>`).join('');
  showModal(`<h3>ğŸ“‚ ×”×¢×‘×¨×ª "${esc(itemName)}"</h3><p>×‘×—×¨×• ×§×˜×’×•×¨×™×” ×™×¢×“:</p><div style="display:flex;flex-wrap:wrap;gap:4px;justify-content:center">${options}</div>
    <div class="modal-actions"><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function confirmMoveMiscTo(itemName,toCat){
  pushUndo();
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const amount=Number(data.misc[itemName])||0;
  delete data.misc[itemName];
  if(!data.expenses[toCat])data.expenses[toCat]={budget:0,items:[]};
  const newItem={name:itemName,amount,isDefault:false,owner:'shared'};
  const toCatDef=(D.config.categories||[]).find(c=>c.name===toCat);
  if(toCatDef&&toCatDef.isChildrenCategory)newItem.childId='shared';
  data.expenses[toCat].items.push(newItem);
  saveData();closeModal();renderBudgetKeepOpen();toast(`"${itemName}" ×”×•×¢×‘×¨ ×œ-${toCat}`);
}

function updateIncome(idx,field,value){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  if(field==='amount')data.income[idx].amount=Math.max(0,parseInt(value)||0);
  else data.income[idx].source=value;
  saveData();updateSummary();renderAlerts();
}
function toggleFixedIncome(idx){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const inc=data.income[idx];
  inc.fixed=!inc.fixed;
  propagateFixedIncome(inc.source,inc.fixed,inc.fixed?inc.amount:null,inc.owner);
  saveData();renderBudgetKeepOpen();
  toast(inc.fixed?`ğŸ”’ "${inc.source}" â€” ×”×›× ×¡×” ×§×‘×•×¢×” ×‘×›×œ ×”×—×•×“×©×™×`:`ğŸ”“ "${inc.source}" â€” ×”×›× ×¡×” ××©×ª× ×”`);
}
function updateFixedIncome(idx,value){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  const amt=Math.max(0,parseInt(value)||0);
  data.income[idx].amount=amt;
  propagateFixedIncome(data.income[idx].source,true,amt,data.income[idx].owner);
  saveData();updateSummary();renderAlerts();
}
function propagateFixedIncome(sourceName,isFixed,amount,owner){
  const currentKey=mk(curMonth,curYear);
  Object.entries(D.months).forEach(([mk2,mdata])=>{
    if(mk2<currentKey)return;
    if(!mdata.income)return;
    const match=mdata.income.find(i=>i.source===sourceName);
    if(match){
      match.fixed=isFixed;
      if(isFixed&&amount!=null)match.amount=amount;
      if(owner)match.owner=owner;
    }
  });
}

function addIncomeRow(){
  const p1=D.config.partner1||'×©×•×ª×£ 1',p2=D.config.partner2||'×©×•×ª×£ 2';
  showModal(`<h3>â• ×”×•×¡×£ ××§×•×¨ ×”×›× ×¡×”</h3>
    <div class="modal-field"><label>×©× ×”××§×•×¨</label><input class="modal-input" type="text" id="newIncSource" placeholder="×œ×“×•×’××”: ××©×›×•×¨×ª"></div>
    ${D.config.soloMode?'':`<div class="modal-field"><label>×©×™×™×š ×œ:</label><select id="newIncOwner" class="modal-input">${ownerSelectOpts('shared',p1,p2)}</select></div>`}
    <div class="modal-field"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="newIncFixed"> ğŸ”’ ×”×›× ×¡×” ×§×‘×•×¢×” <span style="font-size:.75rem;color:var(--text-secondary)">(×¡×›×•× ×–×”×” ×›×œ ×—×•×“×©, ××•×¢×ª×§ ××•×˜×•××˜×™×ª)</span></label></div>
    <div class="modal-field"><label>×¡×›×•×</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="newIncAmount" min="0" placeholder="0"></div></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="confirmAddIncome()">×”×•×¡×£</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
  setTimeout(()=>{const i=document.getElementById('newIncSource');if(i)i.focus()},250);
}

function confirmAddIncome(){
  const source=(document.getElementById('newIncSource').value||'').trim();
  if(!source){document.getElementById('newIncSource').style.borderColor='var(--danger)';return}
  const amount=Math.max(0,parseInt(document.getElementById('newIncAmount').value)||0);
  const owner=(document.getElementById('newIncOwner')||{}).value||'shared';
  const isFixed=document.getElementById('newIncFixed')?.checked||false;
  const newInc={source,amount,owner};
  if(isFixed)newInc.fixed=true;
  getMonth(mk(curMonth,curYear)).income.push(newInc);
  saveData();closeModal();renderBudgetKeepOpen();toast(`"${source}" × ×•×¡×£${isFixed?' (×§×‘×•×¢ ğŸ”’)':''}`);
}

function showIncomeDefaults(){
  const sources=D.config.incomeSources||[];
  let rows=sources.map((src,i)=>`
    <li style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)">
      <input class="modal-input" value="${esc(src.name)}" style="flex:1" id="incDef_name_${i}" placeholder="×©× ×”××§×•×¨">
      <input class="modal-input ltr" type="number" value="${src.defaultAmount||0}" min="0" style="width:100px;direction:ltr;text-align:right" id="incDef_amt_${i}" placeholder="×¡×›×•×">
      <button class="btn-sm danger" onclick="removeIncomeDefault(${i})">âœ•</button>
    </li>`).join('');
  showModal(`<h3>ğŸ’µ ×”×’×“×¨×•×ª ×”×›× ×¡×•×ª ×‘×¨×™×¨×ª ××—×“×œ</h3>
    <p style="font-size:.78rem;color:var(--text-secondary);margin-bottom:12px">××§×•×¨×•×ª ×”×”×›× ×¡×” ×•×¡×›×•××™ ×‘×¨×™×¨×ª ×”××—×“×œ ×©××•×¤×™×¢×™× ××•×˜×•××˜×™×ª ×‘×›×œ ×—×•×“×© ×—×“×©</p>
    <ul id="incDefaultsList" style="list-style:none;padding:0;margin:0 0 12px">${rows||'<li style="color:var(--text-light);text-align:center;padding:12px;font-size:.85rem">××™×Ÿ ××§×•×¨×•×ª ×‘×¨×™×¨×ª ××—×“×œ</li>'}</ul>
    <button class="add-item-btn" onclick="addIncomeDefault()" style="margin-bottom:16px">+ ×”×•×¡×£ ××§×•×¨</button>
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveIncomeDefaults()">×©××•×¨</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function addIncomeDefault(){
  D.config.incomeSources=D.config.incomeSources||[];
  D.config.incomeSources.push({name:'',defaultAmount:0});
  saveData();showIncomeDefaults();
}

function removeIncomeDefault(idx){
  D.config.incomeSources.splice(idx,1);
  saveData();showIncomeDefaults();
}

function saveIncomeDefaults(){
  const sources=D.config.incomeSources||[];
  sources.forEach((src,i)=>{
    const nameEl=document.getElementById('incDef_name_'+i);
    const amtEl=document.getElementById('incDef_amt_'+i);
    if(nameEl)src.name=nameEl.value.trim();
    if(amtEl)src.defaultAmount=parseInt(amtEl.value)||0;
  });
  D.config.incomeSources=sources.filter(s=>s.name);
  saveData();closeModal();toast('×”×’×“×¨×•×ª ×”×›× ×¡×•×ª × ×©××¨×•');
}

function removeIncome(idx){
  const inc=getMonth(mk(curMonth,curYear)).income[idx];
  window._deleteIncIdx=idx;
  showModal(`<h3>âš ï¸ ××—×™×§×ª ×”×›× ×¡×”</h3><p>×œ××—×•×§ ××ª "${esc(inc.source)}"?</p>
    <div class="modal-actions"><button class="modal-btn danger" onclick="confirmRemoveIncome()">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function confirmRemoveIncome(){
  pushUndo();
  getMonth(mk(curMonth,curYear)).income.splice(window._deleteIncIdx,1);
  saveData();closeModal();renderBudgetKeepOpen();toast('×”×›× ×¡×” × ××—×§×”');
}

function updateMisc(name,value){
  const data=getMonth(mk(curMonth,curYear));
  data.misc[name]=Math.max(0,parseInt(value)||0);
  // Update misc total
  const tc=document.getElementById('miscTotalCell');
  if(tc){let t=0;Object.values(data.misc).forEach(v=>t+=(Number(v)||0));tc.textContent=fc(t)}
  saveData();updateSummary();renderDiscretionary(data);
}

function addMiscItem(){
  showModal(`<h3>â• ×”×•×¡×£ ×¤×¨×™×˜ ×©×•× ×•×ª</h3>
    <div class="modal-field"><label>×©× ×”×¤×¨×™×˜</label><input class="modal-input" type="text" id="newMiscName" placeholder="×œ×“×•×’××”: ××ª× ×•×ª, ×ª×¨×•××•×ª"></div>
    <div class="modal-field"><label>×¡×›×•×</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="newMiscAmount" min="0" placeholder="0"></div></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="confirmAddMisc()">×”×•×¡×£</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
  setTimeout(()=>{const i=document.getElementById('newMiscName');if(i)i.focus()},250);
}

function confirmAddMisc(){
  const name=(document.getElementById('newMiscName').value||'').trim();
  if(!name){document.getElementById('newMiscName').style.borderColor='var(--danger)';return}
  const amount=Math.max(0,parseInt(document.getElementById('newMiscAmount').value)||0);
  const key=mk(curMonth,curYear);const data=getMonth(key);
  if(data.misc[name]!=null){toast('×¤×¨×™×˜ ×›×‘×¨ ×§×™×™×');return}
  data.misc[name]=amount;
  saveData();closeModal();renderBudgetKeepOpen();toast(`"${name}" × ×•×¡×£`);
}

function removeMiscItem(name){
  window._deleteMiscName=name;
  showModal(`<h3>âš ï¸ ××—×™×§×ª ×¤×¨×™×˜</h3><p>×œ××—×•×§ ××ª "${esc(name)}"?</p>
    <div class="modal-actions"><button class="modal-btn danger" onclick="confirmRemoveMisc()">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function confirmRemoveMisc(){
  pushUndo();
  const name=window._deleteMiscName;
  delete getMonth(mk(curMonth,curYear)).misc[name];
  saveData();closeModal();renderBudgetKeepOpen();toast('×¤×¨×™×˜ × ××—×§');
}

function updateSummary(){
  const key=mk(curMonth,curYear);
  const{income,expenses,savings,deposits}=calcTotals(key);
  document.getElementById('summaryIncome').textContent=fc(income);
  document.getElementById('summaryExpenses').textContent=fc(expenses);
  const se=document.getElementById('summarySavings');
  se.textContent=fc(savings);se.className='value '+(savings>=0?'savings-positive':'savings-negative');
  document.getElementById('summaryDeposits').textContent=fc(deposits);
  // Free/discretionary
  const data=D.months[key];
  let miscTotal=0,fixedSav=0;
  if(data&&data.misc)Object.values(data.misc).forEach(v=>miscTotal+=(Number(v)||0));
  fixedSav=(D.savings.fixedSavings||[]).reduce((a,s)=>a+(s.amount||0),0);
  const free=income-expenses-miscTotal-deposits-fixedSav;
  const sf=document.getElementById('summaryFree');
  if(sf){sf.textContent=fc(free);sf.className='value '+(free>=0?'savings-positive':'savings-negative')}
}

// ===== TAB SWITCHING =====
function switchTab(tab){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
  document.getElementById('summaryBar').style.display=tab==='budget'?'flex':'none';
  if(tab==='dashboard')updateDashboard();
  if(tab==='savings')renderSavings();
  if(tab==='manage'){renderAdmin();renderAllMonthsTable()}
}

// ===== SMART ALERTS =====
function renderAlerts(){
  const area=document.getElementById('alertsArea');
  if(!area)return;
  const key=mk(curMonth,curYear);
  const{income,expenses,savings}=calcTotals(key);
  const data=getMonth(key);
  const dismissed=D.settings.dismissedAlerts||[];
  const alerts=[];

  // Skip alerts if month has no actual data (all zeros)
  const hasAnyData=income>0||expenses>0;
  if(!hasAnyData){area.innerHTML='';return}

  // Over budget categories
  (D.config.categories||[]).forEach(cat=>{
    if(cat.isChildrenCategory&&D.config.children.length===0)return;
    if(cat.id==='pet'&&(!D.config.pet||!D.config.pet.enabled))return;
    if(cat.id==='events'&&!(D.config.events||[]).some(e=>e.enabled))return;
    const cd=data.expenses[cat.name];if(!cd)return;
    const p=cd.budget||0;
    let a=0;cd.items.forEach(i=>{a+=(i.amount||0)});
    if(p>0&&a>p){
      const id='over_'+cat.name+'_'+key;
      if(!dismissed.includes(id)) alerts.push({id,cls:'red',text:`ğŸ”´ ${cat.name}: ×—×¨×™×’×” ×©×œ ${fc(a-p)} ××¢×œ ×”×ª×§×¦×™×‘`,notify:true});
    }
    // Warning at 80% of budget
    if(p>0&&a>=p*0.8&&a<=p){
      const id='warn_'+cat.name+'_'+key;
      if(!dismissed.includes(id)) alerts.push({id,cls:'amber',text:`âš ï¸ ${cat.name}: ${Math.round(a/p*100)}% ××”×ª×§×¦×™×‘ × ×•×¦×œ (${fc(p-a)} × ×•×ª×¨×•)`});
    }
  });

  // Total expenses vs income warning
  if(income>0&&expenses>income){
    const id='total_over_'+key;
    if(!dismissed.includes(id)) alerts.push({id,cls:'red',text:`ğŸš¨ ×¡×”"×› ×”×•×¦××•×ª (${fc(expenses)}) ×—×•×¨×’×•×ª ××”×”×›× ×¡×” (${fc(income)}) ×‘-${fc(expenses-income)}`,notify:true});
  }

  // Good savings
  if(income>0&&savings/income>=0.2){
    const id='good_savings_'+key;
    if(!dismissed.includes(id)) alerts.push({id,cls:'green',text:`ğŸŸ¢ ×›×œ ×”×›×‘×•×“! ×—×•×¡×›×™× ${Math.round(savings/income*100)}% ××”×”×›× ×¡×”`});
  }

  // Positive balance
  if(income>0&&savings>0&&savings/income<0.2&&savings/income>=0.05){
    const id='positive_'+key;
    if(!dismissed.includes(id)) alerts.push({id,cls:'green',text:`âœ… × ×©××¨ ${fc(savings)} (${Math.round(savings/income*100)}% ××”×”×›× ×¡×”) â€” ×¢×•×“ ×§×¦×ª ×•×ª×’×™×¢×• ×œ-20%!`});
  }

  // Daily burn rate
  const day=new Date().getDate();
  const daysInMonth=new Date(curYear,curMonth+1,0).getDate();
  if(income>0&&day>1&&curYear===new Date().getFullYear()&&curMonth===new Date().getMonth()){
    const dailyRate=expenses/day;
    const projected=dailyRate*daysInMonth;
    if(projected>income){
      const id='burn_'+key;
      if(!dismissed.includes(id)) alerts.push({id,cls:'amber',text:`ğŸŸ¡ ×‘×§×¦×‘ ×”× ×•×›×—×™ ×”×”×•×¦××•×ª ×™×’×™×¢×• ×œ-${fc(Math.round(projected))} ×¢×“ ×¡×•×£ ×”×—×•×“×©`});
    }
    // Daily budget remaining
    const remainingDays=daysInMonth-day;
    if(remainingDays>0&&income>expenses){
      const dailyBudget=Math.round((income-expenses)/remainingDays);
      const id='daily_'+key+'_'+day;
      if(!dismissed.includes(id)&&dailyBudget>0) alerts.push({id,cls:'blue',text:`ğŸ’¡ ×ª×§×¦×™×‘ ×™×•××™ ×©× ×•×ª×¨: ${fc(dailyBudget)} ×œ×™×•× (${remainingDays} ×™××™× ×¢×“ ×¡×•×£ ×”×—×•×“×©)`});
    }
  }

  // MoM category increase
  const prevKey=curMonth>0?mk(curMonth-1,curYear):mk(11,curYear-1);
  if(D.months[prevKey]){
    (D.config.categories||[]).forEach(cat=>{
      if(cat.isChildrenCategory&&D.config.children.length===0)return;
      if(cat.id==='pet'&&(!D.config.pet||!D.config.pet.enabled))return;
      if(cat.id==='events'&&!(D.config.events||[]).some(e=>e.enabled))return;
      const cd=data.expenses[cat.name],pd=(D.months[prevKey].expenses||{})[cat.name];
      if(!cd||!pd)return;
      let curA=0,prevA=0;
      cd.items.forEach(i=>curA+=(i.amount||0));
      pd.items.forEach(i=>prevA+=(i.amount||0));
      if(prevA>0&&curA>prevA*1.15){
        const pct=Math.round((curA-prevA)/prevA*100);
        const id='increase_'+cat.name+'_'+key;
        if(!dismissed.includes(id)) alerts.push({id,cls:'blue',text:`ğŸ”µ ${cat.name} ×¢×œ×• ×‘-${pct}% ×œ×¢×•××ª ×—×•×“×© ×§×•×“×`});
      }
    });
  }

  // Upcoming events alerts
  const evMonthNum=curMonth+1;
  (D.config.events||[]).forEach(evt=>{
    if(!evt.enabled)return;
    if(evt.month===evMonthNum){
      const id='event_'+evt.id+'_'+key;
      const dayTxt=evt.day?` (${evt.day} ×‘${HM[curMonth]})`:'';
      if(!dismissed.includes(id)) alerts.push({id,cls:'blue',text:`${evt.emoji||'ğŸ“…'} ××™×¨×•×¢ ×”×—×•×“×©: ${evt.name}${dayTxt}${evt.estimatedBudget?' â€” ×ª×§×¦×™×‘: '+fc(evt.estimatedBudget):''}`});
    }
    const nextM=curMonth===11?0:curMonth+1;
    if(evt.month===nextM+1){
      const id='event_next_'+evt.id+'_'+key;
      if(!dismissed.includes(id)) alerts.push({id,cls:'blue',text:`${evt.emoji||'ğŸ“…'} ×‘×—×•×“×© ×”×‘×: ${evt.name} (${HM[nextM]})`});
    }
  });

  // Children alerts
  if(D.config.children.length>0&&D.months[prevKey]){
    const childCat=D.config.categories.find(c=>c.isChildrenCategory);
    if(childCat){
      D.config.children.forEach(child=>{
        const cd=data.expenses[childCat.name];
        const pd=(D.months[prevKey].expenses||{})[childCat.name];
        if(!cd||!pd)return;
        let curA=0,prevA=0;
        cd.items.filter(i=>i.childId===child.id).forEach(i=>curA+=(i.amount||0));
        pd.items.filter(i=>i.childId===child.id).forEach(i=>prevA+=(i.amount||0));
        if(prevA>0&&curA>prevA*1.15){
          const id='child_'+child.id+'_'+key;
          if(!dismissed.includes(id)) alerts.push({id,cls:'blue',text:`ğŸ‘¶ ×”×•×¦××•×ª ${child.name} ×¢×œ×• ×‘-${Math.round((curA-prevA)/prevA*100)}% ×”×—×•×“×©`});
        }
      });
    }
  }

  // Send browser notification for critical alerts
  sendBudgetNotifications(alerts.filter(a=>a.notify&&!dismissed.includes(a.id+'_notified')));

  area.innerHTML=alerts.slice(0,5).map(a=>`
    <div class="alert-banner ${a.cls}">
      <span>${a.text}</span>
      <button class="alert-close" onclick="dismissAlert('${a.id}')">âœ•</button>
    </div>
  `).join('');

  // Update alert badge on budget tab
  const badge=document.getElementById('alertBadge');
  const activeAlerts=alerts.filter(a=>!dismissed.includes(a.id));
  if(badge){
    if(activeAlerts.length>0){badge.textContent=activeAlerts.length;badge.style.display='flex'}
    else{badge.style.display='none'}
  }
}

function sendBudgetNotifications(criticalAlerts){
  if(!('Notification' in window)||Notification.permission!=='granted')return;
  criticalAlerts.forEach(a=>{
    const nKey=a.id+'_notified';
    if(D.settings.dismissedAlerts.includes(nKey))return;
    try{new Notification('×ª×§×¦×™×‘ ××©×¤×—×ª×™',{body:a.text.replace(/[ğŸ”´ğŸš¨âš ï¸ğŸŸ¢ğŸŸ¡ğŸ”µğŸ’¡ğŸ‘¶âœ…]/g,'').trim(),icon:'ğŸ’°',dir:'rtl',tag:a.id})}catch(e){}
    D.settings.dismissedAlerts.push(nKey);
  });
}

function requestNotificationPermission(){
  if(!('Notification' in window))return;
  if(Notification.permission==='default'){
    Notification.requestPermission();
  }
}

function dismissAlert(id){
  D.settings.dismissedAlerts.push(id);saveData();renderAlerts();
}

// ===== DASHBOARD =====
function updateDashboard(){
  const month=parseInt(document.getElementById('dashMonthSelect').value);
  const year=parseInt(document.getElementById('dashYearInput').value);
  const key=mk(month,year);
  const data=getMonth(key);
  const{income,expenses,savings,deposits}=calcTotals(key);
  const savPct=income>0?Math.round(savings/income*100):0;

  // MoM calculations
  const prevKey=month>0?mk(month-1,year):mk(11,year-1);
  const prev=D.months[prevKey]?calcTotals(prevKey):{income:0,expenses:0,savings:0};
  function mom(cur,prv){if(!prv)return '';const pct=Math.round((cur-prv)/Math.abs(prv||1)*100);return pct>0?`<div class="kpi-mom down">â–² ${pct}%</div>`:(pct<0?`<div class="kpi-mom up">â–¼ ${Math.abs(pct)}%</div>`:'')}

  // KPIs
  const ringColor=savings>=0?'var(--success)':'var(--danger)';
  const ringPct=Math.max(0,Math.min(100,Math.abs(savPct)));
  const circ=2*Math.PI*26;
  const dash=circ-(ringPct/100)*circ;

  document.getElementById('kpiGrid').innerHTML=`
    <div class="kpi-card blue"><div class="kpi-label">×¡×”×´×› ×”×›× ×¡×•×ª</div><div class="kpi-value">${fc(income)}</div>${prev.income?mom(income,prev.income):''}</div>
    <div class="kpi-card ${expenses>income?'red':'amber'}"><div class="kpi-label">×¡×”×´×› ×”×•×¦××•×ª</div><div class="kpi-value">${fc(expenses)}</div>${prev.expenses?mom(expenses,prev.expenses):''}</div>
    <div class="kpi-card ${savings>=0?'green':'red'}"><div class="kpi-label">×—×™×¡×›×•×Ÿ</div><div class="kpi-value">${fc(savings)}</div></div>
    <div class="kpi-card ${savings>=0?'green':'red'}"><div class="kpi-label">××—×•×– ×—×™×¡×›×•×Ÿ</div>
      <div class="savings-ring"><svg width="60" height="60" viewBox="0 0 64 64"><circle cx="32" cy="32" r="26" fill="none" stroke="var(--border-light)" stroke-width="5"/><circle cx="32" cy="32" r="26" fill="none" stroke="${ringColor}" stroke-width="5" stroke-dasharray="${circ}" stroke-dashoffset="${dash}" stroke-linecap="round"/></svg><span class="ring-text" style="color:${ringColor}">${savPct}%</span></div>
    </div>`;

  // Category data (skip hidden categories)
  const catNames=[],catActuals=[],catBudgets=[];
  (D.config.categories||[]).forEach(cat=>{
    if(cat.isChildrenCategory&&D.config.children.length===0)return;
    if(cat.id==='pet'&&(!D.config.pet||!D.config.pet.enabled))return;
    if(cat.id==='events'&&!(D.config.events||[]).some(e=>e.enabled))return;
    const cd=data.expenses[cat.name];if(!cd)return;
    let a=0;cd.items.forEach(i=>{a+=(i.amount||0)});
    const b=cd.budget||0;
    if(a>0||b>0){catNames.push(cat.name);catActuals.push(a);catBudgets.push(b)}
  });

  // Chart 1: Doughnut
  renderChart('chartDoughnut','doughnut',{labels:catNames,datasets:[{data:catActuals,backgroundColor:CC.slice(0,catNames.length),borderWidth:2,borderColor:getComputedStyle(document.documentElement).getPropertyValue('--card')}]},{plugins:{legend:{position:'bottom',labels:{font:{family:'Heebo',size:11},padding:10,color:getComputedStyle(document.documentElement).getPropertyValue('--text')}},tooltip:{callbacks:{label:ctx=>{const t=ctx.dataset.data.reduce((a,b)=>a+b,0);return `${ctx.label}: ${fc(ctx.parsed)} (${t>0?Math.round(ctx.parsed/t*100):0}%)`}}}}});

  // Chart 2: Horizontal Bar
  renderChart('chartBar','bar',{labels:catNames,datasets:[
    {label:'×ª×§×¦×™×‘',data:catBudgets,backgroundColor:'#93C5FD',borderRadius:4},
    {label:'×‘×¤×•×¢×œ',data:catActuals,backgroundColor:catActuals.map((v,i)=>v>catBudgets[i]?'#EF4444':'#2563EB'),borderRadius:4}
  ]},{indexAxis:'y',plugins:{legend:{position:'top',labels:{font:{family:'Heebo'},color:getComputedStyle(document.documentElement).getPropertyValue('--text')}},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${fc(ctx.parsed.x)}`}}},scales:{x:{beginAtZero:true,ticks:{callback:v=>fc(v),color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}},y:{ticks:{font:{family:'Heebo',size:11},color:getComputedStyle(document.documentElement).getPropertyValue('--text')}}}});

  // Chart 3: Line
  const lineL=[],lineD=[];
  for(let m=0;m<12;m++){const k=mk(m,year);lineL.push(HM[m]);lineD.push(D.months[k]?calcTotals(k).savings:null)}
  renderChart('chartLine','line',{labels:lineL,datasets:[{label:'×—×™×¡×›×•×Ÿ',data:lineD,borderColor:'#16A34A',backgroundColor:'rgba(22,163,74,.1)',fill:true,tension:.3,pointRadius:5,pointBackgroundColor:lineD.map(v=>v!==null&&v<0?'#EF4444':'#16A34A'),spanGaps:false}]},{plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`×—×™×¡×›×•×Ÿ: ${fc(ctx.parsed.y)}`}}},scales:{y:{ticks:{callback:v=>fc(v),color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}},x:{ticks:{font:{family:'Heebo',size:11},color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}}}});

  // Chart 4: Stacked (skip hidden categories)
  const allCats=(D.config.categories||[]).filter(c=>{
    if(c.isChildrenCategory&&D.config.children.length===0)return false;
    if(c.id==='pet'&&(!D.config.pet||!D.config.pet.enabled))return false;
    return true;
  }).map(c=>c.name);
  const sDS=allCats.map((cn,ci)=>({label:cn,data:[],backgroundColor:CC[ci%CC.length],borderRadius:2}));
  const sL=[];
  for(let m=0;m<12;m++){const k=mk(m,year);sL.push(HM[m]);allCats.forEach((cn,ci)=>{let t=0;if(D.months[k]&&D.months[k].expenses[cn])(D.months[k].expenses[cn].items||[]).forEach(i=>t+=(i.amount||0));sDS[ci].data.push(t)})}
  renderChart('chartStacked','bar',{labels:sL,datasets:sDS},{plugins:{legend:{position:'bottom',labels:{font:{family:'Heebo',size:10},padding:8,color:getComputedStyle(document.documentElement).getPropertyValue('--text')}},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${fc(ctx.parsed.y)}`}}},scales:{x:{stacked:true,ticks:{font:{family:'Heebo',size:11},color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}},y:{stacked:true,ticks:{callback:v=>fc(v),color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}}}});

  // Children chart
  const childCat=D.config.categories.find(c=>c.isChildrenCategory);
  const childCard=document.getElementById('childrenChartCard');
  if(childCat&&D.config.children.length>0&&data.expenses[childCat.name]){
    childCard.style.display='';
    const cd=data.expenses[childCat.name];
    const childLabels=[],childData=[];
    D.config.children.forEach(ch=>{
      let t=0;cd.items.filter(i=>i.childId===ch.id).forEach(i=>t+=(i.amount||0));
      childLabels.push(ch.name);childData.push(t);
    });
    let sharedT=0;cd.items.filter(i=>i.childId==='shared'||!i.childId).forEach(i=>sharedT+=(i.amount||0));
    childLabels.push('××©×•×ª×£');childData.push(sharedT);
    renderChart('chartChildren','bar',{labels:childLabels,datasets:[{label:'×”×•×¦××•×ª',data:childData,backgroundColor:CC,borderRadius:6}]},{plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>fc(ctx.parsed.y)}}},scales:{y:{ticks:{callback:v=>fc(v),color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}}}});
  }else{childCard.style.display='none'}

  // Pet chart
  const petCat=D.config.categories.find(c=>c.id==='pet');
  const petCard=document.getElementById('petChartCard');
  if(petCat&&D.config.pet&&D.config.pet.enabled&&data.expenses[petCat.name]){
    petCard.style.display='';
    const pd=data.expenses[petCat.name];
    const petLabels=[],petData=[];
    (pd.items||[]).forEach(i=>{if((i.amount||0)>0){petLabels.push(i.name);petData.push(i.amount)}});
    if(petLabels.length>0){
      renderChart('chartPet','doughnut',{labels:petLabels,datasets:[{data:petData,backgroundColor:['#F59E0B','#10B981','#6366F1','#EC4899','#8B5CF6'],borderWidth:2,borderColor:getComputedStyle(document.documentElement).getPropertyValue('--card')}]},{plugins:{legend:{position:'bottom',labels:{font:{family:'Heebo',size:11},color:getComputedStyle(document.documentElement).getPropertyValue('--text')}},tooltip:{callbacks:{label:ctx=>fc(ctx.parsed)}}}});
    }else{petCard.style.display='none'}
  }else{petCard.style.display='none'}

  // Yearly income vs expenses trend
  const yIncL=[],yExpL=[],yLabels=[];
  for(let m=0;m<12;m++){const k=mk(m,year);yLabels.push(HM[m]);const t=D.months[k]?calcTotals(k):{income:0,expenses:0};yIncL.push(t.income);yExpL.push(t.expenses)}
  renderChart('chartYearly','line',{labels:yLabels,datasets:[
    {label:'×”×›× ×¡×•×ª',data:yIncL,borderColor:'#16A34A',backgroundColor:'rgba(22,163,74,.08)',fill:true,tension:.3,pointRadius:4},
    {label:'×”×•×¦××•×ª',data:yExpL,borderColor:'#EF4444',backgroundColor:'rgba(239,68,68,.08)',fill:true,tension:.3,pointRadius:4}
  ]},{plugins:{legend:{position:'top',labels:{font:{family:'Heebo'},color:getComputedStyle(document.documentElement).getPropertyValue('--text')}},tooltip:{callbacks:{label:ctx=>`${ctx.dataset.label}: ${fc(ctx.parsed.y)}`}}},scales:{y:{ticks:{callback:v=>fc(v),color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}},x:{ticks:{font:{family:'Heebo',size:11},color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}}}});

  // Savings deposits chart
  const savCard=document.getElementById('savingsChartCard');
  const savLabels=[],savData=[];
  for(let m=0;m<12;m++){const k=mk(m,year);savLabels.push(HM[m]);let dep=0;if(D.months[k])Object.values(D.months[k].savingsContributions||{}).forEach(v=>dep+=v);savData.push(dep)}
  if(savData.some(v=>v>0)){
    savCard.style.display='';
    renderChart('chartSavings','bar',{labels:savLabels,datasets:[{label:'×”×¤×§×“×•×ª',data:savData,backgroundColor:'#16A34A',borderRadius:6}]},{plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`×”×¤×§×“×”: ${fc(ctx.parsed.y)}`}}},scales:{y:{ticks:{callback:v=>fc(v),color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}},x:{ticks:{font:{family:'Heebo',size:11},color:getComputedStyle(document.documentElement).getPropertyValue('--text-secondary')}}}});
  }else{savCard.style.display='none'}

  // Health Score
  renderHealthScore(income,expenses,savings);
  // Personal Comparison
  renderComparison(data);
}

// ===== HEALTH SCORE =====
function renderHealthScore(income,expenses,savings){
  const container=document.getElementById('healthScoreContainer');
  let score=0;
  // Savings rate (25pts)
  const sr=income>0?savings/income:0;
  if(sr>=0.2)score+=25;else if(sr>=0.1)score+=15;else if(sr>0)score+=5;
  // Budget adherence (25pts)
  const key=mk(curMonth,curYear);const data=getMonth(key);
  let overCount=0,catCount=0;
  (D.config.categories||[]).forEach(cat=>{
    if(cat.isChildrenCategory&&D.config.children.length===0)return;
    if(cat.id==='pet'&&(!D.config.pet||!D.config.pet.enabled))return;
    if(cat.id==='events'&&!(D.config.events||[]).some(e=>e.enabled))return;
    const cd=data.expenses[cat.name];if(!cd)return;
    const p=cd.budget||0;
    let a=0;cd.items.forEach(i=>{a+=(i.amount||0)});
    if(p>0){catCount++;if(a>p*1.1)overCount++}
  });
  const adherence=catCount>0?(catCount-overCount)/catCount:1;
  if(adherence>=0.9)score+=25;else if(adherence>=0.7)score+=15;else if(adherence>=0.5)score+=5;
  // Emergency fund (25pts)
  const ef=D.savings.emergency;
  if(ef&&ef.target>0){
    const epct=ef.current/ef.target;
    if(epct>=1)score+=25;else if(epct>=0.5)score+=15;else if(epct>=0.25)score+=5;
  }else score+=12;
  // Savings contributions (25pts)
  const contrib=Object.values((data.savingsContributions||{})).reduce((a,b)=>a+b,0);
  if(contrib>0)score+=25;else score+=5;

  const color=score>=80?'var(--success)':score>=60?'var(--warning)':'var(--danger)';
  const label=score>=80?'××¦×•×™×Ÿ':score>=60?'×˜×•×‘':score>=40?'×¡×‘×™×¨':'×“×•×¨×© ×©×™×¤×•×¨';
  const circ=2*Math.PI*40;
  const dash=circ-(score/100)*circ;

  container.innerHTML=`
    <div class="health-gauge">
      <svg width="100" height="100" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="none" stroke="var(--border-light)" stroke-width="8"/><circle cx="50" cy="50" r="40" fill="none" stroke="${color}" stroke-width="8" stroke-dasharray="${circ}" stroke-dashoffset="${dash}" stroke-linecap="round" style="transform:rotate(-90deg);transform-origin:center;transition:stroke-dashoffset 1s ease"/></svg>
      <div class="gauge-text"><div class="gauge-score" style="color:${color}">${score}</div><div class="gauge-label">${label}</div></div>
    </div>
    <div style="font-size:.75rem;color:var(--text-secondary);text-align:center;margin-top:4px">×—×™×¡×›×•×Ÿ: ${Math.round(sr*100)}% | ×”×ª×××”: ${Math.round(adherence*100)}%</div>`;
}

// ===== PERSONAL COMPARISON =====
function renderComparison(data){
  const container=document.getElementById('comparisonContainer');
  const p1=D.config.partner1,p2=D.config.partner2;
  if(!p1&&!p2){container.innerHTML='<p style="text-align:center;color:var(--text-secondary);font-size:.85rem">×”×’×“×™×¨×• ×©××•×ª ×‘×”×’×“×¨×•×ª</p>';return}

  let t1=0,t2=0,shared=0,children=0;
  Object.entries(data.expenses||{}).forEach(([catName,cd])=>{
    const cat=D.config.categories.find(c=>c.name===catName);
    if(cat&&cat.isChildrenCategory){
      cd.items.forEach(i=>children+=(i.amount||0));return;
    }
    cd.items.forEach(i=>{
      const a=i.amount||0;
      if(p1&&i.name.includes(p1))t1+=a;
      else if(p2&&i.name.includes(p2))t2+=a;
      else shared+=a;
    });
  });

  const max=Math.max(t1,t2,shared,children,1);
  container.innerHTML=`
    <div style="font-size:.82rem">
      ${p1?`<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>${p1}</span><span style="font-weight:600">${fc(t1)}</span></div><div style="height:8px;background:var(--border-light);border-radius:4px"><div style="height:100%;width:${t1/max*100}%;background:var(--primary);border-radius:4px"></div></div></div>`:''}
      ${p2?`<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>${p2}</span><span style="font-weight:600">${fc(t2)}</span></div><div style="height:8px;background:var(--border-light);border-radius:4px"><div style="height:100%;width:${t2/max*100}%;background:#7C3AED;border-radius:4px"></div></div></div>`:''}
      <div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>××©×•×ª×£</span><span style="font-weight:600">${fc(shared)}</span></div><div style="height:8px;background:var(--border-light);border-radius:4px"><div style="height:100%;width:${shared/max*100}%;background:var(--success);border-radius:4px"></div></div></div>
      ${children>0?`<div><div style="display:flex;justify-content:space-between;margin-bottom:3px"><span>×™×œ×“×™×</span><span style="font-weight:600">${fc(children)}</span></div><div style="height:8px;background:var(--border-light);border-radius:4px"><div style="height:100%;width:${children/max*100}%;background:var(--warning);border-radius:4px"></div></div></div>`:''}
    </div>`;
}

function renderChart(id,type,data,options){
  if(typeof Chart==='undefined')return;
  if(charts[id])charts[id].destroy();
  const ctx=document.getElementById(id);if(!ctx)return;
  charts[id]=new Chart(ctx.getContext('2d'),{type,data,options:{responsive:true,maintainAspectRatio:true,...options}});
}

// ===== YEARLY DASHBOARD =====
let dashView='month';
function switchDashView(view){
  dashView=view;
  document.getElementById('dashViewMonth').classList.toggle('active',view==='month');
  document.getElementById('dashViewYear').classList.toggle('active',view==='year');
  document.getElementById('dashMonthlySelectors').style.display=view==='month'?'':'none';
  document.getElementById('dashYearlySelectors').style.display=view==='year'?'flex':'none';
  document.getElementById('dashMonthlyView').style.display=view==='month'?'':'none';
  document.getElementById('dashYearlyView').style.display=view==='year'?'':'none';
  if(view==='year'){
    document.getElementById('dashYearlyYear').value=curYear;
    document.getElementById('dashYearlyCompare').value=curYear-1;
    updateYearlyDashboard();
  }
}

function calcYearTotals(year){
  let inc=0,exp=0,dep=0;
  const monthly=[];
  for(let m=0;m<12;m++){
    const k=mk(m,year);
    const t=D.months[k]?calcTotals(k):{income:0,expenses:0,savings:0,deposits:0};
    inc+=t.income;exp+=t.expenses;dep+=t.deposits;
    monthly.push(t);
  }
  return{income:inc,expenses:exp,savings:inc-exp,deposits:dep,monthly};
}

function calcYearCatTotals(year){
  const catTotals={};
  (D.config.categories||[]).forEach(cat=>{catTotals[cat.name]=0});
  for(let m=0;m<12;m++){
    const k=mk(m,year);
    const d=D.months[k];if(!d)continue;
    Object.entries(d.expenses||{}).forEach(([cn,cd])=>{
      if(!catTotals[cn])catTotals[cn]=0;
      (cd.items||[]).forEach(it=>catTotals[cn]+=(it.amount||0));
    });
  }
  return catTotals;
}

function updateYearlyDashboard(){
  const year=parseInt(document.getElementById('dashYearlyYear').value)||curYear;
  const cmpYear=parseInt(document.getElementById('dashYearlyCompare').value)||(year-1);
  const cur=calcYearTotals(year);
  const prev=calcYearTotals(cmpYear);
  const activeMonths=cur.monthly.filter(m=>m.income>0||m.expenses>0).length||1;
  const avgInc=Math.round(cur.income/activeMonths);
  const avgExp=Math.round(cur.expenses/activeMonths);

  // Yearly KPIs
  function yoyPct(c,p){if(!p)return '';const pct=Math.round((c-p)/Math.abs(p||1)*100);return pct>0?`<div class="kpi-mom down">â–² ${pct}% vs ${cmpYear}</div>`:pct<0?`<div class="kpi-mom up">â–¼ ${Math.abs(pct)}% vs ${cmpYear}</div>`:'';}
  document.getElementById('yearlyKpiGrid').innerHTML=`
    <div class="kpi-card blue"><div class="kpi-label">×”×›× ×¡×•×ª ×©× ×ª×™×•×ª</div><div class="kpi-value">${fc(cur.income)}</div>${prev.income?yoyPct(cur.income,prev.income):''}<div style="font-size:.72rem;color:var(--text-secondary)">×××•×¦×¢ ${fc(avgInc)}/×—×•×“×©</div></div>
    <div class="kpi-card ${cur.expenses>cur.income?'red':'amber'}"><div class="kpi-label">×”×•×¦××•×ª ×©× ×ª×™×•×ª</div><div class="kpi-value">${fc(cur.expenses)}</div>${prev.expenses?yoyPct(cur.expenses,prev.expenses):''}<div style="font-size:.72rem;color:var(--text-secondary)">×××•×¦×¢ ${fc(avgExp)}/×—×•×“×©</div></div>
    <div class="kpi-card ${cur.savings>=0?'green':'red'}"><div class="kpi-label">×—×™×¡×›×•×Ÿ ×©× ×ª×™</div><div class="kpi-value">${fc(cur.savings)}</div>${prev.savings?yoyPct(cur.savings,prev.savings):''}</div>
    <div class="kpi-card blue"><div class="kpi-label">×”×¤×§×“×•×ª ×©× ×ª×™×•×ª</div><div class="kpi-value">${fc(cur.deposits)}</div>${prev.deposits?yoyPct(cur.deposits,prev.deposits):''}</div>`;

  // Chart 1: Year comparison â€” income & expenses lines
  const labels=HM;
  renderChart('chartYearCompare','line',{
    labels,
    datasets:[
      {label:`×”×›× ×¡×•×ª ${year}`,data:cur.monthly.map(m=>m.income),borderColor:'#16A34A',backgroundColor:'rgba(22,163,74,.08)',fill:false,tension:.3,pointRadius:3},
      {label:`×”×•×¦××•×ª ${year}`,data:cur.monthly.map(m=>m.expenses),borderColor:'#EF4444',backgroundColor:'rgba(239,68,68,.08)',fill:false,tension:.3,pointRadius:3},
      {label:`×”×›× ×¡×•×ª ${cmpYear}`,data:prev.monthly.map(m=>m.income),borderColor:'#16A34A',borderDash:[5,5],backgroundColor:'transparent',fill:false,tension:.3,pointRadius:2},
      {label:`×”×•×¦××•×ª ${cmpYear}`,data:prev.monthly.map(m=>m.expenses),borderColor:'#EF4444',borderDash:[5,5],backgroundColor:'transparent',fill:false,tension:.3,pointRadius:2}
    ]
  },{plugins:{legend:{display:true,position:'bottom',labels:{font:{size:11}}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>fc(v)}}}});

  // Chart 2: Savings comparison
  renderChart('chartYearSavings','bar',{
    labels,
    datasets:[
      {label:`×—×™×¡×›×•×Ÿ ${year}`,data:cur.monthly.map(m=>m.savings),backgroundColor:cur.monthly.map(m=>m.savings>=0?'rgba(22,163,74,.7)':'rgba(239,68,68,.7)'),borderRadius:4},
      {label:`×—×™×¡×›×•×Ÿ ${cmpYear}`,data:prev.monthly.map(m=>m.savings),backgroundColor:prev.monthly.map(m=>m.savings>=0?'rgba(22,163,74,.25)':'rgba(239,68,68,.25)'),borderRadius:4}
    ]
  },{plugins:{legend:{display:true,position:'bottom'}},scales:{y:{ticks:{callback:v=>fc(v)}}}});

  // Chart 3: Yearly expense doughnut
  const catTotals=calcYearCatTotals(year);
  const catLabels=[],catVals=[],catColors=[];
  const palette=['#6366F1','#F59E0B','#10B981','#EF4444','#8B5CF6','#EC4899','#14B8A6','#F97316','#06B6D4','#84CC16','#A855F7','#E11D48'];
  let ci=0;
  (D.config.categories||[]).forEach(cat=>{
    const v=catTotals[cat.name]||0;
    if(v>0){catLabels.push(cat.icon+' '+cat.name);catVals.push(v);catColors.push(palette[ci%palette.length])}
    ci++;
  });
  renderChart('chartYearDoughnut','doughnut',{labels:catLabels,datasets:[{data:catVals,backgroundColor:catColors}]},{plugins:{legend:{display:true,position:'bottom',labels:{font:{size:10}}}}});

  // Chart 4: Category comparison bar chart (current year vs compare year)
  const prevCatTotals=calcYearCatTotals(cmpYear);
  const compLabels=[],compCur=[],compPrev=[];
  (D.config.categories||[]).forEach(cat=>{
    const cv=catTotals[cat.name]||0;
    const pv=prevCatTotals[cat.name]||0;
    if(cv>0||pv>0){compLabels.push(cat.icon+' '+cat.name);compCur.push(cv);compPrev.push(pv)}
  });
  renderChart('chartYearCatCompare','bar',{
    labels:compLabels,
    datasets:[
      {label:`${year}`,data:compCur,backgroundColor:'rgba(99,102,241,.7)',borderRadius:4},
      {label:`${cmpYear}`,data:compPrev,backgroundColor:'rgba(99,102,241,.25)',borderRadius:4}
    ]
  },{indexAxis:'y',plugins:{legend:{display:true,position:'bottom'}},scales:{x:{ticks:{callback:v=>fc(v)}}}});

  // Monthly summary table
  let tbl=`<div style="overflow-x:auto"><table class="yearly-table"><thead><tr><th>×—×•×“×©</th><th>×”×›× ×¡×•×ª</th><th>×”×•×¦××•×ª</th><th>×—×™×¡×›×•×Ÿ</th><th>×”×¤×§×“×•×ª</th></tr></thead><tbody>`;
  let totInc=0,totExp=0,totSav=0,totDep=0;
  for(let m=0;m<12;m++){
    const t=cur.monthly[m];
    totInc+=t.income;totExp+=t.expenses;totSav+=t.savings;totDep+=t.deposits;
    if(t.income===0&&t.expenses===0)continue;
    tbl+=`<tr><td>${HM[m]}</td><td>${fc(t.income)}</td><td>${fc(t.expenses)}</td><td class="${t.savings>=0?'positive':'negative'}">${fc(t.savings)}</td><td>${fc(t.deposits)}</td></tr>`;
  }
  tbl+=`<tr><td>×¡×”×´×›</td><td>${fc(totInc)}</td><td>${fc(totExp)}</td><td class="${totSav>=0?'positive':'negative'}">${fc(totSav)}</td><td>${fc(totDep)}</td></tr>`;
  tbl+='</tbody></table></div>';
  document.getElementById('yearlyMonthTable').innerHTML=tbl;
}

// ===== SAVINGS TAB =====
function renderSavings(){
  try{
  ensureDataIntegrity(D);
  renderSavingsKPIs();
  const container=document.getElementById('savingsContent');
  if(!container)return;
  let html='';

  // Zone 1: Emergency Fund
  const ef=D.savings.emergency;
  const avgExp=calcAvgMonthlyExpenses();
  const recMin=avgExp*3,recMax=avgExp*6;
  const efPct=ef.target>0?Math.min(Math.round(ef.current/ef.target*100),100):0;
  const efColor=efPct>=100?'var(--success)':efPct>=50?'var(--warning)':'var(--danger)';
  const efStatus=efPct>=100?'ğŸ† ×™×© ×œ×›× ×§×¨×Ÿ ×—×™×¨×•× ××œ××”!':efPct>=75?'ğŸ’ª ×›××¢×˜ ×©×!':efPct>=50?'ğŸŸ¢ ××ª×§×“××™× ×™×¤×”':efPct>=25?'ğŸŸ¡ ×”×ª×—×œ×” ×˜×•×‘×”':efPct>0?'ğŸ”´ ×™×© ×œ×‘× ×•×ª ×§×¨×Ÿ ×—×™×¨×•×':'âšª ×˜×¨× ×”×•×’×“×¨×”';
  const efMonths=ef.monthlyContribution>0?Math.ceil((ef.target-ef.current)/ef.monthlyContribution):0;

  html+=`<div class="savings-zone">
    <h3>ğŸ†˜ ×§×¨×Ÿ ×—×™×¨×•×</h3>
    ${avgExp>0?`<p style="font-size:.78rem;color:var(--text-secondary)">××•××œ×¥: ${fc(Math.round(recMin))} - ${fc(Math.round(recMax))} (3-6 ×—×•×“×©×™ ×”×•×¦××•×ª)</p>`:''}
    <div class="fund-card">
      ${ef.institution?`<div class="institution-text">ğŸ¦ ${esc(ef.institution)}</div>`:''}
      <div class="fund-amount">${fc(ef.current)} <span style="font-size:.8rem;color:var(--text-secondary)">/ ${fc(ef.target)}</span></div>
      <div class="fund-progress"><div class="fund-progress-bar" style="width:${efPct}%;background:${efColor}"></div></div>
      <div class="fund-status" style="color:${efColor}">${efStatus} (${efPct}%)</div>
      ${efMonths>0?`<div class="fund-meta"><span>×‘×§×¦×‘ ×”× ×•×›×—×™: ×¢×•×“ ${efMonths} ×—×•×“×©×™× ×œ×™×¢×“</span></div>`:''}
      <div class="fund-actions">
        <button class="btn-sm primary" onclick="editEmergencyFund()">âœï¸ ×¢×¨×•×š</button>
        <button class="btn-sm" onclick="quickDeposit('emergency','×§×¨×Ÿ ×—×™×¨×•×')">+â‚ª ×”×¤×§×“</button>
      </div>
    </div>
  </div>`;

  // Zone 2: Short-term Goals
  html+=`<div class="savings-zone">
    <h3>âœˆï¸ ×™×¢×“×™× ×§×¦×¨×™ ×˜×•×•×—</h3>`;
  if(D.savings.goals.length===0){
    html+=`<p style="color:var(--text-secondary);font-size:.85rem;text-align:center;padding:20px">××™×Ÿ ×™×¢×“×™× ×¢×“×™×™×Ÿ</p>`;
  }
  D.savings.goals.forEach((goal,i)=>{
    const pct=goal.target>0?Math.min(Math.round(goal.current/goal.target*100),100):0;
    const remaining=goal.target-goal.current;
    const color=pct>=100?'var(--success)':pct>=50?'var(--primary)':'var(--warning)';
    let monthsLeft=0,onTrack=true;
    if(goal.targetDate){
      const td=new Date(goal.targetDate);
      const now=new Date();
      monthsLeft=Math.max(0,(td.getFullYear()-now.getFullYear())*12+(td.getMonth()-now.getMonth()));
      if(monthsLeft>0&&goal.monthlyContribution>0){
        onTrack=goal.monthlyContribution*monthsLeft>=remaining;
      }
    }
    html+=`<div class="fund-card">
      <div class="fund-header"><span style="font-size:1.3rem">${esc(goal.emoji||'ğŸ¯')}</span><span class="fund-name">${esc(goal.name)}</span>
        <span style="font-size:.7rem;padding:2px 8px;border-radius:10px;background:${goal.priority==='high'?'var(--danger-bg)':goal.priority==='low'?'var(--border-light)':'var(--warning-bg)'};color:${goal.priority==='high'?'var(--danger)':'var(--text-secondary)'}">${goal.priority==='high'?'×’×‘×•×”×”':goal.priority==='low'?'× ××•×›×”':'×‘×™× ×•× ×™×ª'}</span>
      </div>
      ${goal.institution?`<div class="institution-text">ğŸ¦ ${esc(goal.institution)}</div>`:''}
      <div class="fund-amount">${fc(goal.current)} <span style="font-size:.8rem;color:var(--text-secondary)">/ ${fc(goal.target)}</span></div>
      <div class="fund-progress"><div class="fund-progress-bar" style="width:${pct}%;background:${color}"></div></div>
      <div class="fund-meta">
        <span>× ×•×ª×¨×•: ${fc(remaining)}</span>
        ${monthsLeft>0?`<span>×¢×•×“ ${monthsLeft} ×—×•×“×©×™×</span>`:''} 
        ${goal.monthlyContribution>0?`<span>×”×¤×§×“×”: ${fc(goal.monthlyContribution)}/×—×•×“×©</span>`:''}
      </div>
      ${!onTrack&&monthsLeft>0?`<div class="fund-status" style="color:var(--warning)">âš ï¸ ×¦×¨×™×š ${fc(Math.ceil(remaining/monthsLeft))}/×—×•×“×© ×›×“×™ ×œ×”×’×™×¢ ×œ×™×¢×“</div>`:''}
      ${pct>=100?`<div class="fund-status" style="color:var(--success)">âœ… ×”×™×¢×“ ×”×•×©×’!</div>`:''}
      <div class="fund-actions">
        <button class="btn-sm primary" onclick="editGoal(${i})">âœï¸</button>
        <button class="btn-sm" onclick="quickDeposit('goal_${goal.id}',${i})">+â‚ª</button>
        <button class="btn-sm danger" onclick="deleteGoal(${i})">ğŸ—‘ï¸</button>
        ${pct>=100?`<button class="btn-sm" style="color:var(--success)" onclick="completeGoal(${i})">ğŸ‰ ×¡×™×™×</button>`:''}
      </div>
    </div>`;
  });
  html+=`<button class="add-item-btn" onclick="addGoal()">+ ×”×•×¡×£ ×™×¢×“ ×—×“×©</button></div>`;

  // Zone 3: Children Savings
  if(D.config.children.length>0){
    html+=`<div class="savings-zone"><h3>ğŸ“ ×—×™×¡×›×•×Ÿ ×œ×™×œ×“×™×</h3>`;
    D.savings.childrenSavings.forEach((cs,i)=>{
      const child=D.config.children.find(c=>c.id===cs.childId);
      if(!child)return;
      const yearsLeft=Math.max(0,(cs.targetAge||18)-child.age);
      const monthsLeft=yearsLeft*12;
      const pct=cs.target>0?Math.min(Math.round(cs.current/cs.target*100),100):0;
      const remaining=cs.target-cs.current;
      const needed=monthsLeft>0?Math.ceil(remaining/monthsLeft):0;
      html+=`<div class="fund-card">
        <div class="fund-header"><span style="font-size:1.3rem">${esc(child.emoji||'ğŸ‘¶')}</span><span class="fund-name">${esc(child.name)} (×’×™×œ ${child.age})</span></div>
        ${cs.institution?`<div class="institution-text">ğŸ¦ ${esc(cs.institution)}</div>`:''}
        <div class="fund-amount">${fc(cs.current)} <span style="font-size:.8rem;color:var(--text-secondary)">/ ${fc(cs.target)}</span></div>
        <div class="fund-progress"><div class="fund-progress-bar" style="width:${pct}%;background:var(--primary)"></div></div>
        <div class="fund-meta">
          <span>×¢×•×“ ${yearsLeft} ×©× ×™× ×œ×™×¢×“ (×’×™×œ ${cs.targetAge})</span>
          ${needed>0?`<span>× ×“×¨×©: ${fc(needed)}/×—×•×“×©</span>`:''}
        </div>
        <div class="fund-actions">
          <button class="btn-sm primary" onclick="editChildSavings(${i})">âœï¸</button>
          <button class="btn-sm" onclick="quickDepositChild('child_${cs.childId}',${i})">+â‚ª</button>
        </div>
      </div>`;
    });
    html+=`</div>`;
  }

  // Zone 4: Fixed Savings (pension, education fund, etc.)
  const fs=D.savings.fixedSavings||[];
  const fsTotalMonthly=fs.reduce((a,s)=>a+(s.amount||0),0);
  html+=`<div class="savings-zone">
    <h3>ğŸ”’ ×—×¡×›×•× ×•×ª ×§×‘×•×¢×™×</h3>
    <p style="font-size:.78rem;color:var(--text-secondary)">×”×¤×¨×©×•×ª ×—×•×“×©×™×•×ª ×§×‘×•×¢×•×ª â€” ×¤× ×¡×™×”, ×§×¨×Ÿ ×”×©×ª×œ××•×ª, ×‘×™×˜×•×— ×× ×”×œ×™× ×•×›×•×³</p>`;
  if(fs.length===0){
    html+=`<p style="color:var(--text-secondary);font-size:.85rem;text-align:center;padding:20px">××™×Ÿ ×—×¡×›×•× ×•×ª ×§×‘×•×¢×™× ×¢×“×™×™×Ÿ</p>`;
  }
  fs.forEach((saving,i)=>{
    const p1=D.config.partner1||'×©×•×ª×£ 1',p2=D.config.partner2||'×©×•×ª×£ 2';
    const ownerLabel=saving.owner==='partner1'?p1:saving.owner==='partner2'?p2:'××©×•×ª×£';
    html+=`<div class="fund-card">
      <div class="fund-header">
        <span style="font-size:1.3rem">${esc(saving.emoji||'ğŸ¦')}</span>
        <span class="fund-name">${esc(saving.name)}</span>
        <span style="font-size:.7rem;padding:2px 8px;border-radius:10px;background:var(--primary-bg);color:var(--primary)">${esc(ownerLabel)}</span>
      </div>
      ${saving.institution?`<div class="institution-text">ğŸ¦ ${esc(saving.institution)}</div>`:''}
      <div class="fund-amount">${fc(saving.amount)} <span style="font-size:.8rem;color:var(--text-secondary)">/ ×—×•×“×©</span></div>
      <div class="fund-actions">
        <button class="btn-sm primary" onclick="editFixedSaving(${i})">âœï¸</button>
        <button class="btn-sm danger" onclick="deleteFixedSaving(${i})">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  });
  if(fs.length>0){
    html+=`<div style="text-align:center;font-size:.85rem;color:var(--text-secondary);padding:8px 0;border-top:1px solid var(--border-light);margin-top:8px"><strong>×¡×”×´×› ×”×¤×¨×©×” ×—×•×“×©×™×ª: ${fc(fsTotalMonthly)}</strong></div>`;
  }
  html+=`<button class="add-item-btn" onclick="addFixedSaving()">+ ×”×•×¡×£ ×—×™×¡×›×•×Ÿ ×§×‘×•×¢</button></div>`;

  // Savings Calculator
  html+=`<div class="savings-zone">
    <h3>ğŸ”¢ ××—×©×‘×•×Ÿ ×—×™×¡×›×•×Ÿ</h3>
    <div class="savings-calc">
      <h4>×›××” ×¦×¨×™×š ×œ×—×¡×•×š?</h4>
      <div class="calc-row"><label>×¡×›×•× ×™×¢×“:</label><input class="admin-input ltr" type="number" id="calcTarget" min="0" placeholder="50000" style="direction:ltr;text-align:right" oninput="updateCalc()"></div>
      <div class="calc-row"><label>×—×•×“×©×™×:</label><input class="admin-input ltr" type="number" id="calcMonths" min="1" placeholder="12" style="direction:ltr;text-align:right" oninput="updateCalc()"></div>
      <div class="calc-result" id="calcResult">×”×–×™× ×• ×¡×›×•× ×•×ª×§×•×¤×”</div>
    </div>
  </div>`;

  // Completed goals
  if(D.savings.completedGoals&&D.savings.completedGoals.length>0){
    html+=`<div class="savings-zone"><h3>ğŸ† ×™×¢×“×™× ×©×”×•×©×’×•</h3>`;
    D.savings.completedGoals.forEach(g=>{
      html+=`<div class="fund-card" style="opacity:.7"><div class="fund-header"><span>${esc(g.emoji||'ğŸ¯')}</span><span class="fund-name">${esc(g.name)}</span><span style="font-size:.75rem;color:var(--success)">âœ… ${esc(g.completedDate||'')}</span></div>${g.institution?`<div class="institution-text">ğŸ¦ ${esc(g.institution)}</div>`:''}<div class="fund-amount">${fc(g.target)}</div></div>`;
    });
    html+=`</div>`;
  }

  container.innerHTML=html;
  }catch(e){console.error('renderSavings error:',e);const c=document.getElementById('savingsContent');if(c)c.innerHTML=`<div style="padding:20px;text-align:center;color:var(--danger)">×©×’×™××” ×‘×˜×¢×™× ×ª ×—×¡×›×•× ×•×ª: ${e.message}</div>`}
}

function renderSavingsKPIs(){
  const fixedSavingsMonthly=(D.savings.fixedSavings||[]).reduce((a,s)=>a+(s.amount||0),0);
  const totalSavings=(D.savings.emergency.current||0)+D.savings.goals.reduce((a,g)=>a+(g.current||0),0)+D.savings.childrenSavings.reduce((a,c)=>a+(c.current||0),0);
  const totalMonthly=(D.savings.emergency.monthlyContribution||0)+D.savings.goals.reduce((a,g)=>a+(g.monthlyContribution||0),0)+D.savings.childrenSavings.reduce((a,c)=>a+(c.monthlyContribution||0),0)+fixedSavingsMonthly;
  const completed=(D.savings.completedGoals||[]).length;
  const total=D.savings.goals.length+completed;

  document.getElementById('savingsKpis').innerHTML=`
    <div class="kpi-card blue"><div class="kpi-label">×¡×”×´×› ×—×¡×›×•× ×•×ª</div><div class="kpi-value">${fc(totalSavings)}</div></div>
    <div class="kpi-card green" style="cursor:pointer" onclick="showContributionBreakdown()"><div class="kpi-label">×ª×¨×•××” ×—×•×“×©×™×ª â„¹ï¸</div><div class="kpi-value">${fc(totalMonthly)}</div></div>
    <div class="kpi-card amber"><div class="kpi-label">×™×¢×“×™× ×©×”×•×©×’×•</div><div class="kpi-value">${completed} / ${total}</div></div>`;
}

function showContributionBreakdown(){
  const efm=D.savings.emergency.monthlyContribution||0;
  const goalRows=D.savings.goals.filter(g=>g.monthlyContribution>0).map(g=>`<tr><td style="padding:4px 8px">ğŸ¯ ${esc(g.name)}</td><td style="padding:4px 8px;text-align:left">${fc(g.monthlyContribution)}</td></tr>`).join('');
  const childRows=D.savings.childrenSavings.filter(c=>c.monthlyContribution>0).map(c=>`<tr><td style="padding:4px 8px">ğŸ“ ${esc(c.childName)}</td><td style="padding:4px 8px;text-align:left">${fc(c.monthlyContribution)}</td></tr>`).join('');
  const fixedRows=(D.savings.fixedSavings||[]).filter(s=>s.amount>0).map(s=>`<tr><td style="padding:4px 8px">ğŸ”’ ${esc(s.name)}${s.institution?' ('+esc(s.institution)+')':''}</td><td style="padding:4px 8px;text-align:left">${fc(s.amount)}</td></tr>`).join('');
  const totalMonthly=(efm)+D.savings.goals.reduce((a,g)=>a+(g.monthlyContribution||0),0)+D.savings.childrenSavings.reduce((a,c)=>a+(c.monthlyContribution||0),0)+(D.savings.fixedSavings||[]).reduce((a,s)=>a+(s.amount||0),0);
  showModal(`<h3>ğŸ“Š ×¤×™×¨×•×˜ ×ª×¨×•××” ×—×•×“×©×™×ª</h3>
    <p style="font-size:.82rem;color:var(--text-secondary)">×”×¡×›×•××™× ×©××•×¤×¨×©×™× ×›×œ ×—×•×“×© ×œ×—×™×¡×›×•×Ÿ. × ×™×ª×Ÿ ×œ×¢×¨×•×š ×“×¨×š ×›×œ ××—×“ ××”×›×¨×˜×™×¡×™× ×‘×˜××‘ ×—×™×¡×›×•×Ÿ.</p>
    <table style="width:100%;border-collapse:collapse;margin:12px 0;font-size:.88rem">
    ${efm>0?`<tr><td style="padding:4px 8px">ğŸ†˜ ×§×¨×Ÿ ×—×™×¨×•×</td><td style="padding:4px 8px;text-align:left">${fc(efm)}</td></tr>`:''}
    ${goalRows}${childRows}${fixedRows}
    ${totalMonthly===0?'<tr><td colspan="2" style="padding:12px;text-align:center;color:var(--text-secondary)">××™×Ÿ ×”×¤×¨×©×•×ª ×—×•×“×©×™×•×ª ×¢×“×™×™×Ÿ.<br>×”×’×“×™×¨×• ×¡×›×•× ×‘×›×¨×˜×™×¡×™ ×”×—×™×¡×›×•×Ÿ ×œ××˜×”.</td></tr>':''}
    <tr style="border-top:2px solid var(--border);font-weight:700"><td style="padding:8px">×¡×”×´×›</td><td style="padding:8px;text-align:left">${fc(totalMonthly)}</td></tr>
    </table>
    <div class="modal-actions"><button class="modal-btn primary" onclick="closeModal()">×”×‘× ×ª×™</button></div>`);
}

function calcAvgMonthlyExpenses(){
  let sum=0,count=0;
  Object.keys(D.months).forEach(k=>{const t=calcTotals(k);if(t.expenses>0){sum+=t.expenses;count++}});
  return count>0?sum/count:0;
}

function updateCalc(){
  const target=parseInt(document.getElementById('calcTarget').value)||0;
  const months=parseInt(document.getElementById('calcMonths').value)||0;
  const result=document.getElementById('calcResult');
  if(target>0&&months>0){
    result.textContent=`×¦×¨×™×š ×œ×—×¡×•×š ${fc(Math.ceil(target/months))} ×‘×—×•×“×©`;
    result.style.color='var(--primary)';
  }else{result.textContent='×”×–×™× ×• ×¡×›×•× ×•×ª×§×•×¤×”';result.style.color=''}
}

function editEmergencyFund(){
  const ef=D.savings.emergency;
  showModal(`<h3>âœï¸ ×¢×¨×•×š ×§×¨×Ÿ ×—×™×¨×•×</h3>
    <div class="modal-field"><label>×¡×›×•× ×™×¢×“</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="efTarget" value="${ef.target}" min="0"></div></div>
    <div class="modal-field"><label>×™×ª×¨×” × ×•×›×—×™×ª</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="efCurrent" value="${ef.current}" min="0"></div></div>
    <div class="modal-field"><label>×”×¤×§×“×” ×—×•×“×©×™×ª</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="efMonthly" value="${ef.monthlyContribution}" min="0"></div></div>
    <div class="modal-field"><label>××•×¡×“ / ×§×•×¤×”</label><input class="modal-input" type="text" id="efInstitution" value="${esc(ef.institution||'')}" placeholder="×œ×“×•×’××”: ×‘× ×§ ×œ××•××™, ××’×“×œ (×œ× ×—×•×‘×”)"></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveEmergencyFund()">×©××•×¨</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function saveEmergencyFund(){
  D.savings.emergency.target=Math.max(0,parseInt(document.getElementById('efTarget').value)||0);
  D.savings.emergency.current=Math.max(0,parseInt(document.getElementById('efCurrent').value)||0);
  D.savings.emergency.monthlyContribution=Math.max(0,parseInt(document.getElementById('efMonthly').value)||0);
  D.savings.emergency.institution=(document.getElementById('efInstitution').value||'').trim();
  saveData();closeModal();renderSavings();toast('×§×¨×Ÿ ×—×™×¨×•× ×¢×•×“×›× ×”');
}

function addGoal(){
  showModal(`<h3>â• ×™×¢×“ ×—×“×©</h3>
    <div class="modal-field"><label>×©× ×”×™×¢×“</label><input class="modal-input" id="goalName" placeholder="×œ×“×•×’××”: ×—×•×¤×©×”"></div>
    <div class="modal-field"><label>××™××•×’'×™</label><input class="modal-input" id="goalEmoji" value="ğŸ¯" style="width:60px"></div>
    <div class="modal-field"><label>×¡×›×•× ×™×¢×“</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="goalTarget" min="0"></div></div>
    <div class="modal-field"><label>××•×¡×“ / ×§×•×¤×”</label><input class="modal-input" type="text" id="goalInstitution" placeholder="×œ×“×•×’××”: ×‘× ×§ ×”×¤×•×¢×œ×™×, ××’×“×œ (×œ× ×—×•×‘×”)"></div>
    <div class="modal-field"><label>×ª××¨×™×š ×™×¢×“</label><input class="modal-input" type="month" id="goalDate"></div>
    <div class="modal-field"><label>×”×¤×§×“×” ×—×•×“×©×™×ª</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="goalMonthly" min="0"></div></div>
    <div class="modal-field"><label>×¢×“×™×¤×•×ª</label><select id="goalPriority" class="modal-input"><option value="high">×’×‘×•×”×”</option><option value="medium" selected>×‘×™× ×•× ×™×ª</option><option value="low">× ××•×›×”</option></select></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveNewGoal()">×”×•×¡×£</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
  setTimeout(()=>{const i=document.getElementById('goalName');if(i)i.focus()},250);
}

function saveNewGoal(){
  const name=(document.getElementById('goalName').value||'').trim();
  if(!name){document.getElementById('goalName').style.borderColor='var(--danger)';return}
  const institution=(document.getElementById('goalInstitution').value||'').trim();
  const goalObj={id:uid(),name,emoji:document.getElementById('goalEmoji').value||'ğŸ¯',target:Math.max(0,parseInt(document.getElementById('goalTarget').value)||0),current:0,targetDate:document.getElementById('goalDate').value||'',monthlyContribution:Math.max(0,parseInt(document.getElementById('goalMonthly').value)||0),priority:document.getElementById('goalPriority').value,createdDate:new Date().toISOString().slice(0,10)};
  if(institution)goalObj.institution=institution;
  D.savings.goals.push(goalObj);
  saveData();closeModal();renderSavings();toast(`×™×¢×“ "${name}" × ×•×¡×£`);
}

function editGoal(idx){
  const g=D.savings.goals[idx];
  showModal(`<h3>âœï¸ ×¢×¨×•×š ×™×¢×“</h3>
    <div class="modal-field"><label>×©×</label><input class="modal-input" id="eGoalName" value="${esc(g.name)}"></div>
    <div class="modal-field"><label>××™××•×’'×™</label><input class="modal-input" id="eGoalEmoji" value="${esc(g.emoji)}" style="width:60px"></div>
    <div class="modal-field"><label>×¡×›×•× ×™×¢×“</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="eGoalTarget" value="${g.target}" min="0"></div></div>
    <div class="modal-field"><label>×™×ª×¨×” × ×•×›×—×™×ª</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="eGoalCurrent" value="${g.current}" min="0"></div></div>
    <div class="modal-field"><label>××•×¡×“ / ×§×•×¤×”</label><input class="modal-input" type="text" id="eGoalInstitution" value="${esc(g.institution||'')}" placeholder="×œ×“×•×’××”: ×‘× ×§ ×”×¤×•×¢×œ×™×, ××’×“×œ"></div>
    <div class="modal-field"><label>×ª××¨×™×š ×™×¢×“</label><input class="modal-input" type="month" id="eGoalDate" value="${g.targetDate}"></div>
    <div class="modal-field"><label>×”×¤×§×“×” ×—×•×“×©×™×ª</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="eGoalMonthly" value="${g.monthlyContribution}" min="0"></div></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveEditGoal(${idx})">×©××•×¨</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function saveEditGoal(idx){
  const g=D.savings.goals[idx];
  g.name=document.getElementById('eGoalName').value.trim()||g.name;
  g.emoji=document.getElementById('eGoalEmoji').value||g.emoji;
  g.target=Math.max(0,parseInt(document.getElementById('eGoalTarget').value)||0);
  g.current=Math.max(0,parseInt(document.getElementById('eGoalCurrent').value)||0);
  g.institution=(document.getElementById('eGoalInstitution').value||'').trim();
  g.targetDate=document.getElementById('eGoalDate').value;
  g.monthlyContribution=Math.max(0,parseInt(document.getElementById('eGoalMonthly').value)||0);
  saveData();closeModal();renderSavings();toast('×™×¢×“ ×¢×•×“×›×Ÿ');
}

function deleteGoal(idx){showModal(`<h3>âš ï¸ ××—×™×§×ª ×™×¢×“</h3><p>×œ××—×•×§ ××ª "${esc(D.savings.goals[idx].name)}"?</p><div class="modal-actions"><button class="modal-btn danger" onclick="pushUndo();D.savings.goals.splice(${idx},1);saveData();closeModal();renderSavings();toast('×™×¢×“ × ××—×§')">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`)}

function completeGoal(idx){
  const g=D.savings.goals.splice(idx,1)[0];
  g.completedDate=new Date().toISOString().slice(0,10);
  D.savings.completedGoals.push(g);
  saveData();renderSavings();toast('ğŸ‰ ×›×œ ×”×›×‘×•×“! ×”×™×¢×“ ×”×•×©×’!');
}

function editChildSavings(idx){
  const cs=D.savings.childrenSavings[idx];
  showModal(`<h3>âœï¸ ×—×™×¡×›×•×Ÿ ${esc(cs.childName)}</h3>
    <div class="modal-field"><label>×¡×›×•× ×™×¢×“</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="csTarget" value="${cs.target}" min="0"></div></div>
    <div class="modal-field"><label>×™×ª×¨×” × ×•×›×—×™×ª</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="csCurrent" value="${cs.current}" min="0"></div></div>
    <div class="modal-field"><label>××•×¡×“ / ×§×•×¤×”</label><input class="modal-input" type="text" id="csInstitution" value="${esc(cs.institution||'')}" placeholder="×œ×“×•×’××”: ×§×•×¤×ª ×’××œ, ×‘× ×§ ×”×¤×•×¢×œ×™×"></div>
    <div class="modal-field"><label>×’×™×œ ×™×¢×“</label><input class="modal-input ltr" type="number" id="csAge" value="${cs.targetAge}" min="1" max="30" style="direction:ltr;text-align:right"></div>
    <div class="modal-field"><label>×”×¤×§×“×” ×—×•×“×©×™×ª</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="csMonthly" value="${cs.monthlyContribution}" min="0"></div></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveChildSavings(${idx})">×©××•×¨</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function saveChildSavings(idx){
  const cs=D.savings.childrenSavings[idx];
  cs.target=Math.max(0,parseInt(document.getElementById('csTarget').value)||0);
  cs.current=Math.max(0,parseInt(document.getElementById('csCurrent').value)||0);
  cs.institution=(document.getElementById('csInstitution').value||'').trim();
  cs.targetAge=Math.max(1,parseInt(document.getElementById('csAge').value)||18);
  cs.monthlyContribution=Math.max(0,parseInt(document.getElementById('csMonthly').value)||0);
  saveData();closeModal();renderSavings();toast('×—×™×¡×›×•×Ÿ ×¢×•×“×›×Ÿ');
}

// ===== FIXED SAVINGS =====
function addFixedSaving(){
  const p1=D.config.partner1||'×©×•×ª×£ 1',p2=D.config.partner2||'×©×•×ª×£ 2';
  showModal(`<h3>â• ×—×™×¡×›×•×Ÿ ×§×‘×•×¢ ×—×“×©</h3>
    <div class="modal-field"><label>×©×</label><input class="modal-input" id="fsName" placeholder="×œ×“×•×’××”: ×¤× ×¡×™×”, ×§×¨×Ÿ ×”×©×ª×œ××•×ª, ×‘×™×˜×•×— ×× ×”×œ×™×"></div>
    <div class="modal-field"><label>××™××•×’'×™</label><input class="modal-input" id="fsEmoji" value="ğŸ¦" style="width:60px"></div>
    <div class="modal-field"><label>×¡×›×•× ×—×•×“×©×™</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="fsAmount" min="0" placeholder="0"></div></div>
    <div class="modal-field"><label>××•×¡×“ / ×§×•×¤×”</label><input class="modal-input" type="text" id="fsInstitution" placeholder="×œ×“×•×’××”: ××’×“×œ, ×”×¨××œ, ×× ×•×¨×”"></div>
    ${D.config.soloMode?'':`<div class="modal-field"><label>×©×™×™×š ×œ:</label><select id="fsOwner" class="modal-input">${ownerSelectOpts('shared',p1,p2)}</select></div>`}
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveNewFixedSaving()">×”×•×¡×£</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
  setTimeout(()=>{const i=document.getElementById('fsName');if(i)i.focus()},250);
}

function saveNewFixedSaving(){
  const name=(document.getElementById('fsName').value||'').trim();
  if(!name){document.getElementById('fsName').style.borderColor='var(--danger)';return}
  const saving={
    id:uid(),
    name,
    emoji:document.getElementById('fsEmoji').value||'ğŸ¦',
    amount:Math.max(0,parseInt(document.getElementById('fsAmount').value)||0),
    institution:(document.getElementById('fsInstitution').value||'').trim(),
    owner:document.getElementById('fsOwner').value||'shared'
  };
  D.savings.fixedSavings.push(saving);
  saveData();closeModal();renderSavings();toast(`×—×™×¡×›×•×Ÿ ×§×‘×•×¢ "${name}" × ×•×¡×£`);
}

function editFixedSaving(idx){
  const s=D.savings.fixedSavings[idx];
  const p1=D.config.partner1||'×©×•×ª×£ 1',p2=D.config.partner2||'×©×•×ª×£ 2';
  showModal(`<h3>âœï¸ ×¢×¨×•×š ×—×™×¡×›×•×Ÿ ×§×‘×•×¢</h3>
    <div class="modal-field"><label>×©×</label><input class="modal-input" id="efsName" value="${esc(s.name)}"></div>
    <div class="modal-field"><label>××™××•×’'×™</label><input class="modal-input" id="efsEmoji" value="${esc(s.emoji||'ğŸ¦')}" style="width:60px"></div>
    <div class="modal-field"><label>×¡×›×•× ×—×•×“×©×™</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="efsAmount" value="${s.amount}" min="0"></div></div>
    <div class="modal-field"><label>××•×¡×“ / ×§×•×¤×”</label><input class="modal-input" type="text" id="efsInstitution" value="${esc(s.institution||'')}" placeholder="×œ×“×•×’××”: ××’×“×œ, ×”×¨××œ, ×× ×•×¨×”"></div>
    ${D.config.soloMode?'':`<div class="modal-field"><label>×©×™×™×š ×œ:</label><select id="efsOwner" class="modal-input">${ownerSelectOpts(s.owner||'shared',p1,p2)}</select></div>`}
    <div class="modal-actions"><button class="modal-btn primary" onclick="saveEditFixedSaving(${idx})">×©××•×¨</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function saveEditFixedSaving(idx){
  const s=D.savings.fixedSavings[idx];
  s.name=document.getElementById('efsName').value.trim()||s.name;
  s.emoji=document.getElementById('efsEmoji').value||s.emoji;
  s.amount=Math.max(0,parseInt(document.getElementById('efsAmount').value)||0);
  s.institution=(document.getElementById('efsInstitution').value||'').trim();
  s.owner=document.getElementById('efsOwner').value||'shared';
  saveData();closeModal();renderSavings();toast('×—×™×¡×›×•×Ÿ ×§×‘×•×¢ ×¢×•×“×›×Ÿ');
}

function deleteFixedSaving(idx){
  showModal(`<h3>âš ï¸ ××—×™×§×ª ×—×™×¡×›×•×Ÿ ×§×‘×•×¢</h3><p>×œ××—×•×§ ××ª "${esc(D.savings.fixedSavings[idx].name)}"?</p><div class="modal-actions"><button class="modal-btn danger" onclick="pushUndo();D.savings.fixedSavings.splice(${idx},1);saveData();closeModal();renderSavings();toast('×—×™×¡×›×•×Ÿ ×§×‘×•×¢ × ××—×§')">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function quickDeposit(goalKey,idx){
  const g=D.savings.goals[idx];
  const displayName=g?esc(g.name||''):'';
  showModal(`<h3>+â‚ª ×”×¤×§×“×” ×œ${displayName}</h3>
    <div class="modal-field"><label>×¡×›×•× ×œ×”×¤×§×“×”</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="depositAmt" min="0" placeholder="0"></div></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="confirmDeposit('${goalKey}')">×”×¤×§×“</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function quickDepositChild(goalKey,idx){
  const cs=D.savings.childrenSavings[idx];
  const child=cs?D.config.children.find(c=>c.id===cs.childId):null;
  const displayName=child?esc(child.name):'';
  showModal(`<h3>+â‚ª ×”×¤×§×“×” ×œ×—×™×¡×›×•×Ÿ ${displayName}</h3>
    <div class="modal-field"><label>×¡×›×•× ×œ×”×¤×§×“×”</label><div class="modal-currency-wrap"><input class="modal-input ltr" type="number" id="depositAmt" min="0" placeholder="0"></div></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="confirmDeposit('${goalKey}')">×”×¤×§×“</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function confirmDeposit(goalKey){
  const amt=Math.max(0,parseInt(document.getElementById('depositAmt').value)||0);
  if(!amt)return;
  if(goalKey==='emergency'){D.savings.emergency.current+=amt}
  else if(goalKey.startsWith('goal_')){
    const id=goalKey.replace('goal_','');
    const g=D.savings.goals.find(x=>x.id===id);if(g)g.current+=amt;
  }else if(goalKey.startsWith('child_')){
    const cid=goalKey.replace('child_','');
    const cs=D.savings.childrenSavings.find(x=>x.childId===cid);if(cs)cs.current+=amt;
  }
  // Record in monthly contributions
  const key=mk(curMonth,curYear);
  const data=getMonth(key);
  data.savingsContributions[goalKey]=(data.savingsContributions[goalKey]||0)+amt;
  saveData();closeModal();renderSavings();updateSummary();toast(`×”×•×¤×§×“×• ${fc(amt)}`);
}

// ===== ADMIN PANEL =====
function renderAdmin(){
  try{
  ensureDataIntegrity(D);
  const panel=document.getElementById('adminPanel');
  if(!panel)return;
  let html='';

  // Personal Details
  html+=`<div class="admin-section">
    <h3>ğŸ‘« ×¤×¨×˜×™× ××™×©×™×™×</h3>
    <div style="margin-bottom:12px">
      <label style="font-size:.85rem;display:flex;align-items:center;gap:8px;cursor:pointer"><input type="checkbox" ${D.config.soloMode?'':'checked'} onchange="toggleSoloMode(!this.checked)"> ğŸ‘¥ ×ª×§×¦×™×‘ ×¢× ×©×•×ª×£/×”</label>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <div class="wizard-field" style="flex:1;min-width:140px"><label>${D.config.soloMode?'×”×©× ×©×œ×™':'×©× ×¨××©×™'}</label><input class="admin-input" value="${esc(D.config.partner1)}" onchange="updatePartnerName(1,this.value)" style="width:100%"></div>
      ${D.config.soloMode?'':`<div class="wizard-field" style="flex:1;min-width:140px"><label>×©×•×ª×£/×”</label><input class="admin-input" value="${esc(D.config.partner2)}" onchange="updatePartnerName(2,this.value)" style="width:100%"></div>`}
    </div>
    <div class="wizard-field" style="margin-bottom:10px"><label>×›×•×ª×¨×ª ××©× ×” (×¨×™×§ = ××•×˜×•××˜×™)</label><input class="admin-input" value="${esc(D.settings.subtitle||'')}" placeholder="${D.config.soloMode?esc(D.config.partner1)+' â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×':esc(D.config.partner1)+' ×•'+esc(D.config.partner2)+' â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×'}" onchange="D.settings.subtitle=this.value;saveData();initApp()" style="width:100%"></div>
    <div style="display:flex;gap:10px;align-items:center">
      <label style="font-size:.85rem"><input type="checkbox" ${D.config.pet.enabled?'checked':''} onchange="D.config.pet.enabled=this.checked;saveData();renderAdmin()"> ğŸ• ×—×™×™×ª ××—××“</label>
      ${D.config.pet.enabled?`<input class="admin-input" value="${esc(D.config.pet.name)}" placeholder="×©×" onchange="updatePetName(this.value)" style="width:120px">`:''}
    </div>
  </div>`;

  // Children Management
  html+=`<div class="admin-section">
    <h3>ğŸ‘¶ × ×™×”×•×œ ×™×œ×“×™×</h3>
    <ul class="admin-list">
      ${D.config.children.map((child,i)=>`
        <li>
          <span style="font-size:1.2rem">${esc(child.emoji||'ğŸ‘¶')}</span>
          <input class="admin-input" value="${esc(child.name)}" onchange="updateChildName(${i},this.value)" style="flex:1">
          <input class="admin-input ltr" type="number" value="${child.age}" min="0" max="18" onchange="D.config.children[${i}].age=parseInt(this.value)||0;saveData()" style="width:55px;direction:ltr;text-align:center" title="×’×™×œ">
          <button class="btn-sm danger" onclick="removeChild(${i})">âœ•</button>
        </li>
      `).join('')}
    </ul>
    ${D.config.children.length===0?'<p style="color:var(--text-secondary);font-size:.85rem;padding:8px 0">××™×Ÿ ×™×œ×“×™× ×¨×©×•××™×</p>':''}
    <button class="add-item-btn" onclick="addChild()">+ ×”×•×¡×£ ×™×œ×“/×”</button>
  </div>`;

  // Categories Management
  html+=`<div class="admin-section">
    <h3>ğŸ“‚ × ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</h3>
    <ul class="admin-list">
      ${(D.config.categories||[]).filter(cat=>{
        if(cat.isChildrenCategory&&D.config.children.length===0)return false;
        if(cat.id==='pet'&&(!D.config.pet||!D.config.pet.enabled))return false;
        if(cat.id==='events')return false;
        return true;
      }).map((cat,i)=>{const ci=(D.config.categories||[]).indexOf(cat);return`
        <li>
          <input class="admin-input" value="${esc(cat.icon)}" style="width:40px;text-align:center" onchange="D.config.categories[${ci}].icon=this.value;saveData()">
          <input class="admin-input" value="${esc(cat.name)}" style="flex:1" onchange="renameCat(${ci},this.value)">
          <span style="font-size:.72rem;color:var(--text-light)">${(cat.items||[]).length} ×¤×¨×™×˜×™×</span>
          ${!cat.isChildrenCategory?`<button class="btn-sm danger" onclick="removeCat(${ci})">âœ•</button>`:''}
        </li>
      `}).join('')}
    </ul>
    <button class="add-item-btn" onclick="addCategory()">+ ×”×•×¡×£ ×§×˜×’×•×¨×™×”</button>
  </div>`;

  // Income Sources â€” now managed via âš™ï¸ in Budget tab (showIncomeDefaults)

  // Events Management
  html+=`<div class="admin-section">
    <h3>ğŸ“… ××™×¨×•×¢×™× ×•×ª××¨×™×›×™×</h3>
    <p style="font-size:.78rem;color:var(--text-secondary);margin-bottom:10px">××™×¨×•×¢×™× ×©× ×ª×™×™× ×©×™×•×¤×™×¢×• ××•×˜×•××˜×™×ª ×‘×ª×§×¦×™×‘ ×”×—×•×“×©×™</p>
    ${(D.config.events||[]).length>0?`<ul class="admin-list">
      ${(D.config.events||[]).map((evt,i)=>`
        <li style="flex-wrap:wrap;gap:6px">
          <span style="font-size:1.2rem;flex-shrink:0">${esc(evt.emoji||'ğŸ“…')}</span>
          <div style="flex:1;min-width:100px">
            <div style="font-weight:600;font-size:.85rem">${esc(evt.name)}</div>
            <div style="font-size:.72rem;color:var(--text-secondary)">${evt.day?evt.day+' ':''}${HM[evt.month-1]} Â· ${fc(evt.estimatedBudget)}</div>
          </div>
          <label style="font-size:.72rem;display:flex;align-items:center;gap:3px;cursor:pointer;flex-shrink:0">
            <input type="checkbox" ${evt.enabled?'checked':''} onchange="toggleEvent(${i},this.checked)"> ×¤×¢×™×œ
          </label>
          <button class="btn-sm" onclick="editEvent(${i})" style="flex-shrink:0">âœï¸</button>
          <button class="btn-sm danger" onclick="removeEvent(${i})" style="flex-shrink:0">âœ•</button>
        </li>
      `).join('')}
    </ul>`:'<p style="color:var(--text-light);font-size:.82rem;padding:8px 0">××™×Ÿ ××™×¨×•×¢×™×. ×”×•×¡×™×¤×• ×™××™ ×”×•×œ×“×ª, ×—×’×™× ×•××™×¨×•×¢×™× ×©× ×ª×™×™×</p>'}
    <button class="add-item-btn" onclick="addEvent()">+ ×”×•×¡×£ ××™×¨×•×¢</button>
  </div>`;

  // Reset / Wizard
  html+=`<div class="admin-section">
    <h3>ğŸ”„ ××™×¤×•×¡</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn-sm" onclick="D.settings.setupComplete=false;saveData();showWizard()">ğŸ§™ ×”×¤×¢×œ ××©×£ ××—×“×©</button>
      <button class="btn-sm danger" onclick="showFullResetModal()">ğŸ—‘ï¸ ××—×§ ×”×›×œ</button>
    </div>
  </div>`;

  panel.innerHTML=html;
  }catch(e){console.error('renderAdmin error:',e);const p=document.getElementById('adminPanel');if(p)p.innerHTML=`<div style="padding:20px;text-align:center;color:var(--danger)">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×’×“×¨×•×ª: ${esc(e.message)}</div>`}
}

function updatePartnerName(num,newName){
  const oldName=num===1?D.config.partner1:D.config.partner2;
  if(num===1)D.config.partner1=newName;else D.config.partner2=newName;
  // Update all items containing old name
  if(oldName&&newName){
    Object.values(D.months).forEach(m=>{
      Object.values(m.expenses||{}).forEach(cat=>{
        cat.items.forEach(item=>{
          if(item.name.includes(oldName))item.name=item.name.replace(oldName,newName);
        });
      });
      (m.income||[]).forEach(inc=>{
        if(inc.source.includes(oldName))inc.source=inc.source.replace(oldName,newName);
      });
    });
    (D.config.categories||[]).forEach(cat=>{
      (cat.items||[]).forEach(item=>{
        if(item.name.includes(oldName))item.name=item.name.replace(oldName,newName);
      });
    });
    (D.config.incomeSources||[]).forEach(s=>{
      if(s.name.includes(oldName))s.name=s.name.replace(oldName,newName);
    });
  }
  saveData();toast(`×©× ×¢×•×“×›×Ÿ ×œ-${newName}`);
}

function toggleSoloMode(solo){
  D.config.soloMode=solo;
  if(solo){D.config.partner2=''}
  saveData();renderAdmin();initApp();
  toast(solo?'××¦×‘ ××™×©×™ â€” ×ª×§×¦×™×‘ ×œ×™×—×™×“':'××¦×‘ ×©×•×ª×¤×™× â€” ×ª×§×¦×™×‘ ××©×•×ª×£');
}

function updatePetName(newName){
  const oldName=D.config.pet.name;
  D.config.pet.name=newName;
  const petCat=D.config.categories.find(c=>c.id==='pet');
  if(petCat&&newName){
    const oldCatName=petCat.name;
    petCat.name=newName;
    Object.values(D.months).forEach(m=>{
      if(m.expenses[oldCatName]){m.expenses[newName]=m.expenses[oldCatName];delete m.expenses[oldCatName]}
    });
  }
  saveData();renderAdmin();toast('×©× ×¢×•×“×›×Ÿ');
}

function updateChildName(idx,newName){
  const old=D.config.children[idx].name;
  D.config.children[idx].name=newName;
  // Update items
  const childCat=D.config.categories.find(c=>c.isChildrenCategory);
  if(childCat&&old){
    Object.values(D.months).forEach(m=>{
      const cd=m.expenses[childCat.name];if(!cd)return;
      cd.items.forEach(item=>{
        if(item.childId===D.config.children[idx].id&&item.name.includes(old)){
          item.name=item.name.replace(old,newName);
        }
      });
    });
  }
  // Update savings
  const cs=D.savings.childrenSavings.find(s=>s.childId===D.config.children[idx].id);
  if(cs)cs.childName=newName;
  saveData();toast(`×©× ×¢×•×“×›×Ÿ ×œ-${newName}`);
}

function addChild(){
  showModal(`<h3>â• ×”×•×¡×£ ×™×œ×“/×”</h3>
    <div class="modal-field"><label>×©×</label><input class="modal-input" id="newChildName" placeholder="×©× ×”×™×œ×“/×”"></div>
    <div class="modal-field"><label>×’×™×œ</label><input class="modal-input ltr" type="number" id="newChildAge" min="0" max="18" value="5" style="direction:ltr;text-align:right"></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="confirmAddChild()">×”×•×¡×£</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function confirmAddChild(){
  const name=(document.getElementById('newChildName').value||'').trim();
  if(!name){document.getElementById('newChildName').style.borderColor='var(--danger)';return}
  const age=parseInt(document.getElementById('newChildAge').value)||5;
  const child={id:uid(),name,age,emoji:age<=3?'ğŸ‘¶':age<=10?'ğŸ‘§':'ğŸ‘¦'};
  D.config.children.push(child);

  // Ensure children category exists
  let childCat=D.config.categories.find(c=>c.isChildrenCategory);
  if(!childCat){
    childCat={id:'children',name:'×™×œ×“×™×',icon:'ğŸ‘¶',order:D.config.categories.length,isChildrenCategory:true,items:[]};
    D.config.categories.push(childCat);
  }

  // Add items to existing months
  const defs=getChildDefaultItems(age);
  Object.values(D.months).forEach(m=>{
    if(!m.expenses[childCat.name])m.expenses[childCat.name]={items:[]};
    defs.forEach(base=>{
      m.expenses[childCat.name].items.push({name:`${base} ${name}`,amount:0,isDefault:true,childId:child.id});
    });
    // Add shared items if not present
    SHARED_CHILD_ITEMS.forEach(si=>{
      if(!m.expenses[childCat.name].items.find(i=>i.name===si&&i.childId==='shared')){
        m.expenses[childCat.name].items.push({name:si,amount:0,isDefault:true,childId:'shared'});
      }
    });
  });

  // Add child savings
  D.savings.childrenSavings.push({childId:child.id,childName:name,purposes:['education'],target:0,current:0,targetAge:18,monthlyContribution:0});

  saveData();closeModal();renderAdmin();renderBudget();toast(`${name} × ×•×¡×£/×”`);
}

function removeChild(idx){
  const child=D.config.children[idx];
  showModal(`<h3>âš ï¸ ×”×¡×¨×ª ×™×œ×“/×”</h3><p>×œ××—×•×§ ××ª ${child.name}? ×›×œ × ×ª×•× ×™ ×”×”×•×¦××•×ª ×•×”×—×™×¡×›×•×Ÿ ×™××—×§×•.</p>
    <div class="modal-actions"><button class="modal-btn danger" onclick="confirmRemoveChild(${idx})">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function confirmRemoveChild(idx){
  pushUndo();
  const child=D.config.children[idx];
  D.config.children.splice(idx,1);
  // Remove from months
  const childCat=D.config.categories.find(c=>c.isChildrenCategory);
  if(childCat){
    Object.values(D.months).forEach(m=>{
      const cd=m.expenses[childCat.name];if(!cd)return;
      cd.items=cd.items.filter(i=>i.childId!==child.id);
    });
  }
  // Remove savings
  D.savings.childrenSavings=D.savings.childrenSavings.filter(s=>s.childId!==child.id);
  // If no more children, optionally remove category
  if(D.config.children.length===0){
    D.config.categories=D.config.categories.filter(c=>!c.isChildrenCategory);
  }
  saveData();closeModal();renderAdmin();renderBudget();toast(`${child.name} ×”×•×¡×¨/×”`);
}

function addCategory(){
  showModal(`<h3>â• ×§×˜×’×•×¨×™×” ×—×“×©×”</h3>
    <div class="modal-field"><label>×©×</label><input class="modal-input" id="newCatName"></div>
    <div class="modal-field"><label>××™××•×’'×™</label><input class="modal-input" id="newCatIcon" value="ğŸ“" style="width:60px"></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="confirmAddCat()">×”×•×¡×£</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function confirmAddCat(){
  const name=(document.getElementById('newCatName').value||'').trim();
  if(!name)return;
  D.config.categories.push({id:uid(),name,icon:document.getElementById('newCatIcon').value||'ğŸ“',order:D.config.categories.length,items:[]});
  saveData();closeModal();renderAdmin();toast(`×§×˜×’×•×¨×™×” "${name}" × ×•×¡×¤×”`);
}

function renameCat(idx,newName){
  const old=D.config.categories[idx].name;
  D.config.categories[idx].name=newName;
  Object.values(D.months).forEach(m=>{
    if(m.expenses[old]){m.expenses[newName]=m.expenses[old];delete m.expenses[old]}
  });
  saveData();toast('×§×˜×’×•×¨×™×” ×¢×•×“×›× ×”');
}

function removeCat(idx){
  const cat=D.config.categories[idx];
  showModal(`<h3>âš ï¸ ××—×™×§×ª ×§×˜×’×•×¨×™×”</h3><p>×œ××—×•×§ ××ª "${esc(cat.name)}"? × ×ª×•× ×™ ×”×”×•×¦××•×ª ×™××—×§×•.</p>
    <div class="modal-actions"><button class="modal-btn danger" onclick="confirmRemoveCat(${idx})">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function confirmRemoveCat(idx){
  pushUndo();
  const catName=D.config.categories[idx].name;
  D.config.categories.splice(idx,1);
  Object.values(D.months).forEach(m=>{delete m.expenses[catName]});
  saveData();closeModal();renderAdmin();renderBudget();toast('×§×˜×’×•×¨×™×” × ××—×§×”');
}

function showFullResetModal(){
  const hasFb=!!fbRef;
  showModal(`<h3>ğŸ—‘ï¸ ××—×™×§×ª ×›×œ ×”× ×ª×•× ×™×</h3><p>×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×œ×¦××™×ª×•×ª${hasFb?' (×›×•×œ×œ ××”×¢× ×Ÿ)':''}. ×”×§×œ×™×“×• "××—×§ ×”×›×œ" ×œ××™×©×•×¨:</p>
    <div class="modal-field"><input class="modal-input" id="resetConfirm" placeholder='×”×§×œ×™×“×• "××—×§ ×”×›×œ"'></div>
    <div class="modal-actions"><button class="modal-btn danger" onclick="confirmFullReset()">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function confirmFullReset(){
  if(document.getElementById('resetConfirm').value!=='××—×§ ×”×›×œ'){toast('×”×˜×§×¡×˜ ×œ× ×ª×•××');return}
  localStorage.removeItem(SK);
  if(fbRef){fbRef.set(freshData()).then(()=>location.reload()).catch(()=>location.reload())}
  else{location.reload()}
}

// ===== DARK MODE =====
function toggleDarkMode(){
  D.settings.darkMode=!D.settings.darkMode;
  applyDarkMode();saveData();
}

function applyDarkMode(){
  document.documentElement.classList.toggle('dark',D.settings.darkMode);
  document.getElementById('darkToggle').textContent=D.settings.darkMode?'â˜€ï¸':'ğŸŒ™';
}

// ===== DATA MANAGEMENT =====
function exportJSON(){
  const key=mk(curMonth,curYear);const data=D.months[key];
  if(!data){toast('××™×Ÿ × ×ª×•× ×™×');return}
  const blob=new Blob([JSON.stringify({[key]:data},null,2)],{type:'application/json'});
  downloadBlob(blob,`budget_${key}.json`);toast('JSON ×™×•×¦×');
}

function downloadFullBackup(){
  const backup={version:2,exportDate:new Date().toISOString(),data:D};
  const blob=new Blob([JSON.stringify(backup,null,2)],{type:'application/json'});
  const dateStr=new Date().toISOString().split('T')[0];
  downloadBlob(blob,`family_budget_backup_${dateStr}.json`);
  toast('×’×™×‘×•×™ ××œ× ×”×•×¨×“ ×‘×”×¦×œ×—×”');
}

function saveMonthNotes(){
  const key=mk(curMonth,curYear);const data=getMonth(key);
  data.notes=(document.getElementById('monthNotes').value||'');
  const ts=document.getElementById('notesLastSaved');
  if(ts){const now=new Date();ts.textContent='× ×©××¨ '+now.getHours().toString().padStart(2,'0')+':'+now.getMinutes().toString().padStart(2,'0')}
  saveData();
}

function importJSON(event){
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const imported=JSON.parse(e.target.result);
      // Check if it's a full backup
      if(imported.version&&imported.data){
        D=imported.data;ensureDataIntegrity(D);saveData();renderBudget();toast('×’×™×‘×•×™ ×©×•×—×–×¨ ×‘×”×¦×œ×—×”');event.target.value='';return;
      }
      // Check if it's a full app export or just month data
      if(imported.config){
        D=imported;
        if(!D.savings)D.savings={emergency:{target:0,current:0,monthlyContribution:0},goals:[],childrenSavings:[],fixedSavings:[],completedGoals:[]};
        if(!D.settings)D.settings={darkMode:false,setupComplete:true,currency:'â‚ª',dismissedAlerts:[]};
        D.settings.setupComplete=true;
      }else{
        Object.keys(imported).forEach(k=>{D.months[k]=imported[k]});
      }
      saveData();
      if(D.settings.setupComplete){hideWizard();initApp()}
      toast('× ×ª×•× ×™× ×™×•×‘××•');
    }catch(err){toast('×©×’×™××” ×‘×™×™×‘×•×')}
  };
  reader.readAsText(file);event.target.value='';
}

function exportCSV(){
  let csv='\ufeff×—×•×“×©,×§×˜×’×•×¨×™×”,×¤×¨×™×˜,×¡×¤×§,×¡×›×•×\n';
  Object.keys(D.months).sort().forEach(key=>{
    const data=D.months[key];
    const ml=HM[parseInt(key.split('-')[1])-1]+' '+key.split('-')[0];
    Object.entries(data.expenses||{}).forEach(([cn,cd])=>{
      (cd.items||[]).forEach(i=>{csv+=`${ml},${cn},${i.name},${i.provider||''},${i.amount||0}\n`});
    });
    (data.income||[]).forEach(i=>{csv+=`${ml},×”×›× ×¡×•×ª,${i.source},,${i.amount||0}\n`});
  });
  downloadBlob(new Blob([csv],{type:'text/csv;charset=utf-8'}),'budget_all.csv');toast('CSV ×™×•×¦×');
}

function downloadBlob(blob,fn){const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=fn;a.click();URL.revokeObjectURL(a.href)}

function showResetModal(){
  showModal(`<h3>âš ï¸ ××™×¤×•×¡ ×—×•×“×©</h3><p>×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×©×œ <strong>${HM[curMonth]} ${curYear}</strong>?</p>
    <div class="modal-actions"><button class="modal-btn danger" onclick="delete D.months[mk(curMonth,curYear)];saveData();renderBudget();closeModal();toast('×—×•×“×© ××•×¤×¡')">××—×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function showCopyModal(){
  const months=Object.keys(D.months).sort().reverse();
  if(!months.length){toast('××™×Ÿ ×—×•×“×©×™×');return}
  const opts=months.map(k=>{const[y,m]=k.split('-');return`<option value="${k}">${HM[parseInt(m)-1]} ${y}</option>`}).join('');
  showModal(`<h3>ğŸ“‹ ×”×¢×ª×§×ª ×ª×§×¦×™×‘ ××ª×•×›× ×Ÿ</h3><p>×‘×—×¨ ×—×•×“×© ××§×•×¨:</p>
    <select id="copySourceMonth">${opts}</select>
    <div class="modal-actions"><button class="modal-btn primary" onclick="copyBudget()">×”×¢×ª×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}

function copyBudget(){
  const sk=document.getElementById('copySourceMonth').value;
  const src=D.months[sk];if(!src)return;
  const tgt=getMonth(mk(curMonth,curYear));
  Object.entries(src.expenses||{}).forEach(([cn,cd])=>{
    if(tgt.expenses[cn]){
      tgt.expenses[cn].budget=cd.budget||0;
      (cd.items||[]).forEach(si=>{
        const ti=tgt.expenses[cn].items.find(i=>i.name===si.name);
        if(ti){
          ti.amount=si.amount;
          if(si.fixed){ti.fixed=true;ti.owner=si.owner}
        }else{
          const newItem={...si};
          tgt.expenses[cn].items.push(newItem);
        }
      });
    }
  });
  // Copy fixed income
  if(src.income){
    src.income.forEach(si=>{
      if(si.fixed){
        const existing=tgt.income.find(i=>i.source===si.source);
        if(existing){existing.amount=si.amount;existing.fixed=true;existing.owner=si.owner}
        else{tgt.income.push({...si})}
      }
    });
  }
  saveData();renderBudget();closeModal();toast('×ª×§×¦×™×‘ ×”×•×¢×ª×§');
}

// ===== COPY MONTH STRUCTURE (without amounts) =====
function showCopyStructure(){
  const months=Object.keys(D.months).sort().reverse();
  if(!months.length){toast('××™×Ÿ ×—×•×“×©×™× ×§×•×“××™×');return}
  const curKey=mk(curMonth,curYear);
  const opts=months.filter(k=>k!==curKey).map(k=>{const[y,m]=k.split('-');return`<option value="${k}">${HM[parseInt(m)-1]} ${y}</option>`}).join('');
  if(!opts){toast('××™×Ÿ ×—×•×“×©×™× ××—×¨×™×');return}
  showModal(`<h3>ğŸ“‹ ×”×¢×ª×§ ××‘× ×” ×—×•×“×©</h3>
    <p style="font-size:.82rem;color:var(--text-secondary)">××¢×ª×™×§ ××ª ×›×œ ×”×§×˜×’×•×¨×™×•×ª, ×”×¤×¨×™×˜×™× ×•×”×ª×§×¦×™×‘×™× â€” <strong>×‘×œ×™</strong> ×”×¡×›×•××™× ×‘×¤×•×¢×œ</p>
    <div class="modal-field"><label>××—×•×“×©:</label><select class="modal-input" id="copyStructSrc">${opts}</select></div>
    <div class="modal-field"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="copyStructBudgets" checked> ×”×¢×ª×§ ×’× ×ª×§×¦×™×‘×™× ×œ×§×˜×’×•×¨×™×•×ª</label></div>
    <div class="modal-field"><label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="copyStructIncome" checked> ×”×¢×ª×§ ×’× ××§×•×¨×•×ª ×”×›× ×¡×”</label></div>
    <div class="modal-actions"><button class="modal-btn primary" onclick="doCopyStructure()">×”×¢×ª×§</button><button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button></div>`);
}
function doCopyStructure(){
  pushUndo();
  const sk=document.getElementById('copyStructSrc').value;
  const copyBudgets=document.getElementById('copyStructBudgets').checked;
  const copyIncome=document.getElementById('copyStructIncome').checked;
  const src=D.months[sk];if(!src)return;
  const tgt=getMonth(mk(curMonth,curYear));
  Object.entries(src.expenses||{}).forEach(([cn,cd])=>{
    if(!tgt.expenses[cn]){tgt.expenses[cn]={budget:0,items:[]}}
    if(copyBudgets)tgt.expenses[cn].budget=cd.budget||0;
    (cd.items||[]).forEach(si=>{
      const exists=tgt.expenses[cn].items.find(i=>i.name===si.name);
      if(!exists){
        const newItem={name:si.name,amount:0,isDefault:si.isDefault,owner:si.owner||'shared'};
        if(si.fixed){newItem.fixed=true;newItem.amount=si.amount||0}
        if(si.provider)newItem.provider=si.provider;
        if(si.group)newItem.group=si.group;
        tgt.expenses[cn].items.push(newItem);
      }
    });
  });
  if(copyIncome&&src.income){
    src.income.forEach(si=>{
      const exists=tgt.income.find(i=>i.source===si.source);
      if(!exists){
        const newInc={source:si.source,amount:0,owner:si.owner||'shared'};
        if(si.fixed){newInc.fixed=true;newInc.amount=si.amount||0}
        tgt.income.push(newInc);
      }
    });
  }
  saveData();renderBudget();closeModal();
  toast(`××‘× ×” ${sk.split('-').reverse().map((v,i)=>i?HM[parseInt(v)-1]:v).join(' ')} ×”×•×¢×ª×§`);
}

// ===== RECOMMENDED BUDGET =====
function showRecommendedBudget(){
  const allKeys=Object.keys(D.months).sort().reverse();
  const curKey=mk(curMonth,curYear);
  const pastKeys=allKeys.filter(k=>k<curKey).slice(0,6);
  if(pastKeys.length<1){toast('××™×Ÿ ××¡×¤×™×§ ×”×™×¡×˜×•×¨×™×” ×œ×”××œ×¦×•×ª');return}
  const catAvgs={};
  pastKeys.forEach(k=>{
    const m=D.months[k];
    Object.entries(m.expenses||{}).forEach(([cn,cd])=>{
      if(!catAvgs[cn])catAvgs[cn]={totals:[],budgets:[]};
      let spent=0;(cd.items||[]).forEach(i=>spent+=(i.amount||0));
      catAvgs[cn].totals.push(spent);
      catAvgs[cn].budgets.push(cd.budget||0);
    });
  });
  let html='<h3>ğŸ¯ ×ª×§×¦×™×‘ ××•××œ×¥</h3>';
  html+=`<p style="font-size:.82rem;color:var(--text-secondary);margin-bottom:14px">××‘×•×¡×¡ ×¢×œ ×××•×¦×¢ ${pastKeys.length} ×—×•×“×©×™× ××—×¨×•× ×™×</p>`;
  html+='<div style="max-height:400px;overflow-y:auto">';
  html+='<table style="width:100%;border-collapse:collapse;font-size:.85rem"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:right;padding:8px">×§×˜×’×•×¨×™×”</th><th style="text-align:center;padding:8px">×××•×¦×¢ ×”×•×¦××•×ª</th><th style="text-align:center;padding:8px">×ª×§×¦×™×‘ × ×•×›×—×™</th><th style="text-align:center;padding:8px">××•××œ×¥</th><th style="padding:8px"></th></tr></thead><tbody>';
  const tgtKey=mk(curMonth,curYear);const tgt=getMonth(tgtKey);
  Object.entries(catAvgs).forEach(([cn,data])=>{
    const avgSpent=Math.round(data.totals.reduce((a,b)=>a+b,0)/data.totals.length);
    const recommended=Math.round(avgSpent*1.1/100)*100; // +10% buffer, rounded to 100
    const curBudget=tgt.expenses[cn]?.budget||0;
    const diff=recommended-curBudget;
    const diffClass=diff>0?'color:var(--danger)':'color:var(--success)';
    html+=`<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:8px;font-weight:500">${esc(cn)}</td>
      <td style="padding:8px;text-align:center;direction:ltr">${fc(avgSpent)}</td>
      <td style="padding:8px;text-align:center;direction:ltr">${fc(curBudget)}</td>
      <td style="padding:8px;text-align:center;direction:ltr;font-weight:600">${fc(recommended)}</td>
      <td style="padding:8px"><button class="btn-sm" onclick="applyRecommended('${esc(cn)}',${recommended})" style="font-size:.75rem">×”×—×œ</button></td>
    </tr>`;
  });
  html+='</tbody></table></div>';
  html+=`<div class="modal-actions" style="margin-top:14px"><button class="modal-btn primary" onclick="applyAllRecommended()">×”×—×œ ×”×›×œ</button><button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button></div>`;
  window._recommendedBudgets=catAvgs;
  showModal(html);
}
function applyRecommended(catName,amount){
  pushUndo();
  const tgt=getMonth(mk(curMonth,curYear));
  if(tgt.expenses[catName])tgt.expenses[catName].budget=amount;
  saveData();renderBudget();toast(`×ª×§×¦×™×‘ ${catName}: ${fc(amount)}`);
}
function applyAllRecommended(){
  pushUndo();
  const tgt=getMonth(mk(curMonth,curYear));
  Object.entries(window._recommendedBudgets||{}).forEach(([cn,data])=>{
    const avgSpent=Math.round(data.totals.reduce((a,b)=>a+b,0)/data.totals.length);
    const recommended=Math.round(avgSpent*1.1/100)*100;
    if(tgt.expenses[cn])tgt.expenses[cn].budget=recommended;
  });
  saveData();renderBudget();closeModal();toast('×›×œ ×”×ª×§×¦×™×‘×™× ×¢×•×“×›× ×•');
}

// ===== ITEM TREND CHART =====
function showItemTrend(catName,itemName){
  const allKeys=Object.keys(D.months).sort();
  const last12=allKeys.slice(-12);
  const labels=[];const values=[];
  last12.forEach(k=>{
    const[y,m]=k.split('-');
    labels.push(HM[parseInt(m)-1]+' '+y.slice(2));
    const md=D.months[k];
    let total=0;
    if(md.expenses&&md.expenses[catName]){
      (md.expenses[catName].items||[]).forEach(i=>{
        if(i.name===itemName||(i.group&&i.group===itemName))total+=(i.amount||0);
      });
    }
    values.push(total);
  });
  if(values.every(v=>v===0)){toast('××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”');return}
  const avg=Math.round(values.filter(v=>v>0).reduce((a,b)=>a+b,0)/Math.max(values.filter(v=>v>0).length,1));
  const max=Math.max(...values);const min=Math.min(...values.filter(v=>v>0));
  showModal(`<h3>ğŸ“ˆ ××’××•×ª: ${esc(itemName)}</h3>
    <p style="font-size:.78rem;color:var(--text-secondary)">×§×˜×’×•×¨×™×”: ${esc(catName)} Â· ${last12.length} ×—×•×“×©×™× ××—×¨×•× ×™×</p>
    <div style="display:flex;gap:12px;margin:12px 0;font-size:.82rem">
      <span style="background:var(--primary-bg);padding:4px 10px;border-radius:6px">×××•×¦×¢: <strong>${fc(avg)}</strong></span>
      <span style="background:var(--success-bg);padding:4px 10px;border-radius:6px">××™× ×™××•×: <strong>${fc(min)}</strong></span>
      <span style="background:var(--danger-bg);padding:4px 10px;border-radius:6px">××§×¡×™××•×: <strong>${fc(max)}</strong></span>
    </div>
    <canvas id="trendChart" width="500" height="250"></canvas>
    <div class="modal-actions"><button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button></div>`);
  setTimeout(()=>{
    const ctx=document.getElementById('trendChart');
    if(!ctx||typeof Chart==='undefined')return;
    new Chart(ctx,{type:'line',data:{labels,datasets:[{
      label:itemName,data:values,borderColor:'#6366F1',backgroundColor:'rgba(99,102,241,.15)',
      fill:true,tension:.3,pointRadius:4,pointBackgroundColor:'#6366F1'
    },{
      label:'×××•×¦×¢',data:values.map(()=>avg),borderColor:'#F59E0B',borderDash:[6,4],pointRadius:0,borderWidth:2
    }]},options:{responsive:true,plugins:{legend:{display:true,labels:{font:{family:'Heebo'}}},tooltip:{callbacks:{label:c=>fc(c.raw)}}},scales:{y:{beginAtZero:true,ticks:{callback:v=>fc(v)}},x:{ticks:{font:{size:10}}}}}});
  },200);
}

// ===== CROSS-MONTH SEARCH =====
function showCrossSearch(){
  showModal(`<h3>ğŸ” ×—×™×¤×•×© ×—×•×¦×” ×—×•×“×©×™×</h3>
    <div class="modal-field"><input class="modal-input" type="text" id="crossSearchQ" placeholder="×—×¤×© ×”×•×¦××”, ×¡×¤×§, ×§×˜×’×•×¨×™×”..." oninput="doCrossSearch()" onkeyup="if(event.key==='Escape')closeModal()"></div>
    <div id="crossSearchResults" style="max-height:400px;overflow-y:auto;font-size:.85rem"></div>
    <div class="modal-actions"><button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button></div>`);
  setTimeout(()=>{const i=document.getElementById('crossSearchQ');if(i)i.focus()},200);
}
function doCrossSearch(){
  const q=(document.getElementById('crossSearchQ')?.value||'').trim().toLowerCase();
  const el=document.getElementById('crossSearchResults');
  if(!el)return;
  if(q.length<2){el.innerHTML='<p style="color:var(--text-light);text-align:center;padding:16px">×”×§×œ×™×“×• ×œ×¤×—×•×ª 2 ×ª×•×•×™×</p>';return}
  const results=[];
  Object.keys(D.months).sort().reverse().forEach(key=>{
    const[y,m]=key.split('-');const ml=HM[parseInt(m)-1]+' '+y;
    const md=D.months[key];
    Object.entries(md.expenses||{}).forEach(([cn,cd])=>{
      (cd.items||[]).forEach(item=>{
        const match=(item.name||'').toLowerCase().includes(q)||(item.provider||'').toLowerCase().includes(q)||cn.toLowerCase().includes(q);
        if(match&&(item.amount||0)>0){
          results.push({month:ml,key,cat:cn,name:item.name,provider:item.provider,amount:item.amount||0,type:'expense'});
        }
      });
    });
    (md.income||[]).forEach(inc=>{
      if((inc.source||'').toLowerCase().includes(q)&&(inc.amount||0)>0){
        results.push({month:ml,key,cat:'×”×›× ×¡×•×ª',name:inc.source,amount:inc.amount||0,type:'income'});
      }
    });
  });
  if(!results.length){el.innerHTML='<p style="color:var(--text-light);text-align:center;padding:16px">×œ× × ××¦××• ×ª×•×¦××•×ª</p>';return}
  // Group by item name and show summary
  const grouped={};let totalAll=0;
  results.forEach(r=>{
    const gk=r.name;
    if(!grouped[gk])grouped[gk]={total:0,count:0,months:[]};
    grouped[gk].total+=r.amount;grouped[gk].count++;totalAll+=r.amount;
    grouped[gk].months.push(r);
  });
  let html=`<div style="background:var(--primary-bg);padding:8px 12px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between">
    <span><strong>${results.length}</strong> ×ª×•×¦××•×ª</span><span>×¡×”×´×›: <strong>${fc(totalAll)}</strong></span></div>`;
  html+='<table style="width:100%;border-collapse:collapse"><thead><tr style="border-bottom:2px solid var(--border)"><th style="text-align:right;padding:6px">×—×•×“×©</th><th style="text-align:right;padding:6px">×§×˜×’×•×¨×™×”</th><th style="text-align:right;padding:6px">×¤×¨×™×˜</th><th style="text-align:center;padding:6px">×¡×›×•×</th></tr></thead><tbody>';
  results.slice(0,50).forEach(r=>{
    html+=`<tr style="border-bottom:1px solid var(--border)">
      <td style="padding:6px;white-space:nowrap">${esc(r.month)}</td>
      <td style="padding:6px">${esc(r.cat)}</td>
      <td style="padding:6px">${esc(r.name)}${r.provider?` <span style="font-size:.75rem;color:var(--text-light)">(${esc(r.provider)})</span>`:''}</td>
      <td style="padding:6px;text-align:center;direction:ltr;font-weight:500;color:${r.type==='income'?'var(--success)':'var(--text)'}">${fc(r.amount)}</td>
    </tr>`;
  });
  html+='</tbody></table>';
  if(results.length>50)html+=`<p style="text-align:center;color:var(--text-light);padding:8px">××¦×™×’ 50 ××ª×•×š ${results.length}</p>`;
  el.innerHTML=html;
}

// ===== PDF EXPORT =====
function exportPDF(mode){
  const w=window.open('','_blank');
  if(!w){toast('× × ×œ××¤×©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™×');return}
  const p1=D.config.partner1||'',p2=D.config.partner2||'';
  const title=D.config.soloMode?`${p1} â€” ×ª×§×¦×™×‘`:`${p1} ×•${p2} â€” ×ª×§×¦×™×‘ ××©×¤×—×ª×™`;
  let body='';
  if(mode==='month'){
    const key=mk(curMonth,curYear);const data=getMonth(key);
    const monthLabel=HM[curMonth]+' '+curYear;
    body+=`<h2>${monthLabel}</h2>`;
    // Income
    let totalIncome=0;
    body+='<h3>ğŸ’µ ×”×›× ×¡×•×ª</h3><table><thead><tr><th>××§×•×¨</th><th>×¡×›×•×</th></tr></thead><tbody>';
    (data.income||[]).forEach(i=>{totalIncome+=(i.amount||0);body+=`<tr><td>${esc(i.source)}${i.fixed?' ğŸ”’':''}</td><td class="num">${fc(i.amount||0)}</td></tr>`});
    body+=`</tbody><tfoot><tr><td><strong>×¡×”×´×› ×”×›× ×¡×•×ª</strong></td><td class="num"><strong>${fc(totalIncome)}</strong></td></tr></tfoot></table>`;
    // Expenses per category
    let totalExpenses=0;
    body+='<h3>ğŸ’³ ×”×•×¦××•×ª</h3>';
    Object.entries(data.expenses||{}).forEach(([cn,cd])=>{
      let catTotal=0;
      body+=`<h4>${esc(cn)} (×ª×§×¦×™×‘: ${fc(cd.budget||0)})</h4><table><thead><tr><th>×¤×¨×™×˜</th><th>×¡×›×•×</th></tr></thead><tbody>`;
      (cd.items||[]).forEach(i=>{
        catTotal+=(i.amount||0);
        body+=`<tr><td>${esc(i.name)}${i.provider?' â€” '+esc(i.provider):''}${i.fixed?' ğŸ”’':''}</td><td class="num">${fc(i.amount||0)}</td></tr>`;
      });
      totalExpenses+=catTotal;
      const diff=(cd.budget||0)-catTotal;
      body+=`</tbody><tfoot><tr><td><strong>×¡×”×´×› ${esc(cn)}</strong></td><td class="num"><strong>${fc(catTotal)}</strong></td></tr></tfoot></table>`;
    });
    // Misc
    let miscTotal=0;
    const misc=data.misc||{};
    if(Object.keys(misc).length>0){
      body+='<h4>ğŸ“¦ ×”×•×¦××•×ª ××—×¨×•×ª</h4><table><tbody>';
      Object.entries(misc).forEach(([n,v])=>{miscTotal+=(Number(v)||0);body+=`<tr><td>${esc(n)}</td><td class="num">${fc(Number(v)||0)}</td></tr>`});
      body+=`</tbody><tfoot><tr><td><strong>×¡×”×´×› ×©×•× ×•×ª</strong></td><td class="num"><strong>${fc(miscTotal)}</strong></td></tr></tfoot></table>`;
    }
    // Summary
    const balance=totalIncome-totalExpenses-miscTotal;
    body+=`<div class="summary"><h3>×××–×Ÿ ×—×•×“×©×™</h3><p>×”×›× ×¡×•×ª: ${fc(totalIncome)} | ×”×•×¦××•×ª: ${fc(totalExpenses+miscTotal)} | <strong style="color:${balance>=0?'#16A34A':'#EF4444'}">×™×ª×¨×”: ${fc(balance)}</strong></p></div>`;
  }else{
    // Yearly report
    const year=curYear;
    body+=`<h2>×“×•×— ×©× ×ª×™ â€” ${year}</h2>`;
    const monthKeys=[];for(let m=0;m<12;m++){const k=year+'-'+String(m+1).padStart(2,'0');if(D.months[k])monthKeys.push(k)}
    if(!monthKeys.length){body+='<p>××™×Ÿ × ×ª×•× ×™× ×œ×©× ×” ×–×•</p>'}
    else{
      body+='<table><thead><tr><th>×—×•×“×©</th><th>×”×›× ×¡×•×ª</th><th>×”×•×¦××•×ª</th><th>×™×ª×¨×”</th></tr></thead><tbody>';
      let yInc=0,yExp=0;
      monthKeys.forEach(k=>{
        const[y,m]=k.split('-');const md=D.months[k];
        let inc=0,exp=0;
        (md.income||[]).forEach(i=>inc+=(i.amount||0));
        Object.values(md.expenses||{}).forEach(cd=>(cd.items||[]).forEach(i=>exp+=(i.amount||0)));
        Object.values(md.misc||{}).forEach(v=>exp+=(Number(v)||0));
        yInc+=inc;yExp+=exp;
        const bal=inc-exp;
        body+=`<tr><td>${HM[parseInt(m)-1]}</td><td class="num">${fc(inc)}</td><td class="num">${fc(exp)}</td><td class="num" style="color:${bal>=0?'#16A34A':'#EF4444'}">${fc(bal)}</td></tr>`;
      });
      body+=`</tbody><tfoot><tr><td><strong>×¡×”×´×›</strong></td><td class="num"><strong>${fc(yInc)}</strong></td><td class="num"><strong>${fc(yExp)}</strong></td><td class="num"><strong style="color:${yInc-yExp>=0?'#16A34A':'#EF4444'}">${fc(yInc-yExp)}</strong></td></tr></tfoot></table>`;
      // Category breakdown
      body+='<h3>×¤×™×¨×•×˜ ×œ×¤×™ ×§×˜×’×•×¨×™×”</h3><table><thead><tr><th>×§×˜×’×•×¨×™×”</th><th>×¡×”×´×› ×©× ×ª×™</th><th>×××•×¦×¢ ×—×•×“×©×™</th></tr></thead><tbody>';
      const catTotals={};
      monthKeys.forEach(k=>{Object.entries(D.months[k].expenses||{}).forEach(([cn,cd])=>{
        if(!catTotals[cn])catTotals[cn]=0;
        (cd.items||[]).forEach(i=>catTotals[cn]+=(i.amount||0));
      })});
      Object.entries(catTotals).sort((a,b)=>b[1]-a[1]).forEach(([cn,total])=>{
        body+=`<tr><td>${esc(cn)}</td><td class="num">${fc(total)}</td><td class="num">${fc(Math.round(total/monthKeys.length))}</td></tr>`;
      });
      body+='</tbody></table>';
    }
  }
  w.document.write(`<!DOCTYPE html><html lang="he" dir="rtl"><head><meta charset="UTF-8">
    <title>${esc(title)} â€” ${mode==='month'?HM[curMonth]+' '+curYear:curYear}</title>
    <style>
      *{margin:0;padding:0;box-sizing:border-box}body{font-family:'Heebo',Arial,sans-serif;padding:30px 40px;color:#1a1a2e;font-size:14px;direction:rtl}
      h1{font-size:24px;margin-bottom:4px;color:#6366F1}h2{font-size:20px;margin:20px 0 12px;border-bottom:2px solid #6366F1;padding-bottom:6px}
      h3{font-size:16px;margin:18px 0 8px;color:#333}h4{font-size:14px;margin:14px 0 6px;color:#555}
      table{width:100%;border-collapse:collapse;margin-bottom:16px}th,td{padding:6px 10px;border-bottom:1px solid #e5e7eb;text-align:right}
      th{background:#f8f9fa;font-weight:600;font-size:12px;color:#666}.num{text-align:left;direction:ltr;font-variant-numeric:tabular-nums}
      tfoot td{border-top:2px solid #333;font-weight:600}.summary{background:#f0f4ff;padding:16px;border-radius:8px;margin-top:20px}
      .header{text-align:center;margin-bottom:20px;padding-bottom:16px;border-bottom:3px solid #6366F1}
      .footer{margin-top:30px;text-align:center;font-size:11px;color:#999}
      @media print{body{padding:15px}table{page-break-inside:auto}tr{page-break-inside:avoid}}
    </style></head><body>
    <div class="header"><h1>${esc(title)}</h1><p style="color:#666;font-size:13px">×”×•×¤×§: ${new Date().toLocaleDateString('he-IL')}</p></div>
    ${body}
    <div class="footer">×ª×§×¦×™×‘ ××©×¤×—×ª×™ â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×</div>
    <script>setTimeout(()=>window.print(),500)<\/script>
  </body></html>`);
  w.document.close();
  toast('PDF × ×¤×ª×— ×œ×”×“×¤×¡×”');
}

function downloadImportTemplate(){
  if(typeof XLSX==='undefined'){toast('SheetJS ×œ× × ×˜×¢×Ÿ');return}
  const wb=XLSX.utils.book_new();
  const cats=D.config.categories||[];
  const rows=[['×ª×‘× ×™×ª ×™×™×‘×•× â€” ×ª×§×¦×™×‘ ××©×¤×—×ª×™'],[''],['×”×•×¨××•×ª: ××œ××• ×¡×›×•××™× ×‘×¢××•×“×” B ×œ×™×“ ×›×œ ×¤×¨×™×˜. × ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×¤×¨×™×˜×™× ×—×“×©×™×.'],['']];
  cats.forEach(cat=>{
    if(cat.isChildrenCategory&&D.config.children.length===0)return;
    if(cat.id==='pet'&&(!D.config.pet||!D.config.pet.enabled))return;
    if(cat.id==='events')return;
    rows.push([`${cat.icon} ${cat.name}`,'']);
    (cat.items||[]).forEach(item=>{
      const name=typeof item==='string'?item:item.name;
      rows.push([name,0]);
    });
    rows.push(['']);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows);
  ws['!cols']=[{wch:30},{wch:15}];
  XLSX.utils.book_append_sheet(wb,ws,'×ª×‘× ×™×ª');
  XLSX.writeFile(wb,'×ª×‘× ×™×ª_×™×™×‘×•×_×ª×§×¦×™×‘.xlsx');
  toast('×ª×‘× ×™×ª ×”×•×¨×“×” ×‘×”×¦×œ×—×”');
}

// ===== EXCEL EXPORT =====
function exportExcel(mode){
  if(typeof XLSX==='undefined'){toast('SheetJS ×œ× × ×˜×¢×Ÿ');return}
  const wb=XLSX.utils.book_new();

  if(mode==='month'){
    const key=mk(curMonth,curYear);const data=getMonth(key);
    const monthLabel=HM[curMonth]+' '+curYear;

    // Budget sheet
    const rows=[['×ª×§×¦×™×‘ ×—×•×“×©×™ - '+monthLabel],[''],['×§×˜×’×•×¨×™×”','×¤×¨×™×˜','×¡×¤×§','×¡×›×•×','×ª×§×¦×™×‘']];
    (D.config.categories||[]).forEach(cat=>{
      const cd=data.expenses[cat.name];if(!cd)return;
      let catTotal=0;
      const catBdg=cd.budget||0;
      cd.items.forEach(i=>{
        const a=i.amount||0;catTotal+=a;
        rows.push([cat.icon+' '+cat.name,i.name,i.provider||'',a,'']);
      });
      rows.push(['','×¡×”"×› '+cat.name,'',catTotal,catBdg]);
      rows.push(['']);
    });
    // Income
    rows.push([''],['×”×›× ×¡×•×ª']);
    (data.income||[]).forEach(i=>rows.push(['',i.source,'',i.amount||0]));
    const{income,expenses,savings}=calcTotals(key);
    rows.push([''],['×¡×™×›×•×'],['×¡×”"×› ×”×›× ×¡×•×ª','','',income],['×¡×”"×› ×”×•×¦××•×ª','','',expenses],['×—×™×¡×›×•×Ÿ','','',savings]);
    const ws=XLSX.utils.aoa_to_sheet(rows);
    ws['!cols']=[{wch:20},{wch:25},{wch:18},{wch:12},{wch:12}];
    XLSX.utils.book_append_sheet(wb,ws,'×ª×§×¦×™×‘');

    // Savings sheet
    if(D.savings){
      const sRows=[['×—×¡×›×•× ×•×ª'],[''],['×§×•×¤×”','××•×¡×“','×™×¢×“','×™×ª×¨×”','××—×•×–']];
      sRows.push(['×§×¨×Ÿ ×—×™×¨×•×',D.savings.emergency.institution||'',D.savings.emergency.target,D.savings.emergency.current,D.savings.emergency.target>0?Math.round(D.savings.emergency.current/D.savings.emergency.target*100)+'%':'']);
      D.savings.goals.forEach(g=>sRows.push([g.name,g.institution||'',g.target,g.current,g.target>0?Math.round(g.current/g.target*100)+'%':'']));
      D.savings.childrenSavings.forEach(cs=>sRows.push(['×—×™×¡×›×•×Ÿ '+cs.childName,cs.institution||'',cs.target,cs.current,cs.target>0?Math.round(cs.current/cs.target*100)+'%':'']));
      if(D.savings.fixedSavings&&D.savings.fixedSavings.length>0){
        sRows.push([]);sRows.push(['×—×¡×›×•× ×•×ª ×§×‘×•×¢×™×','××•×¡×“','×¡×›×•× ×—×•×“×©×™']);
        D.savings.fixedSavings.forEach(s=>sRows.push([s.name,s.institution||'',s.amount||0]));
      }
      const sws=XLSX.utils.aoa_to_sheet(sRows);
      sws['!cols']=[{wch:20},{wch:18},{wch:12},{wch:12},{wch:10}];
      XLSX.utils.book_append_sheet(wb,sws,'×—×¡×›×•× ×•×ª');
    }

    XLSX.writeFile(wb,`×ª×§×¦×™×‘_${HM[curMonth]}_${curYear}.xlsx`);
  }else{
    // Annual summary sheet
    const summRows=[['×¡×™×›×•× ×©× ×ª×™ - '+curYear],[''],['×—×•×“×©','×”×›× ×¡×•×ª','×”×•×¦××•×ª','×—×™×¡×›×•×Ÿ','×”×¤×§×“×•×ª']];
    let totalInc=0,totalExp=0;
    for(let m=0;m<12;m++){
      const k=mk(m,curYear);
      if(D.months[k]){
        const t=calcTotals(k);
        totalInc+=t.income;totalExp+=t.expenses;
        summRows.push([HM[m],t.income,t.expenses,t.savings,t.deposits]);
      }else{summRows.push([HM[m],0,0,0,0])}
    }
    summRows.push([''],['×¡×”"×›',totalInc,totalExp,totalInc-totalExp]);
    const sws=XLSX.utils.aoa_to_sheet(summRows);
    sws['!cols']=[{wch:12},{wch:12},{wch:12},{wch:12},{wch:12}];
    XLSX.utils.book_append_sheet(wb,sws,'×¡×™×›×•× ×©× ×ª×™');

    // Per-month sheets
    for(let m=0;m<12;m++){
      const k=mk(m,curYear);if(!D.months[k])continue;
      const data=D.months[k];
      const rows=[['×§×˜×’×•×¨×™×”','×¤×¨×™×˜','×¡×¤×§','×¡×›×•×','×ª×§×¦×™×‘']];
      (D.config.categories||[]).forEach(cat=>{
        const cd=data.expenses[cat.name];if(!cd)return;
        cd.items.forEach(i=>{rows.push([cat.name,i.name,i.provider||'',i.amount||0,''])});
        rows.push(['','×¡×”"×› '+cat.name,'','',cd.budget||0]);
      });
      const ws=XLSX.utils.aoa_to_sheet(rows);
      ws['!cols']=[{wch:18},{wch:22},{wch:16},{wch:11},{wch:11}];
      XLSX.utils.book_append_sheet(wb,ws,HM[m]);
    }

    XLSX.writeFile(wb,`×ª×§×¦×™×‘_×©× ×ª×™_${curYear}.xlsx`);
  }
  toast('××§×¡×œ ×™×•×¦× ×‘×”×¦×œ×—×”');
}

// ===== EXCEL IMPORT =====
function importExcel(event){
  if(typeof XLSX==='undefined'){toast('SheetJS ×œ× × ×˜×¢×Ÿ');return}
  const file=event.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      const wb=XLSX.read(e.target.result,{type:'binary'});
      const firstSheet=wb.Sheets[wb.SheetNames[0]];
      const rows=XLSX.utils.sheet_to_json(firstSheet,{header:1});

      // Auto-detect: look for Hebrew keywords
      let categories={};let curCat='';
      rows.forEach(row=>{
        if(!row||row.length===0)return;
        const first=String(row[0]||'').trim();
        // Try to detect category headers
        const knownCats=['×“×™×•×¨','×¨×›×‘','××–×•×Ÿ','×˜×™×¤×•×—','×‘×™×œ×•×™','×—×¨×™×’×•×ª','×™×œ×“×™×'];
        const isCat=knownCats.some(k=>first.includes(k))||(row.length<=2&&first.length>2&&!parseFloat(first));
        if(isCat&&first.length>1&&first.length<30){
          curCat=first;if(!categories[curCat])categories[curCat]={items:[]};
        }else if(curCat){
          const name=first;
          const nums=row.slice(1).map(v=>parseFloat(v)||0).filter(v=>v>0);
          if(name&&name.length>1&&name.length<40){
            categories[curCat].items.push({name,amount:nums[0]||0});
          }
        }
      });

      // Show preview
      const catCount=Object.keys(categories).length;
      const itemCount=Object.values(categories).reduce((a,c)=>a+c.items.length,0);
      if(catCount===0){toast('×œ× ×–×•×”×• ×§×˜×’×•×¨×™×•×ª ×‘××§×¡×œ');return}

      let previewHtml=`<h3>ğŸ“— ×ª×¦×•×’×” ××§×“×™××” ×©×œ ×™×™×‘×•×</h3>
        <p>× ××¦××• ${catCount} ×§×˜×’×•×¨×™×•×ª ×•-${itemCount} ×¤×¨×™×˜×™×</p>
        <div style="max-height:300px;overflow-y:auto;margin-bottom:14px">`;
      Object.entries(categories).forEach(([cn,cd])=>{
        previewHtml+=`<div style="font-weight:600;margin-top:8px">${cn} (${cd.items.length})</div>`;
        cd.items.forEach(i=>{previewHtml+=`<div style="font-size:.82rem;color:var(--text-secondary);padding-right:16px">${i.name}: ${fc(i.amount)}</div>`});
      });
      previewHtml+=`</div>
        <div class="modal-actions">
          <button class="modal-btn primary" onclick="confirmExcelImport(${JSON.stringify(categories).replace(/"/g,'&quot;')})">×™×™×‘×</button>
          <button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
        </div>`;
      showModal(previewHtml);
    }catch(err){console.error(err);toast('×©×’×™××” ×‘×§×¨×™××ª ×”××§×¡×œ')}
  };
  reader.readAsBinaryString(file);event.target.value='';
}

function confirmExcelImport(categories){
  // Parse from the stringified version if needed
  if(typeof categories==='string')categories=JSON.parse(categories);
  const key=mk(curMonth,curYear);
  const data=getMonth(key);

  Object.entries(categories).forEach(([catName,catData])=>{
    // Find matching existing category or create new
    let existingCat=D.config.categories.find(c=>c.name.includes(catName)||catName.includes(c.name));
    if(!existingCat){
      existingCat={id:uid(),name:catName,icon:'ğŸ“',order:D.config.categories.length,items:catData.items.map(i=>({name:i.name,isDefault:true}))};
      D.config.categories.push(existingCat);
    }
    if(!data.expenses[existingCat.name])data.expenses[existingCat.name]={budget:0,items:[]};
    catData.items.forEach(item=>{
      const existing=data.expenses[existingCat.name].items.find(i=>i.name===item.name);
      if(existing){
        existing.amount=item.amount;
      }else{
        data.expenses[existingCat.name].items.push({name:item.name,amount:item.amount,isDefault:false});
      }
    });
  });

  saveData();closeModal();
  if(!D.settings.setupComplete){D.settings.setupComplete=true;saveData();hideWizard();initApp()}
  else renderBudget();
  toast('××§×¡×œ ×™×•×‘× ×‘×”×¦×œ×—×”');
}

// ===== BANK STATEMENT PARSER =====
const BANK_CATEGORY_RULES=[
  // ×“×™×•×¨
  {k:['××¨× ×•× ×”','×¢×™×¨×™×™×ª','×¢×™×¨×™×ª'],cat:'×“×™×•×¨',item:'××¨× ×•× ×”'},
  {k:['×—×©××œ','×—×‘×¨×ª ×—×©××œ','iec','×—×—"×™'],cat:'×“×™×•×¨',item:'×—×©××œ'},
  {k:['××™×','××§×•×¨×•×ª','××™ ','×ª××’×™×“ ××™×'],cat:'×“×™×•×¨',item:'××™×'},
  {k:['×’×–','×¡×•×¤×¨×’×–','×¤×–×’×–','×××™×©×¨××’×–'],cat:'×“×™×•×¨',item:'×’×–'},
  {k:['×•×¢×“ ×‘×™×ª'],cat:'×“×™×•×¨',item:'×•×¢×“ ×‘×™×ª'},
  {k:['×¤×¨×˜× ×¨ ×ª×§×©×•×¨×ª','×¤×¨×˜× ×¨ ','×¡×œ×§×•×','×”×•×˜ ××•×‘×™×™×œ','cellcom','×’×•×œ×Ÿ ×˜×œ×§×•×','012','019','×¤×œ××¤×•×Ÿ'],cat:'×“×™×•×¨',item:'×¡×œ×•×œ×¨'},
  {k:['×‘×–×§','×”×•×˜','yes ','bezeq','internet','××™× ×˜×¨× ×˜','×”×•×˜ × ×˜'],cat:'×“×™×•×¨',item:'××™× ×˜×¨× ×˜'},
  {k:['××©×›× ×ª×','mortgage','××©×›× ×ª×”'],cat:'×“×™×•×¨',item:'××©×›× ×ª×'},
  {k:['×©×›"×“','×©×›×¨ ×“×™×¨×”','×“××™ ×©×›×™×¨×•×ª'],cat:'×“×™×•×¨',item:'×©×›×¨ ×“×™×¨×”'},
  // ×‘×™×˜×•×—×™× â€” specific patterns FIRST to prevent broader matches
  {k:['×‘×™×˜×•×— ×‘×¨×™××•×ª','×”×¨××œ ×‘×¨×™××•×ª','×”×¨××œ-×‘×™×˜×•×— ×‘×¨×™××•×ª'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×— ×‘×¨×™××•×ª'},
  {k:['×©×¨×•×ª×™ ×‘×¨×™××•×ª ×›×œ×œ×™×ª','××›×‘×™','×××•×—×“×ª','×œ××•××™×ª','×©×™×¨×•×ª×™ ×‘×¨×™××•×ª'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×— ×‘×¨×™××•×ª'},
  {k:['×‘×™×˜×•×— ×—×™×™×','×›×œ×œ ×‘×™×˜×•×—'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×— ×—×™×™×'},
  {k:['×”×¤× ×™×§×¡','××’×“×œ ×‘×™×˜×•×—','×× ×•×¨×”','××™×™×œ×•×Ÿ'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×—'},
  {k:['×”×¨××œ-×‘×™×˜×•×—','×”×¨××œ ×‘×™×˜×•×—','×œ×™×‘×¨×” ×¢×¡×§××•×ª ×‘×™×˜×•×—','×œ×™×‘×¨×” ×‘×™×˜×•×—'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×—'},
  {k:['×‘×™×˜×•×— ×“×™×¨×”','×‘×™×˜×•×— ××©×›× ×ª×'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×— ×“×™×¨×”'},
  {k:['×‘×™×˜×•×— ×¨×›×‘','×‘×™×˜×•×— ××§×™×£','×—×•×‘×” ×¨×›×‘'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×— ×¨×›×‘'},
  {k:['×‘×™×˜×•×— ×œ××•××™','×”××•×¡×“ ×œ×‘×™×˜×•×—'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×— ×œ××•××™'},
  {k:['×‘×™×˜×•×— ×©×™× ×™×™×','×‘×™×˜×•×— ××©×œ×™×','×©×‘"×Ÿ'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×— ×¡×™×¢×•×“×™'},
  {k:['×‘×™×˜×•×— × ×¡×™×¢×•×ª','×‘×™×˜×•×— ×œ×—×•"×œ'],cat:'×‘×™×˜×•×—×™×',item:'×‘×™×˜×•×— × ×¡×™×¢×•×ª'},
  // ×¨×›×‘ ×•×ª×—×‘×•×¨×”
  {k:['×“×œ×§','×¤×– ','×¡×•× ×•×œ','×“×•×¨ ××œ×•×Ÿ','ten ','delek','yellow'],cat:'×¨×›×‘ ×•×ª×—×‘×•×¨×”',item:'×“×œ×§'},
  {k:['×¨×‘ ×§×•','×¨×‘-×§×•','××’×“','×“×Ÿ ','××¤×™×§×™×','××˜×¨×•×¤×•×œ×™×Ÿ','×¨×›×‘×ª','kavim','egged','moovit'],cat:'×¨×›×‘ ×•×ª×—×‘×•×¨×”',item:'×ª×—×‘"×¦'},
  {k:['×—× ×™×™×”','×—× ×™×•×Ÿ','parking','××—×•×–×ª ×—×•×£','×¤× ×’×•','cellopark'],cat:'×¨×›×‘ ×•×ª×—×‘×•×¨×”',item:'×—× ×™×”'},
  {k:['××•×¡×š','×˜×¡×˜','test','××•×˜×•','×¨×›×‘','car wash'],cat:'×¨×›×‘ ×•×ª×—×‘×•×¨×”',item:'××•×¡×š ×•×˜×™×¤×•×œ×™×'},
  {k:['gett','bolt','uber','××•× ×™×ª','yango ride','yango taxi'],cat:'×¨×›×‘ ×•×ª×—×‘×•×¨×”',item:'×ª×—×‘"×¦'},
  // ××–×•×Ÿ â€” ×¡×•×¤×¨×™×
  {k:['×©×•×¤×¨×¡×œ','×¨××™ ×œ×•×™','××’×”','×•×™×§×˜×•×¨×™','×™×•×—× × ×•×£','×—×¦×™ ×—×™× ×','osher ad','××•×©×¨ ×¢×“','×™×™× ×•×ª ×‘×™×ª×Ÿ','×˜×™×‘ ×˜×¢×','freshmarket','×¤×¨×© ××¨×§×˜','×§×¨×¤×•×¨','×‘×¨×§×ª','×–×•×œ ×•×‘×’×“×•×œ','××—×¡× ×™ ×”×©×•×§','×©×•×§ ×”×¢×™×¨','×©×™×•×•×§ ×ª×•×¦×¨×ª','×©×™×•×•×§ ×—×§×œ××™','×™×¨×§×•×ª','×¤×™×¨×•×ª','××›×•×œ×ª'],cat:'××–×•×Ÿ ×•×¤××¨××”',item:'×¡×•×¤×¨'},
  // ××–×•×Ÿ â€” ×¤××¨× ×•×“×¨××’×¡×˜×•×¨×¡
  {k:['×¡×•×¤×¨ ×¤××¨×','super-pharm','×‘×™ ×“×¨××’×¡×˜×•×¨×¡','be ×“×¨××’×¡×˜×•×¨×¡','×“×¨××’×¡×˜×•×¨','good pharm','×‘×©××ª','×¤××¨×'],cat:'××–×•×Ÿ ×•×¤××¨××”',item:'×¤××¨×'},
  // ××–×•×Ÿ â€” ××¡×¢×“×•×ª, ×§×¤×”, ××©×œ×•×—×™×
  {k:['wolt','×•×•×œ×˜','×ª×Ÿ ×‘×™×¡','10bis','yango deli','yango del'],cat:'××–×•×Ÿ ×•×¤××¨××”',item:'××©×œ×•×—×™ ××•×›×œ'},
  {k:['japanika','××§×“×•× ×œ×“','mcdonald','×‘×•×¨×’×¨','×¤×™×¦×”','pizza','dominos','×©×•×•××¨××”','×¤×œ××¤×œ'],cat:'××–×•×Ÿ ×•×¤××¨××”',item:'××•×›×œ ×‘×—×•×¥'},
  {k:['×§×¤×”','cafe','starbuck','××¨×•××”','cofix','coffeco','×’×¨×’','landwer','×¨×•×œ×“×™×Ÿ','××•×¦××¨×˜','× ×¡×¤×¨×¡×•','nespresso','×‘×•×¨×§×¡','×××¤×™×ª','×××¤×”','×œ×—×','×‘×™×™×§×¨×™','bakery'],cat:'××–×•×Ÿ ×•×¤××¨××”',item:'××•×›×œ ×‘×—×•×¥'},
  {k:['×¤××¤× ×’×•× ×¡','papa john','××¡×¢×“×”','restaurant','×¡×•×©×™','sushi','×©×£','bbq','×’×¨×™×œ'],cat:'××–×•×Ÿ ×•×¤××¨××”',item:'××•×›×œ ×‘×—×•×¥'},
  // ×˜×™×¤×•×— ×•×›×•×©×¨
  {k:['××¡×¤×¨×”','×ª×¡×¤×•×¨×ª','barber','hair'],cat:'×˜×™×¤×•×— ×•×›×•×©×¨',item:'×ª×¡×¤×•×¨×ª'},
  {k:['×”×•×œ××¡','holmes','gym','×›×•×©×¨','×¡×¤×•×¨×˜','×¤×™×œ××˜×™×¡','×™×•×’×”'],cat:'×˜×™×¤×•×— ×•×›×•×©×¨',item:'×›×•×©×¨'},
  {k:['h&m','zara','castro','fox ','golf ','shein','asos','pull&bear','renuar','×× ×’×•','next','american eagle','terminal x','××•×¤× ×”','×‘×™×’×•×“','×¡×™×¡×˜××¨×–','bershka','stradivarius','forever 21','××¨×©×œ×¡','marshalls'],cat:'×˜×™×¤×•×— ×•×›×•×©×¨',item:'×‘×™×’×•×“'},
  // ×‘×™×œ×•×™×™× ×•×ª×¨×‘×•×ª
  {k:['×¡×™× ××”','cinema','yes planet','×¡×™× ××” ×¡×™×˜×™','×œ×‘','×”×•×˜ ×¡×™× ××”','movie'],cat:'×‘×™×œ×•×™×™×',item:'×‘×™×œ×•×™×™×'},
  {k:['spotify','× ×˜×¤×œ×™×§×¡','netflix','apple tv','disney','hbo','××¤×œ ××™×•×–×™×§','youtube premium','youtubepremium'],cat:'×× ×•×™×™×',item:'×× ×•×™×™× ×“×™×’×™×˜×œ×™×™×'},
  {k:['×”×•×¤×¢×”','eventim','barby','zappa','×”×‘×™××”','×§×××¨×™','×ª×™××˜×¨×•×Ÿ','×—×‘×¨×” ×œ×ª×¨×‘×•×ª','×›×¨×˜×™×¡×™×','×ª×¨×‘×•×ª','××•×–×™××•×Ÿ'],cat:'×‘×™×œ×•×™×™×',item:'×‘×™×œ×•×™×™×'},
  {k:['booking','airbnb','hotels','××œ×•×Ÿ','hotel','isrotel','×“×Ÿ ×”×•×˜×œ×¡','fattal','×¦×™××¨'],cat:'×‘×™×œ×•×™×™×',item:'× ×•×¤×©'},
  {k:['×”×˜×‘×•×ª ×¤×™×¡','××¤×¢×œ ×”×¤×™×¡','×¤×™×¡','×œ×•×˜×•'],cat:'×‘×™×œ×•×™×™×',item:'×”×’×¨×œ×•×ª'},
  // ×—×™×•×ª ××—××“
  {k:['×•×˜×¨×™× ×¨','vet','×—× ×•×ª ×—×™×•×ª','pet','××–×•×Ÿ ×œ×›×œ×‘','××–×•×Ÿ ×œ×—×ª×•×œ'],cat:'×—×™×•×ª ××—××“',item:'×•×˜×¨×™× ×¨ ×•×ª×¨×•×¤×•×ª'},
  // ×™×œ×“×™×
  {k:['×’×Ÿ ','×¦×”×¨×•×Ÿ','××©×¤×—×ª×•×Ÿ','××¢×•×Ÿ'],cat:'×™×œ×“×™×',item:'×’×Ÿ/×¦×”×¨×•×Ÿ'},
  {k:['×—×•×’','×©×™×¢×•×¨ ×¤×¨×˜×™','××•×¨×” ×¤×¨×˜×™'],cat:'×™×œ×“×™×',item:'×—×•×’×™×'},
  // ×—×¡×›×•× ×•×ª
  {k:['×‘×™×˜×•×— ×× ×”×œ×™×'],cat:'×—×¡×›×•× ×•×ª',item:'×‘×™×˜×•×— ×× ×”×œ×™×'},
  {k:['×¤× ×¡×™×”','×§×¨×Ÿ ×¤× ×¡×™×”','××™×˜×‘ ×“×©','××œ×˜×©×•×œ×¨','×”×œ××Ÿ ××œ×“×•×‘×™','×¤×¡×’×•×ª'],cat:'×—×¡×›×•× ×•×ª',item:'×§×¨×Ÿ ×¤× ×¡×™×”'},
  {k:['×§×¨×Ÿ ×”×©×ª×œ××•×ª','×”×©×ª×œ××•×ª'],cat:'×—×¡×›×•× ×•×ª',item:'×§×¨×Ÿ ×”×©×ª×œ××•×ª'},
  {k:['×§×•×¤×ª ×’××œ'],cat:'×—×¡×›×•× ×•×ª',item:'×§×•×¤×ª ×’××œ'},
  {k:['×—×¡×›×•×Ÿ','×ª×›× ×™×ª ×—×™×¡×›×•×Ÿ','×¤×§×“×•×Ÿ','×¤×§"×'],cat:'×—×¡×›×•× ×•×ª',item:'×—×™×¡×›×•×Ÿ ×—×•×“×©×™'},
  {k:['×§×¨×Ÿ × ××× ×•×ª','×ª×¢×•×“×ª ×¡×œ','×× ×™×•×ª','× ×™"×¢','× ×™×™×¨×•×ª ×¢×¨×š','×‘×¨×•×§×¨'],cat:'×—×¡×›×•× ×•×ª',item:'×”×©×§×¢×•×ª'},
  {k:['×§×¨×Ÿ ×œ×™××•×“×™×','×—×¡×›×•×Ÿ ×œ×™×œ×“'],cat:'×—×¡×›×•× ×•×ª',item:'×§×¨×Ÿ ×œ×™××•×“×™× ×œ×™×œ×“×™×'},
  // ×›×œ×œ×™ / ××•× ×œ×™×™×Ÿ
  {k:['amazon','×××–×•×Ÿ','aliexpress','ebay','ikea','××™×§××”'],cat:'×—×¨×™×’×•×ª',item:'×§× ×™×•×ª ××•× ×œ×™×™×Ÿ'},
  {k:['paypal','×¤×™×™×¤×œ'],cat:'×—×¨×™×’×•×ª',item:'PayPal'},
  {k:['apple','××¤×œ','google play'],cat:'×—×¨×™×’×•×ª',item:'×—× ×•×™×•×ª ××¤×œ×™×§×¦×™×•×ª'},
  // ×‘× ×§×™× ×•×¢××œ×•×ª
  {k:['×“××™ ×›×¨×˜×™×¡','×¢××œ×ª ×›×¨×˜×™×¡','×“××™ × ×™×”×•×œ','×¢××œ×”','×¢××œ×•×ª'],cat:'×—×¨×™×’×•×ª',item:'×¢××œ×•×ª ×‘× ×§'},
  {k:['×”×¢×‘×¨×” ×‘ bit','bit ×‘× ×”','×”×¢×‘×¨×ª bit','×”×¢×‘×¨×” ×‘bit'],cat:'×—×¨×™×’×•×ª',item:'×”×¢×‘×¨×•×ª BIT'},
  {k:['×”×™ ×‘×™×–','poalim wonder','wonder','×¤×•×¢×œ×™×'],cat:'×—×¨×™×’×•×ª',item:'×©×™×¨×•×ª×™ ×‘× ×§'},
];

function classifyTransaction(desc){
  const lower=(desc||'').toLowerCase().trim();
  // First: try built-in rules
  for(const rule of BANK_CATEGORY_RULES){
    for(const keyword of rule.k){
      if(lower.includes(keyword.toLowerCase())){
        return {cat:rule.cat,item:rule.item};
      }
    }
  }
  // Second: try matching against existing category item names in user's config
  for(const cat of (D.config.categories||[])){
    for(const item of (cat.items||[])){
      const itemName=(typeof item==='string'?item:item.name||'').toLowerCase();
      if(itemName.length>2&&lower.includes(itemName))return {cat:cat.name,item:typeof item==='string'?item:item.name};
      // Also check if item name appears in description
      if(itemName.length>3){
        const words=itemName.split(/\s+/);
        if(words.length>1&&words.every(w=>w.length>1&&lower.includes(w)))return {cat:cat.name,item:typeof item==='string'?item:item.name};
      }
    }
  }
  // Third: try provider names from existing monthly data
  const curKey=mk(curMonth,curYear);
  const curData=D.months[curKey];
  if(curData){
    for(const[catName,catData] of Object.entries(curData.expenses||{})){
      for(const item of (catData.items||[])){
        if(item.provider&&item.provider.length>2&&lower.includes(item.provider.toLowerCase())){
          return {cat:catName,item:item.name};
        }
      }
    }
  }
  return null; // unclassified
}

function importBankStatement(event){
  const file=event.target.files[0];if(!file)return;
  const isCSV=file.name.toLowerCase().endsWith('.csv');
  const reader=new FileReader();
  reader.onload=function(e){
    try{
      let rows;
      if(isCSV){
        const text=e.target.result;
        rows=text.split('\n').map(line=>{
          const fields=[];let field='';let inQuote=false;
          for(let i=0;i<line.length;i++){
            const c=line[i];
            if(c==='"'){inQuote=!inQuote}
            else if((c===','||c==='\t')&&!inQuote){fields.push(field.trim());field=''}
            else{field+=c}
          }
          fields.push(field.trim());
          return fields;
        });
      }else{
        if(typeof XLSX==='undefined'){toast('×¡×¤×¨×™×™×ª SheetJS ×œ× × ×˜×¢× ×” â€” × ×¡×” ×œ×¨×¢× ×Ÿ ××ª ×”×“×£');return}
        const data=new Uint8Array(e.target.result);
        const wb=XLSX.read(data,{type:'array'});
        const firstSheet=wb.Sheets[wb.SheetNames[0]];
        rows=XLSX.utils.sheet_to_json(firstSheet,{header:1});
      }

      // Filter out empty rows
      rows=rows.filter(r=>r&&r.length>1&&r.some(c=>c!=null&&String(c).trim()!==''));
      if(rows.length<2){toast('×”×§×•×‘×¥ ×¨×™×§ ××• ×œ× ×ª×§×™×Ÿ');return}

      console.log('Bank import: rows='+rows.length+', first=',rows[0]);

      // Smart header detection: scan ALL rows to find the best header
      // Credit card statements often have summary sections before the actual data
      const headerKeywords=['×ª×™××•×¨','×¤×™×¨×•×˜','description','×©× ×‘×™×ª ×¢×¡×§','×©× ×”×¢×¡×§','×¤×¢×•×œ×”','×”×¤×¢×•×œ×”','×ª× ×•×¢×”'];
      const amtKeywords=['×¡×›×•×','×—×™×•×‘','amount','debit','×–×›×•×ª','credit','×¡×”"×›'];
      const dateKeywords=['×ª××¨×™×š','date','×ª.×¢×¨×š'];
      let headerRowIdx=0;
      let bestHeaderScore=0;
      for(let ri=0;ri<Math.min(rows.length,50);ri++){
        const row=rows[ri]||[];
        let score=0;
        const rowText=row.map(c=>(String(c||'')).toLowerCase().trim()).join(' ');
        headerKeywords.forEach(kw=>{if(rowText.includes(kw))score+=3});
        amtKeywords.forEach(kw=>{if(rowText.includes(kw))score+=2});
        dateKeywords.forEach(kw=>{if(rowText.includes(kw))score+=1});
        // Bonus for rows with 3+ non-empty cells (typical header width)
        const nonEmpty=row.filter(c=>c!=null&&String(c).trim()!=='').length;
        if(nonEmpty>=3)score+=1;
        if(score>bestHeaderScore){bestHeaderScore=score;headerRowIdx=ri}
      }

      const header=rows[headerRowIdx]||[];
      console.log('Bank import: detected header at row',headerRowIdx,':', header.slice(0,8));

      // Auto-detect columns from the detected header
      let descCol=-1,amtCol=-1,amtCol2=-1,dateCol=-1;
      header.forEach((h,i)=>{
        const hl=(String(h)||'').toLowerCase().trim();
        if(descCol===-1&&(hl.includes('×ª×™××•×¨')||hl.includes('×¤×™×¨×•×˜')||hl.includes('description')||hl.includes('×©× ×‘×™×ª ×¢×¡×§')||hl.includes('×©× ×”×¢×¡×§')||hl.includes('×¤×¢×•×œ×”')||hl.includes('×”×¤×¢×•×œ×”')||hl.includes('×ª× ×•×¢×”')))descCol=i;
        // "×©×" alone â€” only if it's a short header like "×©×" not "×©× ×›×¨×˜×™×¡"
        if(descCol===-1&&hl==='×©×')descCol=i;
        if(hl.includes('×¡×›×•× ×—×™×•×‘')||hl.includes('×—×™×•×‘ ×‘×©')||hl.includes('debit')){amtCol=i}
        else if(hl.includes('×–×›×•×ª')||hl.includes('credit')){amtCol2=i}
        else if(amtCol===-1&&(hl.includes('×¡×›×•×')||hl.includes('amount')||hl.includes('×—×™×•×‘'))){amtCol=i}
        if(dateCol===-1&&!hl.includes('×—×™×•×‘ ×œ×ª××¨×™×š')&&!hl.includes('×”×¤×§×”')&&(hl==='×ª××¨×™×š'||hl.includes('×ª.×¢×¨×š')||hl.includes('×ª××¨×™×š ×¢×¨×š')||hl==='date'))dateCol=i;
      });
      // Secondary amount column: "×¡×›×•× ×§× ×™×™×”" for credit card statements
      let amtFallbackCol=-1;
      header.forEach((h,i)=>{
        const hl=(String(h)||'').toLowerCase().trim();
        if(hl.includes('×¡×›×•× ×§× ×™×™×”')||hl.includes('×¡×›×•× ×¢×¡×§×”'))amtFallbackCol=i;
      });

      // If no header detected from keywords, try data row heuristics
      if(descCol===-1||amtCol===-1){
        for(let r=headerRowIdx+1;r<Math.min(rows.length,headerRowIdx+5);r++){
          const sampleRow=rows[r]||[];
          sampleRow.forEach((cell,i)=>{
            const s=String(cell||'').trim();
            if(s.length===0)return;
            const num=parseFloat(s.replace(/[,]/g,'').replace(/[^\d.-]/g,''));
            if(!isNaN(num)&&num!==0&&amtCol===-1)amtCol=i;
            else if(s.length>3&&isNaN(parseFloat(s))&&descCol===-1&&/[×-×ªa-z]/i.test(s))descCol=i;
          });
          if(descCol!==-1&&amtCol!==-1)break;
        }
      }
      if(descCol===-1){descCol=header.length>3?3:1}
      if(amtCol===-1){amtCol=amtFallbackCol!==-1?amtFallbackCol:(header.length>4?4:2)}

      console.log('Bank import: descCol='+descCol+', amtCol='+amtCol+', amtCol2='+amtCol2+', amtFallback='+amtFallbackCol+', dateCol='+dateCol);

      // Parse transactions starting AFTER the detected header
      const transactions=[];
      const seenRefs={};// dedup by reference number (credit card discount rows)
      const startRow=headerRowIdx+1;
      for(let i=startRow;i<rows.length;i++){
        const row=rows[i];
        if(!row||row.length<2)continue;
        // Stop at next section header (credit card statements have multiple sections)
        const firstCell=String(row[0]||'').trim();
        if(firstCell.includes('×¤×™×¨×•×˜ ×¢×‘×•×¨')||firstCell.includes('×¨×›×™×©×•×ª ×‘'))continue;
        if(firstCell.includes('××¡×¤×¨ ×—×©×‘×•×Ÿ'))continue;
        if(firstCell===header[0]&&i!==startRow)continue; // duplicate header row (new section)
        const desc=String(row[descCol]||'').trim();
        if(!desc||desc.length<2)continue;
        // Skip rows that look like section headers
        if(desc.includes('×©× ×‘×™×ª ×¢×¡×§')||desc.includes('×©× ×›×¨×˜×™×¡'))continue;

        // Try primary amount column, then fallback (×¡×›×•× ×§× ×™×™×”), then secondary (credit)
        let amtStr=String(row[amtCol]||'').replace(/[,]/g,'');
        let rawAmt=parseFloat(amtStr.replace(/[^\d.-]/g,''))||0;
        let amt=rawAmt;
        // For credit card: if primary amount is 0 or very small, try fallback column
        if(amtFallbackCol!==-1&&amtFallbackCol!==amtCol){
          const fbStr=String(row[amtFallbackCol]||'').replace(/[,]/g,'');
          const fbAmt=parseFloat(fbStr.replace(/[^\d.-]/g,''))||0;
          if(fbAmt>0&&(amt===0||amt<1)){amt=fbAmt}
          // Dedup by reference number (credit card CashBack rows)
          const refCol=header.findIndex((h)=>(String(h||'')).includes('××¡××›×ª×'));
          if(refCol!==-1){
            const ref=String(row[refCol]||'').trim();
            // Only dedup if ref looks like an actual reference number (long digits)
            if(ref&&ref.length>8&&/^\d+$/.test(ref)){
              if(seenRefs[ref]){
                // Keep the row with the larger PRIMARY column amount (actual charge, not CashBack)
                if(rawAmt>seenRefs[ref].rawAmt){
                  const finalAmt=rawAmt>0?rawAmt:fbAmt;
                  transactions[seenRefs[ref].idx].amount=Math.round(finalAmt);
                  seenRefs[ref].rawAmt=rawAmt;
                }
                continue; // skip duplicate row
              }
              seenRefs[ref]={idx:transactions.length,rawAmt:rawAmt};
            }
          }
        }
        if(amt===0&&amtCol2!==-1){
          amtStr=String(row[amtCol2]||'').replace(/[,]/g,'');
          amt=parseFloat(amtStr.replace(/[^\d.-]/g,''))||0;
        }
        if(amt===0)continue;
        if(amt<0)amt=Math.abs(amt);

        const classification=classifyTransaction(desc);
        transactions.push({
          desc,
          amount:Math.round(amt),
          date:row[dateCol]!=null?String(row[dateCol]):'',
          cat:classification?classification.cat:null,
          item:classification?classification.item:null,
          classified:!!classification
        });
      }

      if(transactions.length===0){toast('×œ× × ××¦××• ×¤×¢×•×œ×•×ª ×‘×§×•×‘×¥ â€” ×‘×“×§×™ ×©×”×§×•×‘×¥ ××›×™×œ ×ª×™××•×¨ ×•×¡×›×•×');return}

      console.log('Bank import: found '+transactions.length+' transactions');
      showBankImportPreview(transactions);
    }catch(err){console.error('Bank import error:',err);toast('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥: '+err.message)}
  };
  if(isCSV)reader.readAsText(file,'UTF-8');
  else reader.readAsArrayBuffer(file);
  event.target.value='';
}

function showBankImportPreview(transactions){
  const classified=transactions.filter(t=>t.classified);
  const unclassified=transactions.filter(t=>!t.classified);
  const totalAmt=transactions.reduce((s,t)=>s+t.amount,0);
  const cats=D.config.categories.map(c=>c.name);

  let html=`<h3>ğŸ¦ × ×™×ª×•×— ×“×£ ×—×©×‘×•×Ÿ</h3>
    <p>× ××¦××• <strong>${transactions.length}</strong> ×¤×¢×•×œ×•×ª. ×¡×”"×›: <strong>${fc(totalAmt)}</strong></p>
    <p style="font-size:.82rem;color:var(--text-secondary)">âœ… ${classified.length} ×¡×•×•×’×• ××•×˜×•××˜×™×ª &nbsp; â“ ${unclassified.length} ×œ×¡×™×•×•×’ ×™×“× ×™</p>
    <div style="max-height:400px;overflow-y:auto;margin:12px 0">`;

  // Group by category
  const groups={};
  classified.forEach(t=>{
    if(!groups[t.cat])groups[t.cat]={items:[],total:0};
    groups[t.cat].items.push(t);
    groups[t.cat].total+=t.amount;
  });

  // Show classified groups
  Object.entries(groups).forEach(([catName,group])=>{
    html+=`<div style="background:var(--success-bg);border-radius:var(--radius-sm);padding:10px;margin-bottom:6px">
      <div style="font-weight:600;font-size:.88rem;margin-bottom:4px">âœ… ${catName} (${fc(group.total)})</div>`;
    group.items.forEach(t=>{
      html+=`<div style="display:flex;justify-content:space-between;font-size:.78rem;padding:2px 0;color:var(--text-secondary)">
        <span>${t.desc} â†’ <em>${t.item}</em></span><span>${fc(t.amount)}</span></div>`;
    });
    html+=`</div>`;
  });

  // Show unclassified with dropdown to assign
  if(unclassified.length>0){
    html+=`<div style="background:var(--warning-bg);border-radius:var(--radius-sm);padding:10px;margin-bottom:6px">
      <div style="font-weight:600;font-size:.88rem;margin-bottom:6px">â“ ×œ× ×¡×•×•×’×• (${unclassified.length})</div>`;
    unclassified.forEach((t,i)=>{
      html+=`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:.78rem;flex-wrap:wrap">
        <span style="flex:1;min-width:120px">${t.desc} â€” ${fc(t.amount)}</span>
        <select class="bank-cat-select" data-idx="${i}" style="font-size:.75rem;padding:3px 6px;border:1px solid var(--border);border-radius:4px;background:var(--card);min-width:100px">
          <option value="">×“×œ×’</option>
          ${cats.map(c=>`<option value="${c}">${c}</option>`).join('')}
          <option value="__new__">+ ×§×˜×’×•×¨×™×” ×—×“×©×”</option>
        </select>
      </div>`;
    });
    html+=`</div>`;
  }

  html+=`</div>
    <div class="modal-actions">
      <button class="modal-btn primary" onclick="confirmBankImport()">âœ… ×™×™×‘× ×”×•×¦××•×ª</button>
      <button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`;

  // Store transactions globally for the confirm function
  window._bankTransactions=transactions;
  window._bankUnclassified=unclassified;
  showModal(html);
}

function confirmBankImport(){
  pushUndo();
  const transactions=window._bankTransactions||[];
  const unclassified=window._bankUnclassified||[];
  const key=mk(curMonth,curYear);
  const data=getMonth(key);
  let imported=0;

  // Read manual classifications from dropdowns
  document.querySelectorAll('.bank-cat-select').forEach(sel=>{
    const idx=parseInt(sel.dataset.idx);
    const catName=sel.value;
    if(catName&&catName!=='__new__'&&unclassified[idx]){
      unclassified[idx].cat=catName;
      unclassified[idx].item=unclassified[idx].desc.substring(0,25);
      unclassified[idx].classified=true;
    }
  });

  // Import all classified transactions
  transactions.filter(t=>t.classified).forEach(t=>{
    // Find or create category data
    if(!data.expenses[t.cat]){
      // Check if category exists in config
      if(!D.config.categories.find(c=>c.name===t.cat)){
        D.config.categories.push({id:uid(),name:t.cat,icon:'ğŸ“',order:D.config.categories.length,items:[]});
      }
      data.expenses[t.cat]={budget:0,items:[]};
    }
    // Find existing item or create new
    const items=data.expenses[t.cat].items;
    const existing=items.find(i=>i.name===t.item);
    if(existing){
      existing.amount=(existing.amount||0)+t.amount;
    }else{
      items.push({name:t.item||t.desc.substring(0,25),amount:t.amount,isDefault:false,owner:'shared'});
    }
    imported++;
  });

  saveData();closeModal();renderBudgetKeepOpen();
  toast(`×™×•×‘××• ${imported} ×¤×¢×•×œ×•×ª ××“×£ ×”×—×©×‘×•×Ÿ`);
  delete window._bankTransactions;
  delete window._bankUnclassified;
}

// ===== SHARING =====
function exportTemplate(){
  const template={
    type:'budget_template',
    categories:(D.config.categories||[]).map(c=>({name:c.name,icon:c.icon,isChildrenCategory:c.isChildrenCategory||false,items:(c.items||[]).map(i=>({name:i.name}))})),
    version:1
  };
  const json=JSON.stringify(template);
  const encoded=btoa(unescape(encodeURIComponent(json)));
  const url=window.location.href.split('?')[0]+'?template='+encoded;

  showModal(`<h3>ğŸ”— ×©×™×ª×•×£ ×ª×‘× ×™×ª</h3>
    <p>×©×ª×¤×• ××ª ××‘× ×” ×”×ª×§×¦×™×‘ (×œ×œ× ×¡×›×•××™× ××• ×©××•×ª ××™×©×™×™×)</p>
    <div class="modal-field"><label>×§×™×©×•×¨ ×œ×©×™×ª×•×£</label><textarea class="modal-input" style="height:80px;font-size:.75rem;direction:ltr" readonly onclick="this.select()">${url}</textarea></div>
    <div class="modal-field"><label>QR Code</label><div style="text-align:center"><img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(url)}" alt="QR" style="border-radius:8px;max-width:200px"></div></div>
    <div class="modal-field"><label>××• ×”×•×¨×™×“×• ×›×§×•×‘×¥</label></div>
    <div class="modal-actions">
      <button class="modal-btn primary" onclick="downloadBlob(new Blob([JSON.stringify(${JSON.stringify(template).replace(/"/g,"'")},null,2)],{type:'application/json'}),'budget_template.json');toast('×ª×‘× ×™×ª ×”×•×¨×“×”')">ğŸ“¥ ×”×•×¨×“ JSON</button>
      <button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button>
    </div>`);
}

function checkInviteURL(){
  const params=new URLSearchParams(window.location.search);
  const invite=params.get('invite');
  if(!invite)return false;
  // Clean URL without reloading
  window.history.replaceState({},'',window.location.pathname);
  window._pendingInvite=invite.trim().toUpperCase();
  return true;
}
function handlePendingInvite(){
  if(!window._pendingInvite)return;
  const code=window._pendingInvite;
  delete window._pendingInvite;
  if(fbUser&&fbDb){
    // Already logged in â€” join directly
    showWizardJoinCode();
    setTimeout(()=>{const el=document.getElementById('wizJoinCode');if(el){el.value=code}},300);
  }else{
    // Need to login first â€” show wizard with join code pre-filled
    showWizard();
    setTimeout(()=>{
      showWizardJoinCode();
      setTimeout(()=>{const el=document.getElementById('wizJoinCode');if(el){el.value=code}},200);
    },200);
  }
}

function sanitizeStr(s,maxLen=100){
  if(typeof s!=='string')return '';
  return s.replace(/[<>"'&]/g,'').substring(0,maxLen);
}
function loadTemplateFromURL(){
  const params=new URLSearchParams(window.location.search);
  const tmpl=params.get('template');
  if(!tmpl||tmpl.length>50000)return false;
  try{
    const json=decodeURIComponent(escape(atob(tmpl)));
    const template=JSON.parse(json);
    if(template.type!=='budget_template'||!Array.isArray(template.categories))return false;
    // Sanitize and apply template to wizard
    wizData.categories=template.categories.slice(0,30).map((c,i)=>({
      id:uid(),name:sanitizeStr(c.name,50),icon:sanitizeStr(c.icon,4),enabled:true,order:i,
      items:Array.isArray(c.items)?c.items.slice(0,50).map(it=>typeof it==='string'?sanitizeStr(it,100):{name:sanitizeStr(it.name,100),isDefault:!!it.isDefault}):[]
    }));
    return true;
  }catch(e){return false}
}

// ===== ALL MONTHS TABLE =====
function renderAllMonthsTable(){
  const body=document.getElementById('allMonthsBody');
  const keys=Object.keys(D.months).sort().reverse();
  if(!keys.length){body.innerHTML='<tr><td colspan="5" class="text-center" style="padding:20px;color:var(--text-secondary)">××™×Ÿ × ×ª×•× ×™×</td></tr>';return}
  body.innerHTML=keys.map(k=>{
    const[y,m]=k.split('-');
    const t=calcTotals(k);
    return`<tr><td>${HM[parseInt(m)-1]} ${y}</td><td>${fc(t.income)}</td><td>${fc(t.expenses)}</td><td style="color:${t.savings>=0?'var(--success)':'var(--danger)'};font-weight:600">${fc(t.savings)}</td><td>${fc(t.deposits)}</td></tr>`;
  }).join('');
}

// ===== FIREBASE STATE =====
let fbConfig=null;
let fbApp=null;
let fbAuth=null;
let fbDb=null;
let fbUser=null;
let fbFamilyId=null;
let fbRef=null;
let isOnline=true;
let skipFirebaseSync=false; // prevent re-render loops
let userFamilies=[]; // [{familyId, name, role:'admin'|'member', createdAt}]

// ===== FIREBASE CONFIG =====
const FB_CONFIG={
  apiKey:"AIzaSyBHc93GqulX-akadMy21WxkvxWyHMD6k_I",
  authDomain:"budgettoolauth.firebaseapp.com",
  databaseURL:"https://budgettoolauth-default-rtdb.firebaseio.com",
  projectId:"budgettoolauth",
  storageBucket:"budgettoolauth.firebasestorage.app",
  messagingSenderId:"84493564363",
  appId:"1:84493564363:web:5589784749c651faae9e4e"
};
function loadFirebaseConfig(){
  return FB_CONFIG;
}
function saveFirebaseConfig(cfg){
  localStorage.setItem('familyBudget_firebaseConfig',JSON.stringify(cfg));
}

function showFirebaseSetupGuide(){
  const existing=loadFirebaseConfig();
  const content=document.getElementById('fbConfigContent');
  content.innerHTML=`
    <h2 style="margin-bottom:6px">â˜ï¸ ×”×’×“×¨×ª Firebase</h2>
    <p style="color:var(--text-secondary);margin-bottom:16px;font-size:.88rem">Firebase ×××¤×©×¨ ×¡× ×›×¨×•×Ÿ × ×ª×•× ×™× ×‘×–××Ÿ ×××ª ×‘×™×Ÿ ×›×œ ×”××©×ª××©×™×</p>
    <div style="background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:14px;box-shadow:var(--card-shadow)">
      <h4 style="margin-bottom:10px;font-size:.9rem">ğŸ“‹ ×”×•×¨××•×ª ×”×’×“×¨×”</h4>
      <div class="fb-setup-step"><span class="step-num">1</span><span class="step-text">×”×™×›× ×¡×• ×œ-<a href="https://console.firebase.google.com" target="_blank" style="color:var(--primary)">console.firebase.google.com</a></span></div>
      <div class="fb-setup-step"><span class="step-num">2</span><span class="step-text">×¦×¨×• ×¤×¨×•×™×§×˜ ×—×“×© (Add project) â†’ ×ª× ×• ×©× â†’ ×”×©×‘×™×ª×• Analytics â†’ Create</span></div>
      <div class="fb-setup-step"><span class="step-num">3</span><span class="step-text">Authentication â†’ Sign-in method â†’ ×”×¤×¢×™×œ×• Google â†’ Save</span></div>
      <div class="fb-setup-step"><span class="step-num">4</span><span class="step-text">Realtime Database â†’ Create Database â†’ ×‘×—×¨×• region â†’ Start in test mode</span></div>
      <div class="fb-setup-step"><span class="step-num">5</span><span class="step-text">Project Settings (×’×œ×’×œ ×©×™× ×™×™×) â†’ General â†’ Your apps â†’ ×œ×—×¦×• Web (&lt;/&gt;) â†’ Register app</span></div>
      <div class="fb-setup-step"><span class="step-num">6</span><span class="step-text">×”×¢×ª×™×§×• ××ª ×¢×¨×›×™ ×”-firebaseConfig ×•×”×“×‘×™×§×• ×œ××˜×”</span></div>
    </div>
    <div style="background:var(--card);border-radius:var(--radius);padding:14px;box-shadow:var(--card-shadow)">
      <h4 style="margin-bottom:10px;font-size:.9rem">ğŸ”‘ ×¤×¨×˜×™ Firebase Config</h4>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:0 16px">
      <div class="modal-field"><label>API Key</label><input class="modal-input ltr" id="fbApiKey" value="${esc(existing?.apiKey||'')}" placeholder="AIzaSy..."></div>
      <div class="modal-field"><label>Auth Domain</label><input class="modal-input ltr" id="fbAuthDomain" value="${esc(existing?.authDomain||'')}" placeholder="your-project.firebaseapp.com"></div>
      <div class="modal-field"><label>Database URL</label><input class="modal-input ltr" id="fbDatabaseURL" value="${esc(existing?.databaseURL||'')}" placeholder="https://your-project-default-rtdb.firebaseio.com"></div>
      <div class="modal-field"><label>Project ID</label><input class="modal-input ltr" id="fbProjectId" value="${esc(existing?.projectId||'')}" placeholder="your-project-id"></div>
      <div class="modal-field"><label>Storage Bucket</label><input class="modal-input ltr" id="fbStorageBucket" value="${esc(existing?.storageBucket||'')}" placeholder="your-project.appspot.com"></div>
      <div class="modal-field"><label>Messaging Sender ID</label><input class="modal-input ltr" id="fbSenderId" value="${esc(existing?.messagingSenderId||'')}" placeholder="123456789"></div>
      <div class="modal-field"><label>App ID</label><input class="modal-input ltr" id="fbAppId" value="${esc(existing?.appId||'')}" placeholder="1:123:web:abc"></div>
      </div>
      <div class="modal-actions" style="margin-top:16px">
        <button class="modal-btn primary" onclick="saveFirebaseConfigFromForm()">ğŸ’¾ ×©××•×¨ ×•×”×ª×—×‘×¨</button>
        ${existing?'<button class="modal-btn danger" onclick="removeFirebaseConfig()">ğŸ—‘ï¸ ×”×¡×¨ Firebase</button>':''}
        <button class="modal-btn cancel" onclick="closeFbConfig()">×‘×™×˜×•×œ</button>
      </div>
    </div>`;
  document.getElementById('fbConfigOverlay').classList.remove('hidden');
}

function saveFirebaseConfigFromForm(){
  const cfg={
    apiKey:document.getElementById('fbApiKey').value.trim(),
    authDomain:document.getElementById('fbAuthDomain').value.trim(),
    databaseURL:document.getElementById('fbDatabaseURL').value.trim(),
    projectId:document.getElementById('fbProjectId').value.trim(),
    storageBucket:document.getElementById('fbStorageBucket').value.trim(),
    messagingSenderId:document.getElementById('fbSenderId').value.trim(),
    appId:document.getElementById('fbAppId').value.trim()
  };
  if(!cfg.apiKey||!cfg.databaseURL||!cfg.projectId){toast('×—×¡×¨×™× ×©×“×•×ª ×—×•×‘×” (API Key, Database URL, Project ID)');return}
  saveFirebaseConfig(cfg);
  toast('Firebase config × ×©××¨! ×˜×•×¢×Ÿ ××—×“×©...');
  setTimeout(()=>location.reload(),1000);
}

function closeFbConfig(){document.getElementById('fbConfigOverlay').classList.add('hidden')}

function removeFirebaseConfig(){
  localStorage.removeItem('familyBudget_firebaseConfig');
  toast('Firebase ×”×•×¡×¨. ×˜×•×¢×Ÿ ××—×“×©...');
  setTimeout(()=>location.reload(),1000);
}

// ===== FIREBASE AUTH =====
function signInWithGoogle(){
  if(!fbAuth){toast('Firebase ×œ× ××•×’×“×¨');return}
  document.getElementById('loginStatus').textContent='××ª×—×‘×¨...';
  const provider=new firebase.auth.GoogleAuthProvider();
  provider.setCustomParameters({prompt:'select_account'});
  fbAuth.signInWithPopup(provider).catch(err=>{
    if(err.code==='auth/popup-blocked'){
      fbAuth.signInWithRedirect(provider);
    }else{
      document.getElementById('loginStatus').textContent='×©×’×™××”: '+err.message;
    }
  });
}

function skipLogin(){
  document.getElementById('loginOverlay').classList.add('hidden');
  loadDataLocal();
  if(!D.settings.setupComplete){showWizard()}else{initApp()}
}

function showLoginScreen(){
  document.getElementById('loginOverlay').classList.remove('hidden');
  hideLoadingScreen();
}

function hideLoginScreen(){
  document.getElementById('loginOverlay').classList.add('hidden');
}

// ===== FIREBASE FAMILY =====
const INVITE_EXPIRY_MS=72*60*60*1000; // 72 hours
function generateInviteCode(){
  const chars='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  const arr=new Uint8Array(8);crypto.getRandomValues(arr);
  let code='';for(let i=0;i<8;i++)code+=chars[arr[i]%chars.length];
  return code;
}
function resolveInvite(val){
  // Backward compat: old format stored plain familyId string
  if(typeof val==='string')return{familyId:val,expired:false};
  if(val&&val.familyId){
    const age=Date.now()-(val.createdAt||0);
    return{familyId:val.familyId,expired:age>INVITE_EXPIRY_MS};
  }
  return{familyId:null,expired:true};
}

async function resolveFamily(user,retries=0){
  try{
    // Ensure auth token is fresh before DB read
    await user.getIdToken(true);
    const snap=await fbDb.ref('userFamilies/'+user.uid).once('value');
    if(snap.exists()){
      const val=snap.val();
      // Migrate old single-family format: {familyId:'xxx'} â†’ new format
      if(val.familyId&&!val.families){
        const oldFamilyId=val.familyId;
        // Read family meta to get a name
        let familyName='×”××©×¤×—×” ×©×œ×™';
        try{
          const metaSnap=await fbDb.ref('families/'+oldFamilyId+'/meta').once('value');
          if(metaSnap.exists()&&metaSnap.val().name)familyName=metaSnap.val().name;
        }catch(e){}
        const newData={
          families:{[oldFamilyId]:{name:familyName,role:'admin',joinedAt:Date.now()}},
          activeFamily:oldFamilyId
        };
        await fbDb.ref('userFamilies/'+user.uid).set(newData);
        userFamilies=[{familyId:oldFamilyId,name:familyName,role:'admin'}];
        fbFamilyId=oldFamilyId;
        await connectToFamily(fbFamilyId,user);
        return;
      }
      // New multi-family format
      if(val.families){
        userFamilies=Object.entries(val.families).map(([fid,f])=>({familyId:fid,name:f.name||'×ª×§×¦×™×‘',role:f.role||'member',joinedAt:f.joinedAt}));
        fbFamilyId=val.activeFamily||userFamilies[0]?.familyId;
        if(fbFamilyId){
          await connectToFamily(fbFamilyId,user);
          return;
        }
      }
    }
    showFamilyChoice(user);
  }catch(e){
    console.error('resolveFamily error:',e);
    if(retries<2){
      console.log('Retrying resolveFamily... attempt '+(retries+2));
      await new Promise(r=>setTimeout(r,1000));
      return resolveFamily(user,retries+1);
    }
    if(e.code==='PERMISSION_DENIED'||e.message?.includes('permission')||e.message?.includes('Permission')){
      toast('××™×Ÿ ×”×¨×©××•×ª ×œ×§×¨×™××ª × ×ª×•× ×™×. ×‘×“×§×• ××ª ×—×•×§×™ ×”××‘×˜×—×” ×‘-Firebase');
    }else{
      toast('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ××©×¤×—×”: '+e.message);
    }
    skipLogin();
  }
}

function showFamilyChoice(user){
  const hasLocal=!!localStorage.getItem(SK);
  const el=document.getElementById('familyContent');
  let html=`<div style="font-size:3rem;margin-bottom:12px">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
    <div class="login-title">×©×œ×•× ${user.displayName||''}</div>
    <div class="login-subtitle">×‘×—×¨×• ×›×™×¦×“ ×œ×”××©×™×š</div>`;
  if(hasLocal){
    html+=`<div class="wizard-card" onclick="migrateLocalToFirebase()">
      <div class="wc-icon">ğŸ“¤</div><div><div class="wc-title">×”×¢×œ×” × ×ª×•× ×™× ×§×™×™××™×</div><div class="wc-desc">×™×© ×œ×š × ×ª×•× ×™× ××§×•××™×™× â€” ×”×¢×œ×” ××•×ª× ×œ×¢× ×Ÿ ×•×©×ª×£</div></div></div>`;
  }
  html+=`<div class="wizard-card" onclick="createNewFamily()">
    <div class="wc-icon">ğŸ†•</div><div><div class="wc-title">×¦×•×¨ ××©×¤×—×” ×—×“×©×”</div><div class="wc-desc">×”×ª×—×™×œ×• ×××¤×¡ ×•×©×ª×¤×• ×§×•×“ ×”×–×× ×”</div></div></div>
    <div class="wizard-card" onclick="showJoinFamily()">
    <div class="wc-icon">ğŸ”—</div><div><div class="wc-title">×”×¦×˜×¨×£ ×œ××©×¤×—×”</div><div class="wc-desc">××™×©×”×• ×©×™×ª×£ ××ª×›× ×§×•×“? ×”×¦×˜×¨×¤×• ×œ×ª×§×¦×™×‘</div></div></div>`;
  el.innerHTML=html;
  document.getElementById('familyOverlay').classList.remove('hidden');
  hideLoginScreen();
}

async function createNewFamily(familyName,useLocalData){
  try{
    if(useLocalData!==false)loadDataLocal();
    else D=freshData();
    const familyRef=fbDb.ref('families').push();
    fbFamilyId=familyRef.key;
    const inviteCode=generateInviteCode();
    const fName=familyName||(D.config?.soloMode?`×”×ª×§×¦×™×‘ ×©×œ ${D.config.partner1||'×× ×™'}`:(D.config?.partner1&&D.config?.partner2?`${D.config.partner1} ×•${D.config.partner2}`:'×”×ª×§×¦×™×‘ ×©×œ×™'));
    await familyRef.set({
      data:D,
      meta:{createdAt:firebase.database.ServerValue.TIMESTAMP,createdBy:fbUser.uid,name:fName},
      members:{
        [fbUser.uid]:{email:fbUser.email,displayName:fbUser.displayName||'',photoURL:fbUser.photoURL||'',partnerSlot:1,online:true,lastSeen:firebase.database.ServerValue.TIMESTAMP}
      }
    });
    // Add to user's families list
    const familyEntry={name:fName,role:'admin',joinedAt:Date.now()};
    await fbDb.ref('userFamilies/'+fbUser.uid+'/families/'+fbFamilyId).set(familyEntry);
    await fbDb.ref('userFamilies/'+fbUser.uid+'/activeFamily').set(fbFamilyId);
    await fbDb.ref('invites/'+inviteCode).set({familyId:fbFamilyId,createdAt:Date.now()});
    userFamilies.push({familyId:fbFamilyId,name:fName,role:'admin'});
    showInviteCode(inviteCode);
  }catch(e){console.error('createFamily error:',e);toast('×©×’×™××” ×‘×™×¦×™×¨×ª ××©×¤×—×”: '+e.message)}
}

async function migrateLocalToFirebase(){
  loadDataLocal();
  await createNewFamily();
}

function showInviteCode(code){
  document.getElementById('familyContent').innerHTML=`
    <div style="font-size:3rem;margin-bottom:12px">ğŸ‰</div>
    <div class="login-title">×”××©×¤×—×” × ×•×¦×¨×”!</div>
    <div class="login-subtitle">×©×œ×—×• ××ª ×”×§×•×“ ×”×‘× ×›×“×™ ×œ×”×–××™×Ÿ ×œ××©×ª×ª×¤×™× ×œ×ª×§×¦×™×‘</div>
    <div class="invite-code-display">${code}</div>
    <p style="font-size:.82rem;color:var(--text-secondary)">×”×§×•×“ ×—×“-×¤×¢××™ ×•×ª×§×£ ×œ-72 ×©×¢×•×ª. ×©××¨×• ××•×ª×•!</p>
    <button class="modal-btn primary" style="margin-top:16px" onclick="finishFamilySetup()">×”××©×š ×œ××¤×œ×™×§×¦×™×” â†’</button>`;
}

function showJoinFamily(){
  document.getElementById('familyContent').innerHTML=`
    <div style="font-size:3rem;margin-bottom:12px">ğŸ”—</div>
    <div class="login-title">×”×¦×˜×¨×¤×•×ª ×œ××©×¤×—×”</div>
    <div class="login-subtitle">×”×›× ×™×¡×• ××ª ×§×•×“ ×”×”×–×× ×” ×©×§×™×‘×œ×ª×</div>
    <div class="modal-field"><input class="modal-input ltr" id="joinCode" placeholder="XXXXXXXX" maxlength="8" style="text-align:center;font-size:1.5rem;letter-spacing:4px;font-weight:700;text-transform:uppercase"></div>
    <div id="joinStatus" style="margin-top:8px;font-size:.82rem;color:var(--danger)"></div>
    <button class="modal-btn primary" style="margin-top:12px" onclick="joinWithCode()">×”×¦×˜×¨×£ â†’</button>`;
}

async function joinWithCode(){
  const code=(document.getElementById('joinCode').value||'').trim().toUpperCase();
  if(code.length<6||code.length>8){document.getElementById('joinStatus').textContent='×”×§×•×“ ×—×™×™×‘ ×œ×”×™×•×ª 6-8 ×ª×•×•×™×';return}
  try{
    const snap=await fbDb.ref('invites/'+code).once('value');
    if(!snap.exists()){document.getElementById('joinStatus').textContent='×§×•×“ ×œ× × ××¦×. ×‘×“×§×• ×©×”×•×¢×ª×§ × ×›×•×Ÿ';return}
    const inv=resolveInvite(snap.val());
    if(inv.expired){await fbDb.ref('invites/'+code).remove();document.getElementById('joinStatus').textContent='×§×•×“ ×”×”×–×× ×” ×¤×’ ×ª×•×§×£ (72 ×©×¢×•×ª). ×‘×§×©×• ×§×•×“ ×—×“×©';return}
    fbFamilyId=inv.familyId;
    // Get family name
    let familyName='×ª×§×¦×™×‘';
    try{const ms=await fbDb.ref('families/'+fbFamilyId+'/meta/name').once('value');if(ms.exists())familyName=ms.val();}catch(e){}
    // Add as member with slot 2
    await fbDb.ref('families/'+fbFamilyId+'/members/'+fbUser.uid).set({
      email:fbUser.email,displayName:fbUser.displayName||'',photoURL:fbUser.photoURL||'',
      partnerSlot:2,online:true,lastSeen:firebase.database.ServerValue.TIMESTAMP
    });
    // Add to user's families list
    await fbDb.ref('userFamilies/'+fbUser.uid+'/families/'+fbFamilyId).set({name:familyName,role:'member',joinedAt:Date.now()});
    await fbDb.ref('userFamilies/'+fbUser.uid+'/activeFamily').set(fbFamilyId);
    await fbDb.ref('invites/'+code).remove();
    userFamilies.push({familyId:fbFamilyId,name:familyName,role:'member'});
    toast('×”×¦×˜×¨×¤×ª× ×œ××©×¤×—×”!');
    finishFamilySetup();
  }catch(e){document.getElementById('joinStatus').textContent='×©×’×™××”: '+e.message}
}

async function finishFamilySetup(){
  document.getElementById('familyOverlay').classList.add('hidden');
  await connectToFamily(fbFamilyId,fbUser);
}

async function connectToFamily(familyId,user){
  fbRef=fbDb.ref('families/'+familyId+'/data');
  // Update member presence
  try{
    const myRef=fbDb.ref('families/'+familyId+'/members/'+user.uid);
    await myRef.update({online:true,lastSeen:firebase.database.ServerValue.TIMESTAMP});
    myRef.child('online').onDisconnect().set(false);
    myRef.child('lastSeen').onDisconnect().set(firebase.database.ServerValue.TIMESTAMP);
  }catch(e){console.warn('Presence update failed:',e)}
  // Load data from Firebase
  try{
    const snap=await fbRef.once('value');
    if(snap.exists()){
      D=snap.val();
      ensureDataIntegrity(D);
      localStorage.setItem(SK,JSON.stringify(D));
    }else{
      loadDataLocal();
      await fbRef.set(D);
    }
  }catch(e){
    console.warn('Firebase data load failed, using local:',e);
    loadDataLocal();
  }
  // Setup listeners
  attachRealtimeListener();
  setupConnectionMonitor();
  setupPresenceListener();
  // Show user info in header
  document.getElementById('userBtn').style.display='';
  document.getElementById('shareBtn').style.display='';
  document.getElementById('userInitial').textContent=(user.displayName||'?')[0];
  // Continue to app
  if(!D.settings.setupComplete){showWizard()}else{initApp()}
}

function ensureDataIntegrity(d){
  const fresh=freshData();
  // Config
  if(!d.config)d.config=fresh.config;
  if(!d.config.partner1&&d.config.partner1!=='')d.config.partner1='';
  if(!d.config.partner2&&d.config.partner2!=='')d.config.partner2='';
  if(d.config.soloMode===undefined)d.config.soloMode=false;
  if(!d.config.pet||typeof d.config.pet!=='object')d.config.pet={name:'',enabled:false};
  if(d.config.pet.enabled===undefined)d.config.pet.enabled=false;
  if(!d.config.pet.name&&d.config.pet.name!=='')d.config.pet.name='';
  if(!Array.isArray(d.config.categories)||d.config.categories.length===0)d.config.categories=fresh.config.categories;
  if(!Array.isArray(d.config.children))d.config.children=[];
  if(!Array.isArray(d.config.incomeSources))d.config.incomeSources=[];
  if(!Array.isArray(d.config.events))d.config.events=[];
  // Ensure each category has items array
  d.config.categories.forEach(c=>{
    if(!Array.isArray(c.items))c.items=[];
    c.items.forEach(item=>{
      if(typeof item==='string'){/* handled by migration */}
    });
  });
  // Add subscriptions category if not present
  if(!d.config.categories.find(c=>c.id==='subscriptions')){
    const subCat=DEF_CATS.find(c=>c.id==='subscriptions');
    if(subCat){
      const insertIdx=d.config.categories.findIndex(c=>c.id==='pet'||c.id==='children'||c.id==='unexpected');
      const newCat={id:subCat.id,name:subCat.name,icon:subCat.icon,order:insertIdx>=0?insertIdx:d.config.categories.length,items:subCat.items.map(n=>({name:n,isDefault:true}))};
      if(insertIdx>=0)d.config.categories.splice(insertIdx,0,newCat);
      else d.config.categories.push(newCat);
    }
  }
  // Add events category if not present
  if(!d.config.categories.find(c=>c.id==='events')){
    const insertIdx=d.config.categories.findIndex(c=>c.id==='unexpected');
    const newCat={id:'events',name:'××™×¨×•×¢×™×',icon:'ğŸ“…',order:insertIdx>=0?insertIdx:d.config.categories.length,items:[]};
    if(insertIdx>=0)d.config.categories.splice(insertIdx,0,newCat);
    else d.config.categories.push(newCat);
  }
  // Months
  if(!d.months||typeof d.months!=='object')d.months={};
  // Ensure each month has proper structure
  Object.values(d.months).forEach(m=>{
    if(!m.expenses||typeof m.expenses!=='object')m.expenses={};
    if(!Array.isArray(m.income))m.income=[];
    if(!m.misc||typeof m.misc!=='object')m.misc={};
    if(!m.savingsContributions||typeof m.savingsContributions!=='object')m.savingsContributions={};
    // Ensure each expense category has items array and migrate planned/actual to amount
    Object.keys(m.expenses).forEach(catName=>{
      const cat=m.expenses[catName];
      if(!cat||typeof cat!=='object'){m.expenses[catName]={budget:0,items:[]};return}
      if(!Array.isArray(cat.items))cat.items=[];
      // Migrate category budget from sum of planned values if not set
      if(cat.budget===undefined){
        let budgetSum=0;
        cat.items.forEach(item=>{budgetSum+=(item.planned||0)});
        cat.budget=budgetSum;
      }
      // Migrate items from planned/actual to amount
      cat.items.forEach(item=>{
        if(item.amount===undefined){
          item.amount=item.actual||item.planned||0;
          delete item.planned;
          delete item.actual;
        }
      });
    });
  });
  // Savings
  if(!d.savings||typeof d.savings!=='object')d.savings={};
  if(!d.savings.emergency||typeof d.savings.emergency!=='object')d.savings.emergency={target:0,current:0,monthlyContribution:0};
  if(!Array.isArray(d.savings.goals))d.savings.goals=[];
  if(!Array.isArray(d.savings.childrenSavings))d.savings.childrenSavings=[];
  if(!Array.isArray(d.savings.completedGoals))d.savings.completedGoals=[];
  if(!Array.isArray(d.savings.fixedSavings))d.savings.fixedSavings=[];
  // Settings
  if(!d.settings||typeof d.settings!=='object')d.settings={};
  if(d.settings.darkMode===undefined)d.settings.darkMode=false;
  if(d.settings.setupComplete===undefined)d.settings.setupComplete=true;
  if(!d.settings.currency)d.settings.currency='â‚ª';
  if(!Array.isArray(d.settings.dismissedAlerts))d.settings.dismissedAlerts=[];
  if(d.settings.subtitle===undefined)d.settings.subtitle='';
}

// ===== FIREBASE REAL-TIME SYNC =====
function attachRealtimeListener(){
  if(!fbRef)return;
  fbRef.on('value',snap=>{
    if(!snap.exists()||skipFirebaseSync)return;
    const remote=snap.val();
    const remoteStr=JSON.stringify(remote);
    const localStr=JSON.stringify(D);
    if(remoteStr===localStr)return;
    D=remote;
    ensureDataIntegrity(D);
    localStorage.setItem(SK,JSON.stringify(D));
    refreshCurrentView();
  });
}

function refreshCurrentView(){
  const active=document.querySelector('.tab-btn.active');
  if(!active)return;
  const tab=active.getAttribute('data-tab');
  switch(tab){
    case 'budget':renderBudget();updateSummary();break;
    case 'dashboard':updateDashboard();break;
    case 'savings':renderSavings();break;
    case 'manage':renderAdmin();renderAllMonthsTable();break;
  }
}

// ===== FIREBASE PRESENCE =====
function setupConnectionMonitor(){
  if(!fbDb)return;
  fbDb.ref('.info/connected').on('value',snap=>{
    isOnline=snap.val()===true;
    const el=document.getElementById('connectionStatus');
    if(el){el.style.display='';el.textContent=isOnline?'ğŸŸ¢':'ğŸŸ¡';el.title=isOnline?'××—×•×‘×¨ ×œ×¢× ×Ÿ':'××•×¤×œ×™×™×Ÿ'}
  });
}

function setupPresenceListener(){
  if(!fbFamilyId||!fbDb)return;
  fbDb.ref('families/'+fbFamilyId+'/members').on('value',snap=>{
    const members=snap.val();if(!members)return;
    const others=Object.entries(members).filter(([uid])=>uid!==fbUser.uid);
    const el=document.getElementById('partnerStatus');
    if(el&&others.length>0){
      const[,partner]=others[0];
      const name=partner.displayName||'×©×•×ª×£/×”';
      el.textContent=partner.online?`${name} ğŸŸ¢`:`${name} âš«`;
      el.style.color=partner.online?'#86EFAC':'rgba(255,255,255,.4)';
    }
  });
}

// ===== FIREBASE USER MENU =====
function showUserMenu(){
  if(!fbUser){
    // Not logged in â€” show local mode info
    showModal(`<h3>ğŸ‘¤ ××¦×‘ ××§×•××™</h3>
      <p>××ª× ×¢×•×‘×“×™× ×‘××¦×‘ ××§×•××™ ×œ×œ× ×”×ª×—×‘×¨×•×ª.</p>
      <p style="font-size:.85rem;color:var(--text-secondary)">×›×“×™ ×œ×¡× ×›×¨×Ÿ ×•×œ×©×ª×£ ××ª ×”×ª×§×¦×™×‘, ×œ×—×¦×• ×”×ª×—×‘×¨:</p>
      <div class="modal-actions" style="margin-top:14px">
        <button class="modal-btn primary" onclick="closeModal();showLoginScreen()">ğŸ”‘ ×”×ª×—×‘×¨ ×¢× Google</button>
        <button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button>
      </div>`);
    return;
  }

  const photoUrl=fbUser.photoURL;
  const initials=(fbUser.displayName||'?').split(' ').map(w=>w[0]).join('').substring(0,2);

  let html=`<div style="text-align:center;margin-bottom:16px">
    ${photoUrl?`<img src="${photoUrl}" style="width:64px;height:64px;border-radius:50%;margin-bottom:8px;border:3px solid var(--primary)">`
    :`<div style="width:64px;height:64px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;margin:0 auto 8px">${initials}</div>`}
    <div style="font-size:1.1rem;font-weight:700">${fbUser.displayName||'××©×ª××©'}</div>
    <div style="font-size:.82rem;color:var(--text-secondary)">${fbUser.email||''}</div>
  </div>`;

  // Connection status
  html+=`<div style="background:var(--bg);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
      <span style="font-size:1rem">${isOnline?'ğŸŸ¢':'ğŸŸ¡'}</span>
      <span style="font-weight:600;font-size:.88rem">${isOnline?'××—×•×‘×¨ ×œ×¢× ×Ÿ':'××•×¤×œ×™×™×Ÿ'}</span>
    </div>`;

  if(fbFamilyId){
    html+=`<div style="font-size:.82rem;color:var(--text-secondary)">××–×”×” ××©×¤×—×”: <span dir="ltr" style="font-family:monospace">${fbFamilyId.substring(0,12)}...</span></div>`;
  }
  html+=`</div>`;

  // Partner info
  if(fbFamilyId){
    html+=`<div id="profilePartnerArea" style="background:var(--bg);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px">
      <div style="font-weight:600;font-size:.88rem;margin-bottom:6px">ğŸ‘« ×©×•×ª×£/×” ×œ×ª×§×¦×™×‘</div>
      <div style="font-size:.82rem;color:var(--text-secondary)">×˜×•×¢×Ÿ...</div>
    </div>`;
  }

  // Invite code
  html+=`<div id="profileInviteArea" style="background:var(--bg);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px">
    <div style="font-weight:600;font-size:.88rem;margin-bottom:6px">ğŸ”— ×”×–×× ×” ×œ×ª×§×¦×™×‘</div>
    <div style="font-size:.82rem;color:var(--text-secondary)">${fbFamilyId?'×˜×•×¢×Ÿ...':'×™×© ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×–××™×Ÿ ×©×•×ª×¤×™× ×œ×ª×§×¦×™×‘'}</div>
  </div>`;

  // Multi-family area
  if(userFamilies.length>0){
    const activeFam=userFamilies.find(f=>f.familyId===fbFamilyId);
    html+=`<div style="background:var(--bg);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px">
      <div style="font-weight:600;font-size:.88rem;margin-bottom:8px">ğŸ“ ×ª×§×¦×™×‘ ×¤×¢×™×œ</div>
      <div style="font-size:.9rem;font-weight:600;color:var(--primary)">${activeFam?.name||'×ª×§×¦×™×‘'}</div>
      <div style="font-size:.72rem;color:var(--text-secondary)">${userFamilies.length} ×ª×§×¦×™×‘×™× ×¡×”"×›</div>
      <button class="btn-sm primary" style="margin-top:8px" onclick="closeModal();showFamilyManager()">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ × ×™×”×•×œ ×ª×§×¦×™×‘×™×</button>
    </div>`;
  }

  html+=`<div class="modal-actions" style="margin-top:14px">
    <button class="modal-btn danger" onclick="signOut()">ğŸšª ×”×ª× ×ª×§</button>
    <button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button>
  </div>`;
  showModal(html);

  // Load partner info async
  if(fbFamilyId){
    fbDb.ref('families/'+fbFamilyId+'/members').once('value').then(snap=>{
      const members=snap.val();if(!members)return;
      const others=Object.entries(members).filter(([uid])=>uid!==fbUser.uid);
      const area=document.getElementById('profilePartnerArea');
      if(!area)return;
      if(others.length>0){
        const[,p]=others[0];
        area.innerHTML=`<div style="display:flex;align-items:center;gap:10px">
          ${p.photoURL?`<img src="${p.photoURL}" style="width:36px;height:36px;border-radius:50%">`
          :`<div style="width:36px;height:36px;border-radius:50%;background:var(--primary-bg);color:var(--primary);display:flex;align-items:center;justify-content:center;font-weight:700">${(p.displayName||'?')[0]}</div>`}
          <div><div style="font-weight:600;font-size:.88rem">${p.displayName||'×©×•×ª×£/×”'}</div>
          <div style="font-size:.75rem;color:var(--text-secondary)">${p.email||''}</div>
          <div style="font-size:.72rem">${p.online?'ğŸŸ¢ ××—×•×‘×¨/×ª ×›×¢×ª':'âš« ×œ× ××—×•×‘×¨/×ª'}</div></div>
        </div>`;
      }else{
        area.innerHTML=`<div style="font-size:.85rem;color:var(--text-secondary)">×¢×“×™×™×Ÿ ×œ× ×”×¦×˜×¨×¤×• ×©×•×ª×¤×™×. ×©×œ×—×• ×§×•×“ ×”×–×× ×”!</div>`;
      }
    });

    // Load invite code (new format: object with familyId + createdAt)
    fbDb.ref('invites').orderByChild('familyId').equalTo(fbFamilyId).once('value').then(async snap=>{
      const area=document.getElementById('profileInviteArea');
      if(!area)return;
      if(snap.exists()){
        const entries=snap.val();
        const code=Object.keys(entries)[0];
        const inv=resolveInvite(entries[code]);
        if(inv.expired){
          await fbDb.ref('invites/'+code).remove();
          area.innerHTML=`<div style="font-weight:600;font-size:.88rem;margin-bottom:6px">ğŸ”— ×”×–×× ×” ×œ×ª×§×¦×™×‘</div>
            <div style="font-size:.78rem;color:var(--text-secondary);margin-bottom:8px">×§×•×“ ×§×•×“× ×¤×’ ×ª×•×§×£</div>
            <button class="btn-sm primary" onclick="generateNewInvite()">×¦×•×¨ ×§×•×“ ×”×–×× ×” ×—×“×©</button>`;
        }else{
          area.innerHTML=renderInviteDisplay(code,entries[code].createdAt);
        }
      }else{
        // Fallback: check old format (plain string value)
        const oldSnap=await fbDb.ref('invites').orderByValue().equalTo(fbFamilyId).once('value');
        if(oldSnap.exists()){
          const code=Object.keys(oldSnap.val())[0];
          area.innerHTML=renderInviteDisplay(code);
        }else{
          area.innerHTML=`<div style="font-weight:600;font-size:.88rem;margin-bottom:6px">ğŸ”— ×”×–×× ×” ×œ×ª×§×¦×™×‘</div>
            <button class="btn-sm primary" onclick="generateNewInvite()">×¦×•×¨ ×§×•×“ ×”×–×× ×” ×—×“×©</button>`;
        }
      }
    }).catch(e=>{
      console.error('Invite load error:',e);
      const area=document.getElementById('profileInviteArea');
      if(area)area.innerHTML=`<div style="font-weight:600;font-size:.88rem;margin-bottom:6px">ğŸ”— ×”×–×× ×” ×œ×ª×§×¦×™×‘</div>
        <button class="btn-sm primary" onclick="generateNewInvite()">×¦×•×¨ ×§×•×“ ×”×–×× ×” ×—×“×©</button>`;
    });
  }
}

async function showShareModal(){
  if(!fbUser||!fbDb||!fbFamilyId){
    showModal(`<div style="text-align:center;padding:10px">
      <div style="font-size:2rem;margin-bottom:8px">ğŸ”—</div>
      <h3>×©×™×ª×•×£ ×”×ª×§×¦×™×‘</h3>
      <p style="font-size:.85rem;color:var(--text-secondary);margin:10px 0">×›×“×™ ×œ×©×ª×£ ×™×© ×œ×”×ª×—×‘×¨ ×¢× Google ×•×œ×”×’×“×™×¨ Firebase</p>
      <div class="modal-actions"><button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button></div>
    </div>`);
    return;
  }
  showModal(`<div style="text-align:center;padding:10px">
    <div style="font-size:2rem;margin-bottom:8px">ğŸ”—</div>
    <h3>×©×™×ª×•×£ ×”×ª×§×¦×™×‘</h3>
    <p style="font-size:.85rem;color:var(--text-secondary);margin:8px 0">×©×œ×—×• ×§×•×“ ×”×–×× ×” ×›×“×™ ×©××—×¨×™× ×™×•×›×œ×• ×œ×”×¦×˜×¨×£ ×œ×ª×§×¦×™×‘</p>
    <div id="shareInviteArea" style="margin:14px 0"><div style="font-size:.82rem;color:var(--text-light)">×˜×•×¢×Ÿ...</div></div>
    <div id="sharePartnerArea" style="margin:10px 0"></div>
    <div class="modal-actions"><button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button></div>
  </div>`);
  // Load invite code
  try{
    let snap=await fbDb.ref('invites').orderByChild('familyId').equalTo(fbFamilyId).once('value');
    // Fallback to old format
    if(!snap.exists())snap=await fbDb.ref('invites').orderByValue().equalTo(fbFamilyId).once('value');
    const area=document.getElementById('shareInviteArea');
    if(!area)return;
    if(snap.exists()){
      const entries=snap.val();
      const code=Object.keys(entries)[0];
      const inv=resolveInvite(entries[code]);
      if(inv.expired){
        await fbDb.ref('invites/'+code).remove();
        area.innerHTML=`<div style="font-size:.78rem;color:var(--text-secondary);margin-bottom:8px">×§×•×“ ×§×•×“× ×¤×’ ×ª×•×§×£</div><button class="modal-btn primary" onclick="generateShareInvite()">ğŸ”— ×¦×•×¨ ×§×•×“ ×”×–×× ×” ×—×“×©</button>`;
      }else{
        area.innerHTML=renderInviteDisplay(code,entries[code]?.createdAt);
      }
    }else{
      area.innerHTML=`<button class="modal-btn primary" onclick="generateShareInvite()">ğŸ”— ×¦×•×¨ ×§×•×“ ×”×–×× ×”</button>`;
    }
  }catch(e){const a=document.getElementById('shareInviteArea');if(a)a.innerHTML='<span style="color:var(--danger);font-size:.82rem">×©×’×™××” ×‘×˜×¢×™× ×ª ×§×•×“</span>'}
  // Load partner info
  try{
    const snap=await fbDb.ref('families/'+fbFamilyId+'/members').once('value');
    const members=snap.val()||{};
    const area=document.getElementById('sharePartnerArea');
    if(!area)return;
    const others=Object.entries(members).filter(([uid])=>uid!==fbUser.uid);
    if(others.length>0){
      area.innerHTML=others.map(([,m])=>`<div style="display:flex;align-items:center;gap:8px;justify-content:center;padding:8px;background:var(--bg);border-radius:var(--radius-sm)">
        ${m.photoURL?`<img src="${m.photoURL}" style="width:28px;height:28px;border-radius:50%">`:`<div style="width:28px;height:28px;border-radius:50%;background:var(--primary-bg);color:var(--primary);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700">${(m.displayName||'?')[0]}</div>`}
        <span style="font-weight:600;font-size:.85rem">${esc(m.displayName||'')}</span>
        <span style="font-size:.72rem;color:${m.online?'var(--success)':'var(--text-light)'}">${m.online?'ğŸŸ¢ ××—×•×‘×¨/×ª':'âš« ×œ× ××—×•×‘×¨/×ª'}</span>
      </div>`).join('');
    }else{
      area.innerHTML='<p style="font-size:.8rem;color:var(--text-light)">×˜×¨× ×”×¦×˜×¨×¤×• ×©×•×ª×¤×™× ×œ×ª×§×¦×™×‘</p>';
    }
  }catch(e){}
}

async function generateShareInvite(){
  const code=generateInviteCode();
  await fbDb.ref('invites/'+code).set({familyId:fbFamilyId,createdAt:Date.now()});
  const area=document.getElementById('shareInviteArea');
  if(area)area.innerHTML=renderInviteDisplay(code);
  toast('×§×•×“ ×”×–×× ×” × ×•×¦×¨!');
}

async function generateNewInvite(){
  const code=generateInviteCode();
  await fbDb.ref('invites/'+code).set({familyId:fbFamilyId,createdAt:Date.now()});
  const area=document.getElementById('profileInviteArea');
  if(area)area.innerHTML=renderInviteDisplay(code);
  toast('×§×•×“ ×”×–×× ×”: '+code);
}
function renderInviteDisplay(code,createdAt){
  const link=window.location.href.split('?')[0]+'?invite='+code;
  let expiryNote='';
  if(createdAt){
    const remaining=INVITE_EXPIRY_MS-(Date.now()-createdAt);
    if(remaining>0){
      const hrs=Math.floor(remaining/3600000);
      expiryNote=`<div style="font-size:.72rem;color:var(--text-secondary);text-align:center;margin-top:4px">â±ï¸ ×¤×’ ×ª×•×§×£ ×‘×¢×•×“ ${hrs} ×©×¢×•×ª</div>`;
    }
  }
  return `<div style="font-weight:600;font-size:.88rem;margin-bottom:6px">ğŸ”— ×§×•×“ ×”×–×× ×”</div>
    <div class="invite-code-display" style="font-size:1.3rem;padding:8px">${code}</div>
    ${expiryNote}
    <div style="display:flex;gap:6px;margin-top:8px;justify-content:center;flex-wrap:wrap">
      <button class="btn-sm primary" onclick="navigator.clipboard.writeText('${link}');toast('×”×§×™×©×•×¨ ×”×•×¢×ª×§!')">ğŸ“‹ ×”×¢×ª×§ ×§×™×©×•×¨ ×™×©×™×¨</button>
      <button class="btn-sm" onclick="navigator.clipboard.writeText('${code}');toast('×”×§×•×“ ×”×•×¢×ª×§!')">ğŸ“‹ ×”×¢×ª×§ ×§×•×“</button>
    </div>
    <div style="font-size:.68rem;color:var(--text-light);text-align:center;margin-top:6px;word-break:break-all">${esc(link)}</div>`;
}

function signOut(){
  if(fbFamilyId&&fbUser&&fbDb){
    fbDb.ref('families/'+fbFamilyId+'/members/'+fbUser.uid).update({online:false,lastSeen:firebase.database.ServerValue.TIMESTAMP});
  }
  if(fbRef)fbRef.off();
  if(fbAuth)fbAuth.signOut();
  closeModal();
  fbUser=null;fbFamilyId=null;fbRef=null;userFamilies=[];
  document.getElementById('userBtn').style.display='none';
  document.getElementById('shareBtn').style.display='none';
  document.getElementById('partnerStatus').textContent='';
  document.getElementById('connectionStatus').style.display='none';
}

// ===== MULTI-FAMILY MANAGEMENT =====
async function switchFamily(familyId){
  if(familyId===fbFamilyId)return;
  // Disconnect from current
  if(fbRef)fbRef.off();
  if(fbFamilyId&&fbUser&&fbDb){
    try{fbDb.ref('families/'+fbFamilyId+'/members/'+fbUser.uid).update({online:false})}catch(e){}
  }
  // Update active family
  fbFamilyId=familyId;
  await fbDb.ref('userFamilies/'+fbUser.uid+'/activeFamily').set(familyId);
  // Connect to new family
  await connectToFamily(familyId,fbUser);
  closeModal();
  toast('×¢×‘×¨×ª ×œ×ª×§×¦×™×‘: '+(userFamilies.find(f=>f.familyId===familyId)?.name||''));
}

function showFamilyManager(){
  if(!fbUser){toast('×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”');return}
  let html=`<div style="text-align:center;margin-bottom:16px">
    <div style="font-size:2rem;margin-bottom:6px">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</div>
    <div style="font-size:1.1rem;font-weight:700">× ×™×”×•×œ ×ª×§×¦×™×‘×™×</div>
    <div style="font-size:.82rem;color:var(--text-secondary)">×™×¦×™×¨×”, ××¢×‘×¨ ×•×”×–×× ×” ×œ×ª×§×¦×™×‘×™× ×©×•× ×™×</div>
  </div>`;

  // Family list
  if(userFamilies.length>0){
    html+=`<div style="margin-bottom:14px">`;
    for(const fam of userFamilies){
      const isActive=fam.familyId===fbFamilyId;
      html+=`<div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:${isActive?'var(--primary-bg)':'var(--bg)'};border-radius:var(--radius-sm);margin-bottom:6px;border:${isActive?'2px solid var(--primary)':'1px solid var(--border)'}">
        <div style="flex:1">
          <div style="font-weight:600;font-size:.9rem">${fam.name||'×ª×§×¦×™×‘'}</div>
          <div style="font-size:.72rem;color:var(--text-secondary)">${fam.role==='admin'?'×× ×”×œ/×ª':'×—×‘×¨/×”'}${isActive?' â€” ×¤×¢×™×œ':''}</div>
        </div>
        ${isActive?'<span style="color:var(--primary);font-weight:700;font-size:.82rem">âœ“ ×¤×¢×™×œ</span>'
        :`<button class="btn-sm primary" onclick="switchFamily('${fam.familyId}')">××¢×‘×¨</button>`}
        <button class="btn-sm" style="font-size:.75rem" onclick="renameBudget('${fam.familyId}')" title="×©× ×” ×©×">âœï¸</button>
        ${fam.role==='admin'?`<button class="btn-sm" style="font-size:.75rem" onclick="showFamilySettings('${fam.familyId}')">âš™ï¸</button>`:''}
        <button class="btn-sm" style="font-size:.7rem;color:var(--danger);border-color:var(--danger)" onclick="confirmLeaveFamily('${fam.familyId}','${esc(fam.name||'×ª×§×¦×™×‘')}')">×¢×–×™×‘×”</button>
      </div>`;
    }
    html+=`</div>`;
  }

  // Actions
  html+=`<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:14px">
    <button class="modal-btn primary" onclick="closeModal();showCreateBudgetModal()">â• ×¦×•×¨ ×ª×§×¦×™×‘ ×—×“×©</button>
    <button class="modal-btn" onclick="closeModal();showJoinBudgetModal()">ğŸ”— ×”×¦×˜×¨×£ ×œ×ª×§×¦×™×‘ ×§×™×™×</button>
  </div>`;

  html+=`<div class="modal-actions"><button class="modal-btn cancel" onclick="closeModal()">×¡×’×•×¨</button></div>`;
  showModal(html);
}

function renameBudget(familyId){
  const fam=userFamilies.find(f=>f.familyId===familyId);
  showModal(`<h3 style="margin-bottom:12px">âœï¸ ×©×™× ×•×™ ×©× ×”×ª×§×¦×™×‘</h3>
    <div class="modal-field"><label class="modal-label">×©× ×—×“×©</label><input class="modal-input" id="renameBudgetInput" value="${esc(fam?.name||'')}" dir="rtl"></div>
    <div class="modal-actions" style="margin-top:14px">
      <button class="modal-btn primary" onclick="doRenameBudget('${familyId}')">×©××•×¨</button>
      <button class="modal-btn cancel" onclick="closeModal();showFamilyManager()">×‘×™×˜×•×œ</button>
    </div>`);
  setTimeout(()=>{const i=document.getElementById('renameBudgetInput');if(i){i.focus();i.select()}},250);
}

async function doRenameBudget(familyId){
  const name=(document.getElementById('renameBudgetInput')?.value||'').trim();
  if(!name){toast('× × ×œ×”×–×™×Ÿ ×©×');return}
  const fam=userFamilies.find(f=>f.familyId===familyId);
  if(fam)fam.name=name;
  try{
    await fbDb.ref('userFamilies/'+fbUser.uid+'/families/'+familyId+'/name').set(name);
    if(fam?.role==='admin'){
      await fbDb.ref('families/'+familyId+'/meta/name').set(name);
    }
  }catch(e){console.error('Rename error:',e)}
  closeModal();
  toast('×©× ×”×ª×§×¦×™×‘ ×¢×•×“×›×Ÿ: '+name);
  showFamilyManager();
  initApp();
}

function showCreateBudgetModal(){
  showModal(`<h3 style="margin-bottom:12px">â• ×ª×§×¦×™×‘ ×—×“×©</h3>
    <div class="modal-field"><label class="modal-label">×©× ×”×ª×§×¦×™×‘</label><input class="modal-input" id="newBudgetName" placeholder="×œ××©×œ: ×”××©×¤×—×” ×©×œ ×›×”×Ÿ" dir="rtl"></div>
    <div class="modal-actions" style="margin-top:14px">
      <button class="modal-btn primary" onclick="doCreateNewBudget()">×¦×•×¨ ×ª×§×¦×™×‘</button>
      <button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`);
}

async function doCreateNewBudget(){
  const name=(document.getElementById('newBudgetName')?.value||'').trim();
  if(!name){toast('× × ×œ×”×–×™×Ÿ ×©× ×œ×ª×§×¦×™×‘');return}
  closeModal();
  // Disconnect from current family
  if(fbRef)fbRef.off();
  if(fbFamilyId&&fbUser&&fbDb){
    try{fbDb.ref('families/'+fbFamilyId+'/members/'+fbUser.uid).update({online:false})}catch(e){}
  }
  D=freshData();
  await createNewFamily(name,false);
}

function showJoinBudgetModal(){
  showModal(`<h3 style="margin-bottom:12px">ğŸ”— ×”×¦×˜×¨×¤×•×ª ×œ×ª×§×¦×™×‘</h3>
    <div class="modal-field"><label class="modal-label">×§×•×“ ×”×–×× ×”</label><input class="modal-input ltr" id="joinBudgetCode" placeholder="XXXXXXXX" maxlength="8" style="text-align:center;font-size:1.3rem;letter-spacing:3px;font-weight:700;text-transform:uppercase"></div>
    <div id="joinBudgetStatus" style="margin-top:6px;font-size:.82rem;color:var(--danger)"></div>
    <div class="modal-actions" style="margin-top:14px">
      <button class="modal-btn primary" onclick="doJoinBudget()">×”×¦×˜×¨×£</button>
      <button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`);
}

async function doJoinBudget(){
  const code=(document.getElementById('joinBudgetCode')?.value||'').trim().toUpperCase();
  if(code.length<6||code.length>8){document.getElementById('joinBudgetStatus').textContent='×”×§×•×“ ×—×™×™×‘ ×œ×”×™×•×ª 6-8 ×ª×•×•×™×';return}
  try{
    const snap=await fbDb.ref('invites/'+code).once('value');
    if(!snap.exists()){document.getElementById('joinBudgetStatus').textContent='×§×•×“ ×œ× × ××¦×';return}
    const inv=resolveInvite(snap.val());
    if(inv.expired){await fbDb.ref('invites/'+code).remove();document.getElementById('joinBudgetStatus').textContent='×§×•×“ ×”×”×–×× ×” ×¤×’ ×ª×•×§×£ (72 ×©×¢×•×ª). ×‘×§×©×• ×§×•×“ ×—×“×©';return}
    const targetFamilyId=inv.familyId;
    // Check not already a member
    if(userFamilies.some(f=>f.familyId===targetFamilyId)){document.getElementById('joinBudgetStatus').textContent='×›×‘×¨ ×—×‘×¨/×” ×‘×ª×§×¦×™×‘ ×–×”';return}
    // Get family name
    let familyName='×ª×§×¦×™×‘';
    try{const ms=await fbDb.ref('families/'+targetFamilyId+'/meta/name').once('value');if(ms.exists())familyName=ms.val();}catch(e){}
    // Add as member
    await fbDb.ref('families/'+targetFamilyId+'/members/'+fbUser.uid).set({
      email:fbUser.email,displayName:fbUser.displayName||'',photoURL:fbUser.photoURL||'',
      partnerSlot:2,online:true,lastSeen:firebase.database.ServerValue.TIMESTAMP
    });
    await fbDb.ref('userFamilies/'+fbUser.uid+'/families/'+targetFamilyId).set({name:familyName,role:'member',joinedAt:Date.now()});
    await fbDb.ref('invites/'+code).remove();
    userFamilies.push({familyId:targetFamilyId,name:familyName,role:'member'});
    closeModal();
    toast('×”×¦×˜×¨×¤×ª ×œ: '+familyName);
    await switchFamily(targetFamilyId);
  }catch(e){document.getElementById('joinBudgetStatus').textContent='×©×’×™××”: '+e.message}
}

async function showFamilySettings(familyId){
  const fam=userFamilies.find(f=>f.familyId===familyId);
  if(!fam)return;
  closeModal();
  // Load members
  let membersHtml='<div style="font-size:.85rem;color:var(--text-secondary)">×˜×•×¢×Ÿ ×—×‘×¨×™×...</div>';
  let inviteHtml='';

  showModal(`<h3 style="margin-bottom:12px">âš™ï¸ ×”×’×“×¨×•×ª: ${fam.name||'×ª×§×¦×™×‘'}</h3>
    <div class="modal-field"><label class="modal-label">×©× ×”×ª×§×¦×™×‘</label><input class="modal-input" id="editFamilyName" value="${fam.name||''}" dir="rtl"></div>
    <div id="familyMembersArea" style="margin-top:12px;background:var(--bg);border-radius:var(--radius-sm);padding:12px">${membersHtml}</div>
    <div id="familyInviteArea" style="margin-top:10px"></div>
    <div class="modal-actions" style="margin-top:14px">
      <button class="modal-btn primary" onclick="saveFamilySettings('${familyId}')">ğŸ’¾ ×©××•×¨</button>
      <button class="modal-btn cancel" onclick="closeModal();showFamilyManager()">×—×–×¨×”</button>
    </div>`);

  // Load members async
  try{
    const snap=await fbDb.ref('families/'+familyId+'/members').once('value');
    const members=snap.val()||{};
    const area=document.getElementById('familyMembersArea');
    if(!area)return;
    let mhtml='<div style="font-weight:600;font-size:.88rem;margin-bottom:8px">ğŸ‘¥ ×—×‘×¨×™×</div>';
    Object.entries(members).forEach(([uid,m])=>{
      const isMe=uid===fbUser.uid;
      mhtml+=`<div style="display:flex;align-items:center;gap:8px;padding:6px 0;${!isMe?'':''}">
        ${m.photoURL?`<img src="${m.photoURL}" style="width:28px;height:28px;border-radius:50%">`
        :`<div style="width:28px;height:28px;border-radius:50%;background:var(--primary-bg);color:var(--primary);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700">${(m.displayName||'?')[0]}</div>`}
        <div style="flex:1"><div style="font-size:.85rem;font-weight:500">${m.displayName||''}${isMe?' (××ª/×”)':''}</div><div style="font-size:.72rem;color:var(--text-secondary)">${m.email||''}</div></div>
        <span style="font-size:.7rem;color:${m.online?'var(--success)':'var(--text-light)'}">${m.online?'ğŸŸ¢ ××—×•×‘×¨/×ª':'âš« ×œ× ××—×•×‘×¨/×ª'}</span>
      </div>`;
    });
    area.innerHTML=mhtml;
  }catch(e){console.warn('Load members error:',e)}

  // Invite code
  try{
    let snap=await fbDb.ref('invites').orderByChild('familyId').equalTo(familyId).once('value');
    if(!snap.exists())snap=await fbDb.ref('invites').orderByValue().equalTo(familyId).once('value');
    const area=document.getElementById('familyInviteArea');
    if(!area)return;
    if(snap.exists()){
      const entries=snap.val();
      const code=Object.keys(entries)[0];
      const inv=resolveInvite(entries[code]);
      if(inv.expired){
        await fbDb.ref('invites/'+code).remove();
        area.innerHTML=`<div style="font-size:.78rem;color:var(--text-secondary);margin-bottom:6px">×§×•×“ ×§×•×“× ×¤×’ ×ª×•×§×£</div><button class="modal-btn" style="width:100%" onclick="generateInviteForFamily('${familyId}')">ğŸ”— ×¦×•×¨ ×§×•×“ ×”×–×× ×” ×—×“×©</button>`;
      }else{
        let expiryNote='';
        if(entries[code]?.createdAt){const hrs=Math.floor((INVITE_EXPIRY_MS-(Date.now()-entries[code].createdAt))/3600000);if(hrs>0)expiryNote=`<div style="font-size:.68rem;color:var(--text-secondary)">â±ï¸ ×¤×’ ×ª×•×§×£ ×‘×¢×•×“ ${hrs} ×©×¢×•×ª</div>`;}
        area.innerHTML=`<div style="background:var(--bg);border-radius:var(--radius-sm);padding:10px;text-align:center">
          <div style="font-size:.82rem;font-weight:600;margin-bottom:4px">ğŸ”— ×§×•×“ ×”×–×× ×”</div>
          <div style="font-family:monospace;font-size:1.3rem;font-weight:700;letter-spacing:3px;color:var(--primary)">${code}</div>
          ${expiryNote}
        </div>`;
      }
    }else{
      area.innerHTML=`<button class="modal-btn" style="width:100%" onclick="generateInviteForFamily('${familyId}')">ğŸ”— ×¦×•×¨ ×§×•×“ ×”×–×× ×” ×—×“×©</button>`;
    }
  }catch(e){}
}

async function saveFamilySettings(familyId){
  const newName=(document.getElementById('editFamilyName')?.value||'').trim();
  if(!newName){toast('× × ×œ×”×–×™×Ÿ ×©×');return}
  try{
    await fbDb.ref('families/'+familyId+'/meta/name').set(newName);
    await fbDb.ref('userFamilies/'+fbUser.uid+'/families/'+familyId+'/name').set(newName);
    const f=userFamilies.find(f=>f.familyId===familyId);
    if(f)f.name=newName;
    toast('×”×©× ×¢×•×“×›×Ÿ');
    closeModal();
    showFamilyManager();
  }catch(e){toast('×©×’×™××”: '+e.message)}
}

async function generateInviteForFamily(familyId){
  const code=generateInviteCode();
  await fbDb.ref('invites/'+code).set({familyId,createdAt:Date.now()});
  toast('×§×•×“ ×”×–×× ×”: '+code);
  showFamilySettings(familyId);
}

function confirmLeaveFamily(familyId,familyName){
  const isActive=familyId===fbFamilyId;
  const otherFamilies=userFamilies.filter(f=>f.familyId!==familyId);
  showModal(`<div style="text-align:center">
    <div style="font-size:2rem;margin-bottom:8px">ğŸ‘‹</div>
    <h3 style="margin-bottom:8px">×¢×–×™×‘×ª ×ª×§×¦×™×‘</h3>
    <div style="font-size:.88rem;margin-bottom:6px">×‘×˜×•×—/×” ×©×‘×¨×¦×•× ×š ×œ×¢×–×•×‘ ××ª <strong>${familyName}</strong>?</div>
    <div style="font-size:.78rem;color:var(--text-secondary);margin-bottom:14px">×”× ×ª×•× ×™× ×œ× ×™×™××—×§×• â€” ×ª×•×›×œ/×™ ×œ×”×¦×˜×¨×£ ××—×“×© ×¢× ×§×•×“ ×”×–×× ×” ×—×“×©.</div>
    ${isActive&&otherFamilies.length===0?'<div style="font-size:.78rem;color:var(--warning);margin-bottom:10px;font-weight:600">âš ï¸ ××™×Ÿ ×ª×§×¦×™×‘×™× ××—×¨×™× â€” ×ª×•×¢×‘×¨/×™ ×œ××¡×š ×™×¦×™×¨×ª ×ª×§×¦×™×‘ ×—×“×©</div>':''}
    <div class="modal-actions">
      <button class="modal-btn" style="background:var(--danger);color:#fff" onclick="leaveFamily('${familyId}')">×¢×–×•×‘/×™</button>
      <button class="modal-btn cancel" onclick="closeModal();showFamilyManager()">×‘×™×˜×•×œ</button>
    </div>
  </div>`);
}

async function leaveFamily(familyId){
  if(!fbUser||!fbDb){toast('×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×”');return}
  try{
    const isActive=familyId===fbFamilyId;
    // Disconnect listeners if leaving active family
    if(isActive&&fbRef){fbRef.off();fbRef=null}
    // Mark offline and remove from family members
    await fbDb.ref('families/'+familyId+'/members/'+fbUser.uid).remove();
    // Remove from user's family list
    await fbDb.ref('userFamilies/'+fbUser.uid+'/families/'+familyId).remove();
    // Update local state
    userFamilies=userFamilies.filter(f=>f.familyId!==familyId);
    // Handle active family change
    if(isActive){
      fbFamilyId=null;
      if(userFamilies.length>0){
        // Switch to first remaining family
        closeModal();
        toast('×¢×–×‘×ª ××ª ×”×ª×§×¦×™×‘');
        await switchFamily(userFamilies[0].familyId);
      }else{
        // No families left â€” clear active and show options
        await fbDb.ref('userFamilies/'+fbUser.uid+'/activeFamily').remove();
        D=freshData();
        closeModal();
        toast('×¢×–×‘×ª ××ª ×”×ª×§×¦×™×‘');
        showFamilyManager();
      }
    }else{
      closeModal();
      toast('×¢×–×‘×ª ××ª ×”×ª×§×¦×™×‘');
      showFamilyManager();
    }
  }catch(e){toast('×©×’×™××”: '+e.message);console.error('Leave family error:',e)}
}

// ===== EVENTS MANAGEMENT =====
function addEvent(){
  const p1=D.config.partner1||'×©×•×ª×£ 1',p2=D.config.partner2||'×©×•×ª×£ 2';
  const monthOpts=HM.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');
  showModal(`<h3 style="margin-bottom:12px">ğŸ“… ×”×•×¡×£ ××™×¨×•×¢ ×©× ×ª×™</h3>
    <div class="modal-field"><label class="modal-label">×©× ×”××™×¨×•×¢</label><input class="modal-input" id="eventName" placeholder="×œ×“×•×’××”: ×™×•× ×”×•×œ×“×ª ×©×—×¨" dir="rtl"></div>
    <div class="modal-field"><label class="modal-label">××™××•×’'×™</label><input class="modal-input" id="eventEmoji" value="ğŸ‚" style="width:60px;text-align:center"></div>
    <div style="display:flex;gap:10px">
      <div class="modal-field" style="flex:1"><label class="modal-label">×—×•×“×©</label><select class="modal-input" id="eventMonth">${monthOpts}</select></div>
      <div class="modal-field" style="flex:1"><label class="modal-label">×™×•× (××•×¤×¦×™×•× ×œ×™)</label><input class="modal-input ltr" type="number" id="eventDay" min="0" max="31" value="0" style="text-align:center"></div>
    </div>
    <div class="modal-field"><label class="modal-label">×ª×§×¦×™×‘ ××©×•×¢×¨</label><input class="modal-input ltr" type="number" id="eventBudget" min="0" value="0" style="text-align:center"></div>
    ${D.config.soloMode?'':`<div class="modal-field"><label class="modal-label">×©×™×™×š ×œ:</label>
      <select class="modal-input" id="eventOwner">${ownerSelectOpts('shared',p1,p2)}</select></div>`}
    <div class="modal-actions" style="margin-top:14px">
      <button class="modal-btn primary" onclick="confirmAddEvent()">×”×•×¡×£</button>
      <button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`);
}

function confirmAddEvent(){
  const name=(document.getElementById('eventName')?.value||'').trim();
  if(!name){toast('× × ×œ×”×–×™×Ÿ ×©× ××™×¨×•×¢');return}
  if(!D.config.events)D.config.events=[];
  D.config.events.push({
    id:uid(),name,
    emoji:(document.getElementById('eventEmoji')?.value||'').trim()||'ğŸ“…',
    month:parseInt(document.getElementById('eventMonth')?.value)||1,
    day:parseInt(document.getElementById('eventDay')?.value)||0,
    estimatedBudget:Math.max(0,parseInt(document.getElementById('eventBudget')?.value)||0),
    owner:document.getElementById('eventOwner')?.value||'shared',
    enabled:true
  });
  saveData();closeModal();renderAdmin();
  toast(`××™×¨×•×¢ "${name}" × ×•×¡×£`);
}

function editEvent(idx){
  const evt=D.config.events[idx];if(!evt)return;
  window._editEventIdx=idx;
  const p1=D.config.partner1||'×©×•×ª×£ 1',p2=D.config.partner2||'×©×•×ª×£ 2';
  const monthOpts=HM.map((m,i)=>`<option value="${i+1}"${evt.month===i+1?' selected':''}>${m}</option>`).join('');
  showModal(`<h3 style="margin-bottom:12px">âœï¸ ×¢×¨×™×›×ª ××™×¨×•×¢</h3>
    <div class="modal-field"><label class="modal-label">×©× ×”××™×¨×•×¢</label><input class="modal-input" id="eventName" value="${esc(evt.name)}" dir="rtl"></div>
    <div class="modal-field"><label class="modal-label">××™××•×’'×™</label><input class="modal-input" id="eventEmoji" value="${esc(evt.emoji)}" style="width:60px;text-align:center"></div>
    <div style="display:flex;gap:10px">
      <div class="modal-field" style="flex:1"><label class="modal-label">×—×•×“×©</label><select class="modal-input" id="eventMonth">${monthOpts}</select></div>
      <div class="modal-field" style="flex:1"><label class="modal-label">×™×•×</label><input class="modal-input ltr" type="number" id="eventDay" min="0" max="31" value="${evt.day||0}" style="text-align:center"></div>
    </div>
    <div class="modal-field"><label class="modal-label">×ª×§×¦×™×‘ ××©×•×¢×¨</label><input class="modal-input ltr" type="number" id="eventBudget" min="0" value="${evt.estimatedBudget||0}" style="text-align:center"></div>
    ${D.config.soloMode?'':`<div class="modal-field"><label class="modal-label">×©×™×™×š ×œ:</label>
      <select class="modal-input" id="eventOwner">${ownerSelectOpts(evt.owner||'shared',p1,p2)}</select></div>`}
    <div class="modal-actions" style="margin-top:14px">
      <button class="modal-btn primary" onclick="confirmEditEvent()">×¢×“×›×Ÿ</button>
      <button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`);
}

function confirmEditEvent(){
  const idx=window._editEventIdx;
  const evt=D.config.events[idx];if(!evt)return;
  const name=(document.getElementById('eventName')?.value||'').trim();
  if(!name){toast('× × ×œ×”×–×™×Ÿ ×©×');return}
  const oldMonth=evt.month;
  evt.name=name;
  evt.emoji=(document.getElementById('eventEmoji')?.value||'').trim()||'ğŸ“…';
  evt.month=parseInt(document.getElementById('eventMonth')?.value)||1;
  evt.day=parseInt(document.getElementById('eventDay')?.value)||0;
  evt.estimatedBudget=Math.max(0,parseInt(document.getElementById('eventBudget')?.value)||0);
  evt.owner=document.getElementById('eventOwner')?.value||'shared';
  // Clean up items from old month if month changed
  if(oldMonth!==evt.month){
    Object.entries(D.months).forEach(([k,md])=>{
      const [,ms]=k.split('-');
      if(parseInt(ms)===oldMonth){
        Object.values(md.expenses||{}).forEach(cat=>{
          cat.items=(cat.items||[]).filter(i=>i.eventId!==evt.id);
        });
      }
    });
  }
  // Update name/emoji in existing items
  Object.values(D.months).forEach(md=>{
    Object.values(md.expenses||{}).forEach(cat=>{
      (cat.items||[]).forEach(i=>{
        if(i.eventId===evt.id)i.name=(evt.emoji||'ğŸ“…')+' '+evt.name;
      });
    });
  });
  saveData();closeModal();renderAdmin();renderBudget();
  toast(`××™×¨×•×¢ "${name}" ×¢×•×“×›×Ÿ`);
}

function toggleEvent(idx,enabled){
  D.config.events[idx].enabled=enabled;
  saveData();renderAdmin();
}

function removeEvent(idx){
  const evt=D.config.events[idx];
  showModal(`<h3>âš ï¸ ××—×™×§×ª ××™×¨×•×¢</h3>
    <p style="font-size:.88rem">×œ××—×•×§ ××ª <strong>${esc(evt.emoji)} ${esc(evt.name)}</strong>?</p>
    <p style="font-size:.78rem;color:var(--text-secondary)">×¤×¨×™×˜×™× ×©×›×‘×¨ × ×•×¦×¨×• ×‘×—×•×“×©×™× ×§×™×™××™× ×™×™×©××¨×•.</p>
    <div class="modal-actions" style="margin-top:14px">
      <button class="modal-btn" style="background:var(--danger);color:#fff" onclick="confirmRemoveEvent(${idx})">××—×§</button>
      <button class="modal-btn cancel" onclick="closeModal()">×‘×™×˜×•×œ</button>
    </div>`);
}

function confirmRemoveEvent(idx){
  pushUndo();
  const name=D.config.events[idx].name;
  D.config.events.splice(idx,1);
  saveData();closeModal();renderAdmin();
  toast(`××™×¨×•×¢ "${name}" × ××—×§`);
}

// ===== INITIALIZATION =====
function initApp(){
  const p1=D.config.partner1,p2=D.config.partner2;
  if(D.settings.subtitle){document.getElementById('appSubtitle').textContent=D.settings.subtitle}
  else if(p1){
    let sub=D.config.soloMode?`${p1} â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×`:(p2?`${p1} ×•${p2} â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×`:`${p1} â€” × ×™×”×•×œ ×¤×™× × ×¡×™ ×—×›×`);
    // Show family name if multiple families
    if(userFamilies.length>1){
      const active=userFamilies.find(f=>f.familyId===fbFamilyId);
      if(active?.name)sub=active.name;
    }
    document.getElementById('appSubtitle').textContent=sub;
  }
  populateMonthSelects();
  renderBudget();
  updateSummary();
  applyDarkMode();
  requestNotificationPermission();
  hideLoadingScreen();
}
function hideLoadingScreen(){
  const ls=document.getElementById('loadingScreen');
  if(ls){ls.style.opacity='0';ls.style.transition='opacity .4s ease';setTimeout(()=>ls.remove(),400)}
}

function loadDataLocal(){
  try{
    const raw=localStorage.getItem(SK);
    if(raw){
      D=JSON.parse(raw);
      if(!D.config)migrateV1(D);
      ensureDataIntegrity(D);
      return;
    }
    const oldRaw=localStorage.getItem('familyBudget_ShacharRotem');
    if(oldRaw){D=JSON.parse(oldRaw);migrateV1(D);saveData();return}
  }catch(e){console.error('Load error:',e)}
  D=freshData();
}

// Auto-add inputmode to number inputs for better mobile keyboards
new MutationObserver(muts=>{
  muts.forEach(mut=>{mut.addedNodes.forEach(node=>{
    if(node.nodeType!==1)return;
    const fix=el=>{el.setAttribute('inputmode','numeric');el.setAttribute('pattern','[0-9]*')};
    if(node.matches&&node.matches('input[type="number"]:not([inputmode])'))fix(node);
    if(node.querySelectorAll)node.querySelectorAll('input[type="number"]:not([inputmode])').forEach(fix);
  })});
}).observe(document.body,{childList:true,subtree:true});

function init(){
  // Check for invite URL before anything else
  checkInviteURL();

  // Step 1: Load Firebase config
  fbConfig=loadFirebaseConfig();

  if(fbConfig&&typeof firebase!=='undefined'){
    // Initialize Firebase (handle already-initialized case)
    try{
      if(!firebase.apps.length){
        fbApp=firebase.initializeApp(fbConfig);
      }else{
        fbApp=firebase.apps[0];
      }
      fbAuth=firebase.auth();
      fbDb=firebase.database();
    }catch(e){
      console.warn('Firebase init error:',e);
      fbConfig=null;
    }
  }

  if(fbConfig&&fbAuth){
    // Set persistence to LOCAL (stay logged in across sessions)
    fbAuth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});
    // Show loading indicator (not login screen) until auth state resolves
    const loginEl=document.getElementById('loginOverlay');
    const loginStatus=document.getElementById('loginStatus');
    loginEl.classList.remove('hidden');
    if(loginStatus)loginStatus.textContent='×˜×•×¢×Ÿ...';
    // Hide Google button initially during auth check
    const googleBtn=loginEl.querySelector('.google-btn');
    if(googleBtn)googleBtn.style.display='none';
    const offlineLink=loginEl.querySelector('.offline-link');
    if(offlineLink)offlineLink.style.display='none';

    fbAuth.onAuthStateChanged(user=>{
      if(user){
        fbUser=user;
        // If pending invite from URL, handle it directly
        if(window._pendingInvite){
          hideLoginScreen();hideLoadingScreen();
          showWizard();
          setTimeout(()=>{
            showWizardJoinCode();
            setTimeout(()=>{const el=document.getElementById('wizJoinCode');if(el)el.value=window._pendingInvite;delete window._pendingInvite},200);
          },200);
          return;
        }
        if(loginStatus)loginStatus.textContent='×˜×•×¢×Ÿ × ×ª×•× ×™ ××©×¤×—×”...';
        hideLoginScreen();
        resolveFamily(user);
      }else{
        // Not logged in â€” show full login screen
        if(googleBtn)googleBtn.style.display='';
        if(offlineLink)offlineLink.style.display='';
        if(loginStatus)loginStatus.textContent='';
        const subtitle=loginEl.querySelector('.login-subtitle');
        if(subtitle)subtitle.textContent='×”×ª×—×‘×¨×• ×›×“×™ ×œ×¡× ×›×¨×Ÿ ×•×œ×©×ª×£ ××ª ×”×ª×§×¦×™×‘';
        showLoginScreen();
      }
    });
    // Handle redirect result
    fbAuth.getRedirectResult().catch(()=>{});
  }else{
    // No Firebase â€” run in local mode
    loadDataLocal();
    if(window._pendingInvite){showWizard();setTimeout(handlePendingInvite,500);return}
    if(loadTemplateFromURL()){showWizard();return}
    if(!D.settings.setupComplete){showWizard();return}
    initApp();
  }
}

document.addEventListener('DOMContentLoaded',()=>{try{init()}catch(e){console.error('Init error:',e);document.body.innerHTML='<div style="padding:40px;text-align:center;direction:rtl;font-family:sans-serif"><h2>×©×’×™××” ×‘×˜×¢×™× ×”</h2><p>'+e.message+'</p></div>'}})
</script>
</body>
</html>
